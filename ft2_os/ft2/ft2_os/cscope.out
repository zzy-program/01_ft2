cscope 15 $HOME/work/00code/study_qct8998_630_O80/ft2/ft2_os -q 0000001599 0000184152
	@common.h

17 #iâdeà
RECOVERY_COMMON_H


18 
	#RECOVERY_COMMON_H


	)

20 
	~<¡dio.h
>

21 
	~<¡d¬g.h
>

23 
	~<¡ršg
>

25 
	#STRINGIFY
(
x
è#x

	)

26 
	#EXPAND
(
x
è
	`STRINGIFY
(x)

	)

28 
şass
 
	gRecov”yUI
;

30 
Recov”yUI
* 
ui
;

31 
boŞ
 
modif›d_æash
;

34 
¡d
::
¡ršg
 
¡age
;

37 cÚ¡ * 
»asÚ
;

42 
ui_´št
(cÚ¡ * 
fÜm©
, ...);

44 
boŞ
 
is_ro_debuggabË
();

46 
boŞ
 
»boÙ
(cÚ¡ 
¡d
::
¡ršg
& 
commªd
);

	@default_device.cpp

17 
	~"deviû.h
"

18 
	~"sü“n_ui.h
"

20 
Deviû
* 
	$make_deviû
() {

21  
Ãw
 
	`Deviû
Òew 
Sü“nRecov”yUI
);

22 
	}
}

	@device.cpp

18 
	~<¡ršg.h
>

19 
	~"deviû.h
"

20 
	~"cuts/´İ”t›s.h
"

22 
	#S_ON
 "1"

	)

23 
	#S_OFF
 "0"

	)

25 cÚ¡ * 
	gMENU_ITEMS
[] = {

37 
NULL
,

40 cÚ¡ 
	gDeviû
::
ButšAùiÚ
 
MENU_ACTIONS
[] = {

41 
Deviû
::
REBOOT
,

42 
Deviû
::
REBOOT_BOOTLOADER
,

43 
Deviû
::
APPLY_ADB_SIDELOAD
,

44 
Deviû
::
APPLY_SDCARD
,

45 
Deviû
::
WIPE_DATA
,

47 
Deviû
::
WIPE_CACHE
,

49 
Deviû
::
RUN_GRAPHICS_TEST
,

50 
Deviû
::
SHUTDOWN
,

51 
Deviû
::
ZZYTEST
,

54 #ià
VENDOR_SOFTBANK


55 cÚ¡ * 
	gMENU_ITEMS_»move_çùÜy_»£t_fÜ_s_Ú
[] = {

63 
NULL
,

66 cÚ¡ 
	gDeviû
::
ButšAùiÚ
 
MENU_ACTIONS_»move_çùÜy_»£t_fÜ_s_Ú
[] = {

67 
Deviû
::
REBOOT
,

68 
Deviû
::
REBOOT_BOOTLOADER
,

69 
Deviû
::
APPLY_ADB_SIDELOAD
,

70 
Deviû
::
APPLY_SDCARD
,

71 
Deviû
::
WIPE_CACHE
,

72 
Deviû
::
RUN_GRAPHICS_TEST
,

73 
Deviû
::
SHUTDOWN
,

77 
¡©ic_as£¹
((
MENU_ITEMS
) / (MENU_ITEMS[0]) ==

78 (
MENU_ACTIONS
) / (MENU_ACTIONS[0]) + 1,

82 cÚ¡ * cÚ¡* 
	gDeviû
::
	$G‘M’uI‹ms
() {

83 #ià
VENDOR_SOFTBANK


84 
ro_´İ
[
PROPERTY_VALUE_MAX
];

85 
	`´İ”ty_g‘
("ro.sf", 
ro_´İ
, 
S_OFF
);

86 ià(
	`¡ºcmp
(
ro_´İ
, 
S_ON
, 
	`¡¾’
(S_ON) ) == 0) {

87  
MENU_ITEMS_»move_çùÜy_»£t_fÜ_s_Ú
;

90  
MENU_ITEMS
;

91 
	}
}

93 
	gDeviû
::
ButšAùiÚ
 
Deviû
::
	$InvokeM’uI‹m
(
m’u_pos™iÚ
) {

94 #ià
VENDOR_SOFTBANK


95 
ro_´İ
[
PROPERTY_VALUE_MAX
];

96 
	`´İ”ty_g‘
("ro.sf", 
ro_´İ
, 
S_OFF
);

97 ià(
	`¡ºcmp
(
ro_´İ
, 
S_ON
, 
	`¡¾’
(S_ON) ) == 0) {

98  
m’u_pos™iÚ
 < 0 ? 
NO_ACTION
 : 
MENU_ACTIONS_»move_çùÜy_»£t_fÜ_s_Ú
[menu_position];

102  
m’u_pos™iÚ
 < 0 ? 
NO_ACTION
 : 
MENU_ACTIONS
[menu_position];

103 
	}
}

105 
	gDeviû
::
	$HªdËM’uKey
(
key
, 
boŞ
 
visibË
) {

106 ià(!
visibË
) {

107  
kNoAùiÚ
;

110 
key
) {

111 
KEY_DOWN
:

112 
KEY_VOLUMEDOWN
:

113  
kHighlightDown
;

115 
KEY_UP
:

116 
KEY_VOLUMEUP
:

117  
kHighlightUp
;

119 
KEY_ENTER
:

120 
KEY_POWER
:

121  
kInvokeI‹m
;

126  
ui_
->
	`HasTh»eBu‰Ús
(è? 
kNoAùiÚ
 : 
kHighlightDown
;

128 
	}
}

130 
boŞ
 
	gDeviû
::
	$P»WeD©a
() {

132 
	}
}

	@device.h

17 #iâdeà
_RECOVERY_DEVICE_H


18 
	#_RECOVERY_DEVICE_H


	)

20 
	~"ui.h
"

22 şas 
	cDeviû
 {

23 
	mpublic
:

24 
ex¶ic™
 
	$Deviû
(
Recov”yUI
* 
ui
è: 
	$ui_
(
ui
) {}

25 
vœtu®
 ~
	$Deviû
(è{
	}
}

30 
vœtu®
 
Recov”yUI
* 
	$G‘UI
() {

31  
ui_
;

32 
	}
}

36 
vœtu®
 
	$S¹Recov”y
(è{
	}
};

54 
vœtu®
 
HªdËM’uKey
(
key
, 
boŞ
 
visibË
);

56 
	eButšAùiÚ
 {

57 
	gNO_ACTION
 = 0,

58 
	gREBOOT
 = 1,

59 
	gAPPLY_SDCARD
 = 2,

61 
	gAPPLY_ADB_SIDELOAD
 = 4,

62 
	gWIPE_DATA
 = 5,

63 
	gWIPE_CACHE
 = 6,

64 
	gREBOOT_BOOTLOADER
 = 7,

65 
	gSHUTDOWN
 = 8,

66 
	gVIEW_RECOVERY_LOGS
 = 9,

67 
	gMOUNT_SYSTEM
 = 10,

68 
	gRUN_GRAPHICS_TEST
 = 11,

69 
	gREBOOT_TO_ERASEMODEMST1_2
 = 12,

70 
	gZZYTEST
 = 13,

75 
vœtu®
 cÚ¡ * cÚ¡* 
G‘M’uI‹ms
();

83 
vœtu®
 
ButšAùiÚ
 
InvokeM’uI‹m
(
m’u_pos™iÚ
);

85 cÚ¡ 
	gkNoAùiÚ
 = -1;

86 cÚ¡ 
	gkHighlightUp
 = -2;

87 cÚ¡ 
	gkHighlightDown
 = -3;

88 cÚ¡ 
	gkInvokeI‹m
 = -4;

95 
vœtu®
 
boŞ
 
P»WeD©a
();

97 
vœtu®
 
boŞ
 
	$Po¡WeD©a
() {

98  
Œue
;

99 
	}
}

101 
	g´iv©e
:

102 
Recov”yUI
* 
ui_
;

107 
Deviû
* 
make_deviû
();

	@error_code.h

17 #iâdeà
_ERROR_CODE_H_


18 
	#_ERROR_CODE_H_


	)

20 
	eE¼ÜCode
 {

21 
	mkNoE¼Ü
 = -1,

22 
	mkLowB©‹ry
 = 20,

23 
	mkZV”ifiÿtiÚFau»
,

24 
	mkZO³nFau»
,

25 
	mkBoÙ»asÚInBÏckli¡
,

26 
	mkPackageCom·tib™yFau»
,

29 
	eCau£Code
 {

30 
	mkNoCau£
 = -1,

31 
	mkArgsP¬sšgFau»
 = 100,

32 
	mkSshC»©iÚFau»
,

33 
	mkFeO³nFau»
,

34 
	mkL£ekFau»
,

35 
	mkF»adFau»
,

36 
	mkFwr™eFau»
,

37 
	mkFsyncFau»
,

38 
	mkLibãcFau»
,

39 
	mkFeG‘PrİFau»
,

40 
	mkFeR’ameFau»
,

41 
	mkSymlškFau»
,

42 
	mkS‘M‘ad©aFau»
,

43 
	mkTuÃ2FsFau»
,

44 
	mkReboÙFau»
,

45 
	mkPackageExŒaùFeFau»
,

46 
	mkV’dÜFau»
 = 200

49 
	eUnüy±E¼ÜCode
 {

50 
	mkUnüy±NoE¼Ü
 = -1,

51 
	mkUnüy±E¼ÜPÏûhŞd”
 = 50,

52 
	mkUnüy±TimeoutE¼Ü
 = 100,

53 
	mkUnüy±FeRemoveE¼Ü
,

54 
	mkUnüy±FeO³nE¼Ü
,

55 
	mkUnüy±Sock‘O³nE¼Ü
,

56 
	mkUnüy±Sock‘Wr™eE¼Ü
,

57 
	mkUnüy±Sock‘Li¡’E¼Ü
,

58 
	mkUnüy±Sock‘Acû±E¼Ü
,

59 
	mkUnüy±F¡abR—dE¼Ü
,

60 
	mkUnüy±FeStE¼Ü
,

61 
	mkUnüy±BlockO³nE¼Ü
,

62 
	mkUnüy±IoùlE¼Ü
,

63 
	mkUnüy±R—dE¼Ü
,

64 
	mkUnüy±Wr™eE¼Ü
,

65 
	mkUnüy±FeSyncE¼Ü
,

66 
	mkUnüy±FeClo£E¼Ü
,

67 
	mkUnüy±FeR’ameE¼Ü
,

68 
	mkUnüy±PackageMissšgE¼Ü
,

	@minadbd/fuse_adb_provider.cpp

17 
	~<¡dlib.h
>

18 
	~<¡dio.h
>

19 
	~<¡ršg.h
>

20 
	~<”ºo.h
>

22 
	~"adb.h
"

23 
	~"adb_io.h
"

24 
	~"fu£_adb_´ovid”.h
"

25 
	~"fu£_sid–ßd.h
"

27 
	$»ad_block_adb
(* 
d©a
, 
ušt32_t
 
block
, 
ušt8_t
* 
bufãr
, ušt32_ˆ
ãtch_size
) {

28 
adb_d©a
* 
ad
 = 
»š‹½»t_ÿ¡
<adb_d©a*>(
d©a
);

30 ià(!
	`Wr™eFdFmt
(
ad
->
sfd
, "%08u", 
block
)) {

31 
	`årštf
(
¡d”r
, "çedØwr™tØadb ho¡: %s\n", 
	`¡»¼Ü
(
”ºo
));

32  -
EIO
;

35 ià(!
	`R—dFdExaùly
(
ad
->
sfd
, 
bufãr
, 
ãtch_size
)) {

36 
	`årštf
(
¡d”r
, "çedØ»ad from‡db ho¡: %s\n", 
	`¡»¼Ü
(
”ºo
));

37  -
EIO
;

41 
	}
}

43 
	$şo£_adb
(* 
d©a
) {

44 
adb_d©a
* 
ad
 = 
»š‹½»t_ÿ¡
<adb_d©a*>(
d©a
);

45 
	`Wr™eFdExaùly
(
ad
->
sfd
, "DONEDONE");

46 
	}
}

48 
	$run_adb_fu£
(
sfd
, 
ušt64_t
 
fe_size
, 
ušt32_t
 
block_size
) {

49 
adb_d©a
 
ad
;

50 
ad
.
sfd
 = sfd;

51 
ad
.
fe_size
 = file_size;

52 
ad
.
block_size
 = block_size;

54 
´ovid”_vb
 
vb
;

55 
vb
.
»ad_block
 = 
»ad_block_adb
;

56 
vb
.
şo£
 = 
şo£_adb
;

58  
	`run_fu£_sid–ßd
(&
vb
, &
ad
, 
fe_size
, 
block_size
);

59 
	}
}

	@minadbd/fuse_adb_provider.h

17 #iâdeà
__FUSE_ADB_PROVIDER_H


18 
	#__FUSE_ADB_PROVIDER_H


	)

20 
	~<¡dšt.h
>

22 
	sadb_d©a
 {

23 
	msfd
;

25 
ušt64_t
 
	mfe_size
;

26 
ušt32_t
 
	mblock_size
;

29 
»ad_block_adb
(* 
cook›
, 
ušt32_t
 
block
, 
ušt8_t
* 
bufãr
, ušt32_ˆ
ãtch_size
);

30 
run_adb_fu£
(
sfd
, 
ušt64_t
 
fe_size
, 
ušt32_t
 
block_size
);

	@minadbd/fuse_adb_provider_test.cpp

17 
	~"fu£_adb_´ovid”.h
"

19 
	~<g‹¡/g‹¡.h
>

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<sys/sock‘.h
>

25 
	~<¡ršg
>

27 
	~"adb_io.h
"

29 
	$TEST
(
fu£_adb_´ovid”
, 
»ad_block_adb
) {

30 
adb_d©a
 
d©a
 = {};

31 
sock‘s
[2];

33 
	`ASSERT_EQ
(0, 
	`sock‘·œ
(
AF_UNIX
, 
SOCK_STREAM
, 0, 
sock‘s
));

34 
d©a
.
sfd
 = 
sock‘s
[0];

36 
ho¡_sock‘
 = 
sock‘s
[1];

37 
	`fú
(
ho¡_sock‘
, 
F_SETFL
, 
O_NONBLOCK
);

39 cÚ¡ 
ex³ùed_d©a
[] = "foobar";

40 
block_d©a
[(
ex³ùed_d©a
)] = {};

44 
	`ASSERT_TRUE
(
	`Wr™eFdExaùly
(
ho¡_sock‘
, 
ex³ùed_d©a
,

45 
	`¡¾’
(
ex³ùed_d©a
)));

47 
ušt32_t
 
block
 = 1234U;

48 cÚ¡ 
ex³ùed_block
[] = "00001234";

49 
	`ASSERT_EQ
(0, 
	`»ad_block_adb
(
»š‹½»t_ÿ¡
<*>(&
d©a
), 
block
,

50 
»š‹½»t_ÿ¡
<
ušt8_t
*>(
block_d©a
),

51 (
ex³ùed_d©a
) - 1));

54 
block_»q
[(
ex³ùed_block
)] = {};

55 
	`ASSERT_TRUE
(
	`R—dFdExaùly
(
ho¡_sock‘
, 
block_»q
, 8));

56 
	`ASSERT_EQ
(0, 
block_»q
[8]);

57 
	`ASSERT_EQ
(8U, 
	`¡¾’
(
block_»q
));

58 
	`ASSERT_STREQ
(
ex³ùed_block
, 
block_»q
);

61 
	`ASSERT_EQ
(0, 
block_»q
[8]);

62 
	`ASSERT_STREQ
(
ex³ùed_d©a
, 
block_d©a
);

65 
tmp
;

66 
”ºo
 = 0;

67 
	`ASSERT_EQ
(-1, 
	`»ad
(
ho¡_sock‘
, &
tmp
, 1));

68 
	`ASSERT_EQ
(
EWOULDBLOCK
, 
”ºo
);

70 
	`şo£
(
sock‘s
[0]);

71 
	`şo£
(
sock‘s
[1]);

72 
	}
}

74 
	$TEST
(
fu£_adb_´ovid”
, 
»ad_block_adb_ç_wr™e
) {

75 
adb_d©a
 
d©a
 = {};

76 
sock‘s
[2];

78 
	`ASSERT_EQ
(0, 
	`sock‘·œ
(
AF_UNIX
, 
SOCK_STREAM
, 0, 
sock‘s
));

79 
d©a
.
sfd
 = 
sock‘s
[0];

81 
	`ASSERT_EQ
(0, 
	`şo£
(
sock‘s
[1]));

83 
buf
[1];

84 
	`ASSERT_EQ
(-
EIO
, 
	`»ad_block_adb
(
»š‹½»t_ÿ¡
<*>(&
d©a
), 0,

85 
»š‹½»t_ÿ¡
<
ušt8_t
*>(
buf
), 1));

87 
	`şo£
(
sock‘s
[0]);

88 
	}
}

	@minadbd/minadbd.cpp

17 
	~"mšadbd.h
"

19 
	~<”ºo.h
>

20 
	~<sigÇl.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

24 
	~"adb.h
"

25 
	~"adb_auth.h
"

26 
	~"Œª¥Üt.h
"

28 
	$mšadbd_maš
() {

29 
adb_deviû_bªÃr
 = "sideload";

31 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

34 
auth_»quœed
 = 
çl£
;

36 
	`š™_Œª¥Üt_»gi¡¿tiÚ
();

37 
	`usb_š™
();

39 
	`VLOG
(
ADB
) << "Event†oop starting";

40 
	`fdev’t_loİ
();

43 
	}
}

	@minadbd/minadbd.h

17 #iâdeà
MINADBD_H__


18 
	#MINADBD_H__


	)

20 
mšadbd_maš
();

	@minadbd/minadbd_services.cpp

17 
	~<”ºo.h
>

18 
	~<š‰y³s.h
>

19 
	~<¡dio.h
>

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

22 
	~<uni¡d.h
>

24 
	~"adb.h
"

25 
	~"fdev’t.h
"

26 
	~"fu£_adb_´ovid”.h
"

27 
	~"sysd•s.h
"

29 
¡šfo
 
	t¡šfo
;

31 
	s¡šfo
 {

32 (*
	mfunc
)(
	mfd
, *
	mcook›
);

33 
	mfd
;

34 *
	mcook›
;

37 
	$£rviû_boÙ¡¿p_func
(* 
x
) {

38 
¡šfo
* 
¡i
 = 
»š‹½»t_ÿ¡
<¡šfo*>(
x
);

39 
¡i
->
	`func
(¡i->
fd
, sti->
cook›
);

40 
	`ä“
(
¡i
);

41 
	}
}

43 
	$sid–ßd_ho¡_£rviû
(
sfd
, * 
d©a
) {

44 * 
¬gs
 = 
»š‹½»t_ÿ¡
<*>(
d©a
);

45 
fe_size
;

46 
block_size
;

47 ià(
	`ssÿnf
(
¬gs
, "%d:%d", &
fe_size
, &
block_size
) != 2) {

48 
	`´štf
("bad sid–ßd-ho¡‡rgum’ts: %s\n", 
¬gs
);

49 
	`ex™
(1);

51 
	`ä“
(
¬gs
);

53 
	`´štf
("sid–ßd-ho¡ fsiz%d block siz%d\n", 
fe_size
, 
block_size
);

55 
»suÉ
 = 
	`run_adb_fu£
(
sfd
, 
fe_size
, 
block_size
);

57 
	`´štf
("sideload_host finished\n");

58 
	`¦“p
(1);

59 
	`ex™
(
»suÉ
 == 0 ? 0 : 1);

60 
	}
}

62 
	$ü—‹_£rviû_th»ad
((*
func
)(, *), *
cook›
) {

63 
s
[2];

64 ià(
	`adb_sock‘·œ
(
s
)) {

65 
	`´štf
("cannot create service socket…air\n");

69 
¡šfo
* 
¡i
 = 
¡©ic_ÿ¡
<¡šfo*>(
	`m®loc
((stinfo)));

70 if(
¡i
 =ğ0è
	`çl
("cannot‡llocate stinfo");

71 
¡i
->
func
 = func;

72 
¡i
->
cook›
 = cookie;

73 
¡i
->
fd
 = 
s
[1];

75 ià(!
	`adb_th»ad_ü—‹
(
£rviû_boÙ¡¿p_func
, 
¡i
)) {

76 
	`ä“
(
¡i
);

77 
	`adb_şo£
(
s
[0]);

78 
	`adb_şo£
(
s
[1]);

79 
	`´štf
("cannot create servicehread\n");

83 
	`VLOG
(
SERVICES
è<< "£rviûh»ad s¹ed, " << 
s
[0] << ":" << s[1];

84  
s
[0];

85 
	}
}

87 
	$£rviû_to_fd
(cÚ¡ * 
Çme
, cÚ¡ 
©¿n¥Üt
* 
Œª¥Üt
) {

88 
»t
 = -1;

90 ià(!
	`¡ºcmp
(
Çme
, "sideload:", 9)) {

94 
	`ex™
(3);

95 } ià(!
	`¡ºcmp
(
Çme
, "sideload-host:", 14)) {

96 * 
¬g
 = 
	`¡rdup
(
Çme
 + 14);

97 
»t
 = 
	`ü—‹_£rviû_th»ad
(
sid–ßd_ho¡_£rviû
, 
¬g
);

99 ià(
»t
 >= 0) {

100 
	`şo£_Ú_exec
(
»t
);

102  
»t
;

103 
	}
}

	@minui/events.cpp

17 
	~<dœ’t.h
>

18 
	~<fú.h
>

19 
	~<lšux/šput.h
>

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<sys/•Şl.h
>

24 
	~<sys/ioùl.h
>

25 
	~<uni¡d.h
>

27 
	~<funùiÚ®
>

29 
	~"mšui/mšui.h
"

31 
	#MAX_DEVICES
 16

	)

32 
	#MAX_MISC_FDS
 16

	)

34 
	#BITS_PER_LONG
 ((è* 8)

	)

35 
	#BITS_TO_LONGS
(
x
è(((xè+ 
BITS_PER_LONG
 - 1è/ BITS_PER_LONG)

	)

37 
	sfd_šfo
 {

38 
	mfd
;

39 
ev_ÿÎback
 
	mcb
;

42 
	gg_•Şl_fd
;

43 
•Şl_ev’t
 
	gpŞËdev’ts
[
MAX_DEVICES
 + 
MAX_MISC_FDS
];

44 
	gÅŞËdev’ts
;

46 
fd_šfo
 
	gev_fdšfo
[
MAX_DEVICES
 + 
MAX_MISC_FDS
];

48 
	gev_couÁ
 = 0;

49 
	gev_dev_couÁ
 = 0;

50 
	gev_misc_couÁ
 = 0;

52 
boŞ
 
	$‹¡_b™
(
size_t
 
b™
, * 
¬¿y
) {

53  (
¬¿y
[
b™
/
BITS_PER_LONG
] & (1UL << (bit % BITS_PER_LONG))) != 0;

54 
	}
}

56 
	$ev_š™
(
ev_ÿÎback
 
šput_cb
) {

57 
boŞ
 
•Şlùlç
 = 
çl£
;

59 
g_•Şl_fd
 = 
	`•Şl_ü—‹
(
MAX_DEVICES
 + 
MAX_MISC_FDS
);

60 ià(
g_•Şl_fd
 == -1) {

64 
DIR
* 
dœ
 = 
	`İ’dœ
("/dev/input");

65 ià(
dœ
 !ğ
NULL
) {

66 
dœ’t
* 
de
;

67 (
de
 = 
	`»addœ
(
dœ
))) {

69 
ev_b™s
[
	`BITS_TO_LONGS
(
EV_MAX
)];

72 ià(
	`¡ºcmp
(
de
->
d_Çme
, "event", 5)) ;

73 
fd
 = 
	`İ’©
(
	`dœfd
(
dœ
), 
de
->
d_Çme
, 
O_RDONLY
);

74 ià(
fd
 == -1) ;

77 ià(
	`ioùl
(
fd
, 
	`EVIOCGBIT
(0, (
ev_b™s
)),ƒv_bits) == -1) {

78 
	`şo£
(
fd
);

83 ià(!
	`‹¡_b™
(
EV_KEY
, 
ev_b™s
è&& !‹¡_b™(
EV_REL
,ƒv_b™sè&& !‹¡_b™(
EV_SW
,ƒv_bits)) {

84 
	`şo£
(
fd
);

88 
•Şl_ev’t
 
ev
;

89 
ev
.
ev’ts
 = 
EPOLLIN
 | 
EPOLLWAKEUP
;

90 
ev
.
d©a
.
±r
 = &
ev_fdšfo
[
ev_couÁ
];

91 ià(
	`•Şl_ùl
(
g_•Şl_fd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev
) == -1) {

92 
	`şo£
(
fd
);

93 
•Şlùlç
 = 
Œue
;

97 
ev_fdšfo
[
ev_couÁ
].
fd
 = fd;

98 
ev_fdšfo
[
ev_couÁ
].
cb
 = 
¡d
::
	`move
(
šput_cb
);

99 
ev_couÁ
++;

100 
ev_dev_couÁ
++;

101 ià(
ev_dev_couÁ
 =ğ
MAX_DEVICES
) ;

104 
	`şo£dœ
(
dœ
);

107 ià(
•Şlùlç
 && !
ev_couÁ
) {

108 
	`şo£
(
g_•Şl_fd
);

109 
g_•Şl_fd
 = -1;

114 
	}
}

116 
	$ev_g‘_•Şlfd
() {

117  
g_•Şl_fd
;

118 
	}
}

120 
	$ev_add_fd
(
fd
, 
ev_ÿÎback
 
cb
) {

121 ià(
ev_misc_couÁ
 =ğ
MAX_MISC_FDS
 || 
cb
 =ğ
NULL
) {

125 
•Şl_ev’t
 
ev
;

126 
ev
.
ev’ts
 = 
EPOLLIN
 | 
EPOLLWAKEUP
;

127 
ev
.
d©a
.
±r
 = 
¡©ic_ÿ¡
<*>(&
ev_fdšfo
[
ev_couÁ
]);

128 
»t
 = 
	`•Şl_ùl
(
g_•Şl_fd
, 
EPOLL_CTL_ADD
, 
fd
, &
ev
);

129 ià(!
»t
) {

130 
ev_fdšfo
[
ev_couÁ
].
fd
 = fd;

131 
ev_fdšfo
[
ev_couÁ
].
cb
 = 
¡d
::
	`move
(cb);

132 
ev_couÁ
++;

133 
ev_misc_couÁ
++;

136  
»t
;

137 
	}
}

139 
	$ev_ex™
() {

140 
ev_couÁ
 > 0) {

141 
	`şo£
(
ev_fdšfo
[--
ev_couÁ
].
fd
);

143 
ev_misc_couÁ
 = 0;

144 
ev_dev_couÁ
 = 0;

145 
	`şo£
(
g_•Şl_fd
);

146 
	}
}

148 
	$ev_wa™
(
timeout
) {

149 
ÅŞËdev’ts
 = 
	`•Şl_wa™
(
g_•Şl_fd
, 
pŞËdev’ts
, 
ev_couÁ
, 
timeout
);

150 ià(
ÅŞËdev’ts
 <= 0) {

154 
	}
}

156 
	$ev_di¥©ch
() {

157 
n
 = 0;‚ < 
ÅŞËdev’ts
;‚++) {

158 
fd_šfo
* 
fdi
 = 
¡©ic_ÿ¡
<fd_šfo*>(
pŞËdev’ts
[
n
].
d©a
.
±r
);

159 cÚ¡ 
ev_ÿÎback
& 
cb
 = 
fdi
->cb;

160 ià(
cb
) {

161 
	`cb
(
fdi
->
fd
, 
pŞËdev’ts
[
n
].
ev’ts
);

164 
	}
}

166 
	$ev_g‘_šput
(
fd
, 
ušt32_t
 
•ev’ts
, 
šput_ev’t
* 
ev
) {

167 ià(
•ev’ts
 & 
EPOLLIN
) {

168 
ssize_t
 
r
 = 
	`TEMP_FAILURE_RETRY
(
	`»ad
(
fd
, 
ev
, (*ev)));

169 ià(
r
 =ğ(*
ev
)) {

174 
	}
}

176 
	$ev_sync_key_¡©e
(cÚ¡ 
ev_£t_key_ÿÎback
& 
£t_key_cb
) {

178 
ev_b™s
[
	`BITS_TO_LONGS
(
EV_MAX
)];

179 
key_b™s
[
	`BITS_TO_LONGS
(
KEY_MAX
)];

181 
size_t
 
i
 = 0; i < 
ev_dev_couÁ
; ++i) {

182 
	`mem£t
(
ev_b™s
, 0, (ev_bits));

183 
	`mem£t
(
key_b™s
, 0, (key_bits));

185 ià(
	`ioùl
(
ev_fdšfo
[
i
].
fd
, 
	`EVIOCGBIT
(0, (
ev_b™s
)),ƒv_bits) == -1) {

188 ià(!
	`‹¡_b™
(
EV_KEY
, 
ev_b™s
)) {

191 ià(
	`ioùl
(
ev_fdšfo
[
i
].
fd
, 
	`EVIOCGKEY
((
key_b™s
)), key_bits) == -1) {

195 
code
 = 0; cod<ğ
KEY_MAX
; code++) {

196 ià(
	`‹¡_b™
(
code
, 
key_b™s
)) {

197 
	`£t_key_cb
(
code
, 1);

203 
	}
}

205 
ev_™”©e_avaabË_keys
(cÚ¡ 
¡d
::
funùiÚ
<()>& 
f
) {

207 
ev_b™s
[
BITS_TO_LONGS
(
EV_MAX
)];

208 
	gkey_b™s
[
BITS_TO_LONGS
(
KEY_MAX
)];

210 
size_t
 
	gi
 = 0; i < 
	gev_dev_couÁ
; ++i) {

211 
mem£t
(
ev_b™s
, 0, (ev_bits));

212 
mem£t
(
key_b™s
, 0, (key_bits));

215 ià(
ioùl
(
ev_fdšfo
[
i
].
fd
, 
EVIOCGBIT
(0, (
ev_b™s
)),ƒv_bits) == -1) {

218 ià(!
‹¡_b™
(
EV_KEY
, 
ev_b™s
)) {

222 
	grc
 = 
ioùl
(
ev_fdšfo
[
i
].
fd
, 
EVIOCGBIT
(
EV_KEY
, 
KEY_MAX
), 
key_b™s
);

223 ià(
	grc
 == -1) {

227 
	gkey_code
 = 0; key_cod<ğ
KEY_MAX
; ++key_code) {

228 ià(
‹¡_b™
(
key_code
, 
key_b™s
)) {

229 
f
(
key_code
);

	@minui/font_10x18.h

2 
	mwidth
;

3 
	mheight
;

4 
	mch¬_width
;

5 
	mch¬_height
;

6 
	mrund©a
[2973];

7 } 
	gfÚt
 = {

8 .
width
 = 960,

9 .
	gheight
 = 18,

10 .
	gch¬_width
 = 10,

11 .
	gch¬_height
 = 18,

12 .
	grund©a
 = {

	@minui/graphics.cpp

17 
	~"g¿phics.h
"

19 
	~<¡dio.h
>

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

23 
	~<memÜy
>

25 
	~"fÚt_10x18.h
"

26 
	~"g¿phics_adf.h
"

27 
	~"g¿phics_drm.h
"

28 
	~"g¿phics_fbdev.h
"

29 
	~"mšui/mšui.h
"

31 
GRFÚt
* 
	ggr_fÚt
 = 
NULL
;

32 
GRFÚt
* 
	ghtc_gr_fÚt
 = 
NULL
;

33 
MšuiBack’d
* 
	ggr_back’d
 = 
nuÎ±r
;

35 
	gov”sÿn_³rûÁ
 = 
OVERSCAN_PERCENT
;

36 
	gov”sÿn_off£t_x
 = 0;

37 
	gov”sÿn_off£t_y
 = 0;

39 
	ggr_cu¼’t_r
 = 255;

40 
	ggr_cu¼’t_g
 = 255;

41 
	ggr_cu¼’t_b
 = 255;

42 
	ggr_cu¼’t_a
 = 255;

44 
GRSurçû
* 
	ggr_d¿w
 = 
NULL
;

46 
boŞ
 
	$outside
(
x
, 
y
)

48  
x
 < 0 || x >ğ
gr_d¿w
->
width
 || 
y
 < 0 || y >ğgr_d¿w->
height
;

49 
	}
}

51 cÚ¡ 
GRFÚt
* 
	$gr_sys_fÚt
()

53  
gr_fÚt
;

54 
	}
}

56 
	$gr_m—su»
(cÚ¡ 
GRFÚt
* 
fÚt
, cÚ¡ *
s
)

58  
fÚt
->
ch¬_width
 * 
	`¡¾’
(
s
);

59 
	}
}

61 
	$gr_fÚt_size
(cÚ¡ 
GRFÚt
* 
fÚt
, *
x
, *
y
)

63 *
x
 = 
fÚt
->
ch¬_width
;

64 *
y
 = 
fÚt
->
ch¬_height
;

65 
	}
}

67 
	$htc_gr_fÚt_size
(*
x
, *
y
)

69 *
x
 = 
htc_gr_fÚt
->
ch¬_width
;

70 *
y
 = 
htc_gr_fÚt
->
ch¬_height
;

71 
	}
}

73 
	$‹xt_bËnd
(* 
¤c_p
, 
¤c_row_by‹s
,

74 * 
d¡_p
, 
d¡_row_by‹s
,

75 
width
, 
height
)

77 
j
 = 0; j < 
height
; ++j) {

78 * 
sx
 = 
¤c_p
;

79 * 
px
 = 
d¡_p
;

80 
i
 = 0; i < 
width
; ++i) {

81 
a
 = *
sx
++;

82 ià(
gr_cu¼’t_a
 < 255è
a
 = (()a * gr_current_a) / 255;

83 ià(
a
 == 255) {

84 *
px
++ = 
gr_cu¼’t_r
;

85 *
px
++ = 
gr_cu¼’t_g
;

86 *
px
++ = 
gr_cu¼’t_b
;

87 
px
++;

88 } ià(
a
 > 0) {

89 *
px
 = (*px * (255-
a
è+ 
gr_cu¼’t_r
 *‡) / 255;

90 ++
px
;

91 *
px
 = (*px * (255-
a
è+ 
gr_cu¼’t_g
 *‡) / 255;

92 ++
px
;

93 *
px
 = (*px * (255-
a
è+ 
gr_cu¼’t_b
 *‡) / 255;

94 ++
px
;

95 ++
px
;

97 
px
 += 4;

100 
¤c_p
 +ğ
¤c_row_by‹s
;

101 
d¡_p
 +ğ
d¡_row_by‹s
;

103 
	}
}

105 
	$htc_gr_‹xt
(
x
, 
y
, cÚ¡ *
s
, 
boŞ
 
bŞd
)

107 
GRFÚt
* 
fÚt
 = 
htc_gr_fÚt
;

109 ià(!
fÚt
->
‹xtu»
 || 
gr_cu¼’t_a
 == 0) ;

111 
bŞd
 = bŞd && (
fÚt
->
‹xtu»
->
height
 !ğfÚt->
ch¬_height
);

113 
x
 +ğ
ov”sÿn_off£t_x
;

114 
y
 +ğ
ov”sÿn_off£t_y
;

116 
ch
;

117 (
ch
 = *
s
++)) {

118 ià(
	`outside
(
x
, 
y
è|| outside(x+
fÚt
->
ch¬_width
-1, y+fÚt->
ch¬_height
-1)) ;

120 ià(
ch
 < ' ' || ch > '~') {

121 
ch
 = '?';

124 * 
¤c_p
 = 
fÚt
->
‹xtu»
->
d©a
 + ((
ch
 - ' 'è* fÚt->
ch¬_width
) +

125 (
bŞd
 ? 
fÚt
->
ch¬_height
 * fÚt->
‹xtu»
->
row_by‹s
 : 0);

126 * 
d¡_p
 = 
gr_d¿w
->
d©a
 + 
y
*gr_d¿w->
row_by‹s
 + 
x
*gr_d¿w->
pix–_by‹s
;

128 
	`‹xt_bËnd
(
¤c_p
, 
fÚt
->
‹xtu»
->
row_by‹s
,

129 
d¡_p
, 
gr_d¿w
->
row_by‹s
,

130 
fÚt
->
ch¬_width
, fÚt->
ch¬_height
);

132 
x
 +ğ
fÚt
->
ch¬_width
;

134 
	}
}

136 
	$gr_‹xt
(cÚ¡ 
GRFÚt
* 
fÚt
, 
x
, 
y
, cÚ¡ *
s
, 
boŞ
 
bŞd
)

138 ià(!
fÚt
->
‹xtu»
 || 
gr_cu¼’t_a
 == 0) ;

140 
bŞd
 = bŞd && (
fÚt
->
‹xtu»
->
height
 !ğfÚt->
ch¬_height
);

142 
x
 +ğ
ov”sÿn_off£t_x
;

143 
y
 +ğ
ov”sÿn_off£t_y
;

145 
ch
;

146 (
ch
 = *
s
++)) {

147 ià(
	`outside
(
x
, 
y
è|| outside(x+
fÚt
->
ch¬_width
-1, y+fÚt->
ch¬_height
-1)) ;

149 ià(
ch
 < ' ' || ch > '~') {

150 
ch
 = '?';

153 * 
¤c_p
 = 
fÚt
->
‹xtu»
->
d©a
 + ((
ch
 - ' 'è* fÚt->
ch¬_width
) +

154 (
bŞd
 ? 
fÚt
->
ch¬_height
 * fÚt->
‹xtu»
->
row_by‹s
 : 0);

155 * 
d¡_p
 = 
gr_d¿w
->
d©a
 + 
y
*gr_d¿w->
row_by‹s
 + 
x
*gr_d¿w->
pix–_by‹s
;

157 
	`‹xt_bËnd
(
¤c_p
, 
fÚt
->
‹xtu»
->
row_by‹s
,

158 
d¡_p
, 
gr_d¿w
->
row_by‹s
,

159 
fÚt
->
ch¬_width
, fÚt->
ch¬_height
);

161 
x
 +ğ
fÚt
->
ch¬_width
;

163 
	}
}

165 
	$gr_‹xticÚ
(
x
, 
y
, 
GRSurçû
* 
icÚ
) {

166 ià(
icÚ
 =ğ
NULL
) ;

168 ià(
icÚ
->
pix–_by‹s
 != 1) {

169 
	`´štf
("gr_texticon: source has wrong format\n");

173 
x
 +ğ
ov”sÿn_off£t_x
;

174 
y
 +ğ
ov”sÿn_off£t_y
;

176 ià(
	`outside
(
x
, 
y
è|| outside(x+
icÚ
->
width
-1, y+icÚ->
height
-1)) ;

178 * 
¤c_p
 = 
icÚ
->
d©a
;

179 * 
d¡_p
 = 
gr_d¿w
->
d©a
 + 
y
*gr_d¿w->
row_by‹s
 + 
x
*gr_d¿w->
pix–_by‹s
;

181 
	`‹xt_bËnd
(
¤c_p
, 
icÚ
->
row_by‹s
,

182 
d¡_p
, 
gr_d¿w
->
row_by‹s
,

183 
icÚ
->
width
, icÚ->
height
);

184 
	}
}

186 
	$gr_cŞÜ
(
r
, 
g
, 
b
, 
a
)

188 #ià
	`defšed
(
RECOVERY_ABGR
è|| defšed(
RECOVERY_BGRA
)

189 
gr_cu¼’t_r
 = 
b
;

190 
gr_cu¼’t_g
 = 
g
;

191 
gr_cu¼’t_b
 = 
r
;

192 
gr_cu¼’t_a
 = 
a
;

194 
gr_cu¼’t_r
 = 
r
;

195 
gr_cu¼’t_g
 = 
g
;

196 
gr_cu¼’t_b
 = 
b
;

197 
gr_cu¼’t_a
 = 
a
;

199 
	}
}

201 
	$gr_ş—r
()

203 ià(
gr_cu¼’t_r
 =ğ
gr_cu¼’t_g
 && gr_cu¼’t_¸=ğ
gr_cu¼’t_b
) {

204 
	`mem£t
(
gr_d¿w
->
d©a
, 
gr_cu¼’t_r
, gr_d¿w->
height
 * gr_d¿w->
row_by‹s
);

206 * 
px
 = 
gr_d¿w
->
d©a
;

207 
y
 = 0; y < 
gr_d¿w
->
height
; ++y) {

208 
x
 = 0; x < 
gr_d¿w
->
width
; ++x) {

209 *
px
++ = 
gr_cu¼’t_r
;

210 *
px
++ = 
gr_cu¼’t_g
;

211 *
px
++ = 
gr_cu¼’t_b
;

212 
px
++;

214 
px
 +ğ
gr_d¿w
->
row_by‹s
 - (gr_d¿w->
width
 * gr_d¿w->
pix–_by‹s
);

217 
	}
}

219 
	$gr_fl
(
x1
, 
y1
, 
x2
, 
y2
)

221 
x1
 +ğ
ov”sÿn_off£t_x
;

222 
y1
 +ğ
ov”sÿn_off£t_y
;

224 
x2
 +ğ
ov”sÿn_off£t_x
;

225 
y2
 +ğ
ov”sÿn_off£t_y
;

227 ià(
	`outside
(
x1
, 
y1
è|| outside(
x2
-1, 
y2
-1)) ;

229 * 
p
 = 
gr_d¿w
->
d©a
 + 
y1
 * gr_d¿w->
row_by‹s
 + 
x1
 * gr_d¿w->
pix–_by‹s
;

230 ià(
gr_cu¼’t_a
 == 255) {

231 
x
, 
y
;

232 
y
 = 
y1
; y < 
y2
; ++y) {

233 * 
px
 = 
p
;

234 
x
 = 
x1
; x < 
x2
; ++x) {

235 *
px
++ = 
gr_cu¼’t_r
;

236 *
px
++ = 
gr_cu¼’t_g
;

237 *
px
++ = 
gr_cu¼’t_b
;

238 
px
++;

240 
p
 +ğ
gr_d¿w
->
row_by‹s
;

242 } ià(
gr_cu¼’t_a
 > 0) {

243 
x
, 
y
;

244 
y
 = 
y1
; y < 
y2
; ++y) {

245 * 
px
 = 
p
;

246 
x
 = 
x1
; x < 
x2
; ++x) {

247 *
px
 = (*px * (255-
gr_cu¼’t_a
è+ 
gr_cu¼’t_r
 * gr_current_a) / 255;

248 ++
px
;

249 *
px
 = (*px * (255-
gr_cu¼’t_a
è+ 
gr_cu¼’t_g
 * gr_current_a) / 255;

250 ++
px
;

251 *
px
 = (*px * (255-
gr_cu¼’t_a
è+ 
gr_cu¼’t_b
 * gr_current_a) / 255;

252 ++
px
;

253 ++
px
;

255 
p
 +ğ
gr_d¿w
->
row_by‹s
;

258 
	}
}

260 
	$gr_bl™
(
GRSurçû
* 
sourû
, 
sx
, 
sy
, 
w
, 
h
, 
dx
, 
dy
) {

261 ià(
sourû
 =ğ
NULL
) ;

263 ià(
gr_d¿w
->
pix–_by‹s
 !ğ
sourû
->pixel_bytes) {

264 
	`´štf
("gr_blit: source has wrong format\n");

268 
dx
 +ğ
ov”sÿn_off£t_x
;

269 
dy
 +ğ
ov”sÿn_off£t_y
;

271 ià(
	`outside
(
dx
, 
dy
è|| outside(dx+
w
-1, dy+
h
-1)) ;

273 * 
¤c_p
 = 
sourû
->
d©a
 + 
sy
*sourû->
row_by‹s
 + 
sx
*sourû->
pix–_by‹s
;

274 * 
d¡_p
 = 
gr_d¿w
->
d©a
 + 
dy
*gr_d¿w->
row_by‹s
 + 
dx
*gr_d¿w->
pix–_by‹s
;

276 
i
;

277 
i
 = 0; i < 
h
; ++i) {

278 
	`memıy
(
d¡_p
, 
¤c_p
, 
w
 * 
sourû
->
pix–_by‹s
);

279 
¤c_p
 +ğ
sourû
->
row_by‹s
;

280 
d¡_p
 +ğ
gr_d¿w
->
row_by‹s
;

282 
	}
}

284 
	$gr_g‘_width
(
GRSurçû
* 
surçû
) {

285 ià(
surçû
 =ğ
NULL
) {

288  
surçû
->
width
;

289 
	}
}

291 
	$gr_g‘_height
(
GRSurçû
* 
surçû
) {

292 ià(
surçû
 =ğ
NULL
) {

295  
surçû
->
height
;

296 
	}
}

298 
	$htc_gr_š™_fÚt
() {

299 
htc_gr_fÚt
 = 
»š‹½»t_ÿ¡
<
GRFÚt
*>(
	`ÿÎoc
((*htc_gr_font), 1));

301 
»s
 = 
	`»s_ü—‹_®pha_surçû
("htc_fÚt", &(
htc_gr_fÚt
->
‹xtu»
));

302 ià(
»s
 == 0) {

306 
htc_gr_fÚt
->
ch¬_width
 = htc_gr_fÚt->
‹xtu»
->
width
 / 96;

307 
htc_gr_fÚt
->
ch¬_height
 = htc_gr_fÚt->
‹xtu»
->
height
 / 2;

310 
	`´štf
("çedØ»ad htøfÚt:„es=%d\n", 
»s
);

313 
htc_gr_fÚt
->
‹xtu»
 = 
»š‹½»t_ÿ¡
<
GRSurçû
*>(
	`m®loc
((*
gr_fÚt
->texture)));

314 
htc_gr_fÚt
->
‹xtu»
->
width
 = 
fÚt
.width;

315 
htc_gr_fÚt
->
‹xtu»
->
height
 = 
fÚt
.height;

316 
htc_gr_fÚt
->
‹xtu»
->
row_by‹s
 = 
fÚt
.
width
;

317 
htc_gr_fÚt
->
‹xtu»
->
pix–_by‹s
 = 1;

319 * 
b™s
 = 
»š‹½»t_ÿ¡
<*>(
	`m®loc
(
fÚt
.
width
 * fÚt.
height
));

320 
htc_gr_fÚt
->
‹xtu»
->
d©a
 = 
»š‹½»t_ÿ¡
<*>(
b™s
);

322 
d©a
;

323 * 
š
 = 
fÚt
.
rund©a
;

324 (
d©a
 = *
š
++)) {

325 
	`mem£t
(
b™s
, (
d©a
 & 0x80) ? 255 : 0, data & 0x7f);

326 
b™s
 +ğ(
d©a
 & 0x7f);

329 
htc_gr_fÚt
->
ch¬_width
 = 
fÚt
.char_width;

330 
htc_gr_fÚt
->
ch¬_height
 = 
fÚt
.char_height;

332 
	}
}

334 
	$gr_š™_fÚt
(cÚ¡ * 
Çme
, 
GRFÚt
** 
de¡
) {

335 
GRFÚt
* 
fÚt
 = 
¡©ic_ÿ¡
<GRFÚt*>(
	`ÿÎoc
(1, (*
gr_fÚt
)));

336 ià(
fÚt
 =ğ
nuÎ±r
) {

340 
»s
 = 
	`»s_ü—‹_®pha_surçû
(
Çme
, &(
fÚt
->
‹xtu»
));

341 ià(
»s
 < 0) {

342 
	`ä“
(
fÚt
);

343  
»s
;

349 
fÚt
->
ch¬_width
 = fÚt->
‹xtu»
->
width
 / 96;

350 
fÚt
->
ch¬_height
 = fÚt->
‹xtu»
->
height
 / 2;

352 *
de¡
 = 
fÚt
;

355 
	}
}

357 
	$gr_š™_fÚt
()

359 
»s
 = 
	`gr_š™_fÚt
("fÚt", &
gr_fÚt
);

360 ià(
»s
 == 0) {

364 
	`´štf
("çedØ»ad fÚt:„es=%d\n", 
»s
);

368 
gr_fÚt
 = 
¡©ic_ÿ¡
<
GRFÚt
*>(
	`ÿÎoc
(1, (*gr_font)));

369 
gr_fÚt
->
‹xtu»
 = 
¡©ic_ÿ¡
<
GRSurçû
*>(
	`m®loc
((*gr_font->texture)));

370 
gr_fÚt
->
‹xtu»
->
width
 = 
fÚt
.width;

371 
gr_fÚt
->
‹xtu»
->
height
 = 
fÚt
.height;

372 
gr_fÚt
->
‹xtu»
->
row_by‹s
 = 
fÚt
.
width
;

373 
gr_fÚt
->
‹xtu»
->
pix–_by‹s
 = 1;

375 * 
b™s
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
fÚt
.
width
 * fÚt.
height
));

376 
gr_fÚt
->
‹xtu»
->
d©a
 = 
b™s
;

378 
d©a
;

379 * 
š
 = 
fÚt
.
rund©a
;

380 (
d©a
 = *
š
++)) {

381 
	`mem£t
(
b™s
, (
d©a
 & 0x80) ? 255 : 0, data & 0x7f);

382 
b™s
 +ğ(
d©a
 & 0x7f);

385 
gr_fÚt
->
ch¬_width
 = 
fÚt
.char_width;

386 
gr_fÚt
->
ch¬_height
 = 
fÚt
.char_height;

387 
	}
}

389 
	$gr_æ
() {

390 
gr_d¿w
 = 
gr_back’d
->
	`Fl
();

391 
	}
}

393 
	$gr_š™
() {

394 
	`gr_š™_fÚt
();

395 
	`htc_gr_š™_fÚt
();

397 autØ
back’d
 = 
¡d
::
unique_±r
<
MšuiBack’d
>{ std::
make_unique
<
MšuiBack’dAdf
>() };

398 
gr_d¿w
 = 
back’d
->
	`In™
();

400 ià(!
gr_d¿w
) {

401 
back’d
 = 
¡d
::
make_unique
<
MšuiBack’dDrm
>();

402 
gr_d¿w
 = 
back’d
->
	`In™
();

405 ià(!
gr_d¿w
) {

406 
back’d
 = 
¡d
::
make_unique
<
MšuiBack’dFbdev
>();

407 
gr_d¿w
 = 
back’d
->
	`In™
();

410 ià(!
gr_d¿w
) {

414 
gr_back’d
 = 
back’d
.
	`»Ëa£
();

416 
ov”sÿn_off£t_x
 = 
gr_d¿w
->
width
 * 
ov”sÿn_³rûÁ
 / 100;

417 
ov”sÿn_off£t_y
 = 
gr_d¿w
->
height
 * 
ov”sÿn_³rûÁ
 / 100;

419 
	`gr_æ
();

420 
	`gr_æ
();

423 
	}
}

425 
	$gr_ex™
() {

426 
d–‘e
 
gr_back’d
;

427 
	}
}

429 
	$gr_fb_width
() {

430  
gr_d¿w
->
width
 - 2 * 
ov”sÿn_off£t_x
;

431 
	}
}

433 
	$gr_fb_height
() {

434  
gr_d¿w
->
height
 - 2 * 
ov”sÿn_off£t_y
;

435 
	}
}

437 
	$gr_fb_bÏnk
(
boŞ
 
bÏnk
) {

438 
gr_back’d
->
	`BÏnk
(
bÏnk
);

439 
	}
}

441 
	$gr_fb_width_modif›d
()

443  
gr_d¿w
->
row_by‹s
 * 8 / (gr_d¿w->
pix–_by‹s
 * 8);

444 
	}
}

446 
	$gr_fb_width_Üigš®
()

448  
gr_d¿w
->
width
;

449 
	}
}

451 
	$gr_fb_pix–
()

453  
gr_d¿w
->
pix–_by‹s
;

454 
	}
}

456 *
	$gr_fb_d©a
()

458  (*è
gr_d¿w
->
d©a
;

459 
	}
}

	@minui/graphics.h

17 #iâdeà
_GRAPHICS_H_


18 
	#_GRAPHICS_H_


	)

20 
	~"mšui/mšui.h
"

22 şas 
	cMšuiBack’d
 {

23 
	mpublic
:

25 
vœtu®
 
GRSurçû
* 
In™
() = 0;

29 
vœtu®
 
GRSurçû
* 
Fl
() = 0;

32 
vœtu®
 
BÏnk
(
boŞ
) = 0;

35 
	mvœtu®
 ~
	$MšuiBack’d
() {};

36 
	}
};

	@minui/graphics_adf.cpp

17 
	~"g¿phics_adf.h
"

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<sys/mmª.h
>

24 
	~<uni¡d.h
>

26 
	~<adf/adf.h
>

27 
	~<sync/sync.h
>

29 
	~"mšui/mšui.h
"

31 
	gMšuiBack’dAdf
::
	$MšuiBack’dAdf
(è: 
	`štf_fd
(-1), 
	`dev
(), 
	`n_surçûs
(0), 
	$surçûs
(è{
	}
}

33 
	gMšuiBack’dAdf
::
	$SurçûIn™
(cÚ¡ 
drm_mode_modešfo
* 
mode
, 
GRSurçûAdf
* 
surf
) {

34 *
surf
 = {};

35 
surf
->
ãnû_fd
 = -1;

36 
surf
->
fd
 = 
	`adf_š‹rçû_sim¶e_bufãr_®loc
(
štf_fd
, 
mode
->
hdi¥Ïy
, mode->
vdi¥Ïy
, 
fÜm©
,

37 &
surf
->
off£t
, &surf->
p™ch
);

38 ià(
surf
->
fd
 < 0) {

39  
surf
->
fd
;

42 
surf
->
width
 = 
mode
->
hdi¥Ïy
;

43 
surf
->
height
 = 
mode
->
vdi¥Ïy
;

44 
surf
->
row_by‹s
 = surf->
p™ch
;

45 
surf
->
pix–_by‹s
 = (
fÜm©
 =ğ
DRM_FORMAT_RGB565
) ? 2 : 4;

47 
surf
->
d©a
 = 
¡©ic_ÿ¡
<
ušt8_t
*>(

48 
	`mm­
(
nuÎ±r
, 
surf
->
p™ch
 * surf->
height
, 
PROT_WRITE
, 
MAP_SHARED
, surf->
fd
, surf->
off£t
));

49 ià(
surf
->
d©a
 =ğ
MAP_FAILED
) {

50 
§ved_”ºo
 = 
”ºo
;

51 
	`şo£
(
surf
->
fd
);

52  -
§ved_”ºo
;

56 
	}
}

58 
	gMšuiBack’dAdf
::
	$IÁ”çûIn™
() {

59 
adf_š‹rçû_d©a
 
štf_d©a
;

60 
”r
 = 
	`adf_g‘_š‹rçû_d©a
(
štf_fd
, &
štf_d©a
);

61 ià(
”r
 < 0) ƒrr;

63 
»t
 = 0;

64 
”r
 = 
	`SurçûIn™
(&
štf_d©a
.
cu¼’t_mode
, &
surçûs
[0]);

65 ià(
”r
 < 0) {

66 
	`årštf
(
¡d”r
, "®loÿtšg surçû 0 faed: %s\n", 
	`¡»¼Ü
(-
”r
));

67 
»t
 = 
”r
;

68 
dÚe
;

71 
”r
 = 
	`SurçûIn™
(&
štf_d©a
.
cu¼’t_mode
, &
surçûs
[1]);

72 ià(
”r
 < 0) {

73 
	`årštf
(
¡d”r
, "®loÿtšg surçû 1 faed: %s\n", 
	`¡»¼Ü
(-
”r
));

74 
surçûs
[1] = {};

75 
n_surçûs
 = 1;

77 
n_surçûs
 = 2;

80 
dÚe
:

81 
	`adf_ä“_š‹rçû_d©a
(&
štf_d©a
);

82  
»t
;

83 
	}
}

85 
	gMšuiBack’dAdf
::
	$DeviûIn™
(
adf_deviû
* 
dev
) {

86 
adf_id_t
 
štf_id
;

87 
”r
 = 
	`adf_fšd_sim¶e_po¡_cÚfigu¿tiÚ
(
dev
, &
fÜm©
, 1, &
štf_id
, &
’g_id
);

88 ià(
”r
 < 0) ƒrr;

90 
”r
 = 
	`adf_deviû_©ch
(
dev
, 
’g_id
, 
štf_id
);

91 ià(
”r
 < 0 &&ƒ¼ !ğ-
EALREADY
) ƒrr;

93 
štf_fd
 = 
	`adf_š‹rçû_İ’
(
dev
, 
štf_id
, 
O_RDWR
);

94 ià(
štf_fd
 < 0)  intf_fd;

96 
”r
 = 
	`IÁ”çûIn™
();

97 ià(
”r
 < 0) {

98 
	`şo£
(
štf_fd
);

99 
štf_fd
 = -1;

102  
”r
;

103 
	}
}

105 
GRSurçû
* 
	gMšuiBack’dAdf
::
	$In™
() {

106 #ià
	`defšed
(
RECOVERY_ABGR
)

107 
fÜm©
 = 
DRM_FORMAT_ABGR8888
;

108 #–ià
	`defšed
(
RECOVERY_BGRA
)

109 
fÜm©
 = 
DRM_FORMAT_BGRA8888
;

110 #–ià
	`defšed
(
RECOVERY_RGBX
)

111 
fÜm©
 = 
DRM_FORMAT_RGBX8888
;

113 
fÜm©
 = 
DRM_FORMAT_RGB565
;

116 
adf_id_t
* 
dev_ids
 = 
nuÎ±r
;

117 
ssize_t
 
n_dev_ids
 = 
	`adf_deviûs
(&
dev_ids
);

118 ià(
n_dev_ids
 == 0) {

119  
nuÎ±r
;

120 } ià(
n_dev_ids
 < 0) {

121 
	`årštf
(
¡d”r
, "’um”©šg‡dàdeviû çed: %s\n", 
	`¡»¼Ü
(-
n_dev_ids
));

122  
nuÎ±r
;

125 
štf_fd
 = -1;

127 
ssize_t
 
i
 = 0; i < 
n_dev_ids
 && 
štf_fd
 < 0; i++) {

128 
”r
 = 
	`adf_deviû_İ’
(
dev_ids
[
i
], 
O_RDWR
, &
dev
);

129 ià(
”r
 < 0) {

130 
	`årštf
(
¡d”r
, "İ’šg‡dàdeviû %u faed: %s\n", 
dev_ids
[
i
], 
	`¡»¼Ü
(-
”r
));

134 
”r
 = 
	`DeviûIn™
(&
dev
);

135 ià(
”r
 < 0) {

136 
	`årštf
(
¡d”r
, "š™Ÿlizšg‡dàdeviû %u faed: %s\n", 
dev_ids
[
i
], 
	`¡»¼Ü
(-
”r
));

137 
	`adf_deviû_şo£
(&
dev
);

141 
	`ä“
(
dev_ids
);

143 ià(
štf_fd
 < 0è 
nuÎ±r
;

145 
GRSurçû
* 
»t
 = 
	`Fl
();

147 
	`BÏnk
(
Œue
);

148 
	`BÏnk
(
çl£
);

150  
»t
;

151 
	}
}

153 
	gMšuiBack’dAdf
::
	$Sync
(
GRSurçûAdf
* 
surf
) {

154 
cÚ¡ex´
 
w¬nšgTimeout
 = 3000;

156 ià(
surf
 =ğ
nuÎ±r
) ;

158 ià(
surf
->
ãnû_fd
 >= 0) {

159 
”r
 = 
	`sync_wa™
(
surf
->
ãnû_fd
, 
w¬nšgTimeout
);

160 ià(
”r
 < 0) {

161 
	`³¼Ü
("adf sync fence waitƒrror\n");

164 
	`şo£
(
surf
->
ãnû_fd
);

165 
surf
->
ãnû_fd
 = -1;

167 
	}
}

169 
GRSurçû
* 
	gMšuiBack’dAdf
::
	$Fl
() {

170 
GRSurçûAdf
* 
surf
 = &
surçûs
[
cu¼’t_surçû
];

172 
ãnû_fd
 = 
	`adf_š‹rçû_sim¶e_po¡
(
štf_fd
, 
’g_id
, 
surf
->
width
, surf->
height
, 
fÜm©
,

173 
surf
->
fd
, surf->
off£t
, surf->
p™ch
, -1);

174 ià(
ãnû_fd
 >ğ0è
surf
->fence_fd = fence_fd;

176 
cu¼’t_surçû
 = (cu¼’t_surçû + 1è% 
n_surçûs
;

177 
	`Sync
(&
surçûs
[
cu¼’t_surçû
]);

178  &
surçûs
[
cu¼’t_surçû
];

179 
	}
}

181 
	gMšuiBack’dAdf
::
	$BÏnk
(
boŞ
 
bÏnk
) {

182 
	`adf_š‹rçû_bÏnk
(
štf_fd
, 
bÏnk
 ? 
DRM_MODE_DPMS_OFF
 : 
DRM_MODE_DPMS_ON
);

183 
	}
}

185 
	gMšuiBack’dAdf
::
	$SurçûDe¡roy
(
GRSurçûAdf
* 
surf
) {

186 
	`munm­
(
surf
->
d©a
, surf->
p™ch
 * surf->
height
);

187 
	`şo£
(
surf
->
ãnû_fd
);

188 
	`şo£
(
surf
->
fd
);

189 
	}
}

191 
	gMšuiBack’dAdf
::~
	$MšuiBack’dAdf
() {

192 
	`adf_deviû_şo£
(&
dev
);

193 
i
 = 0; i < 
n_surçûs
; i++) {

194 
	`SurçûDe¡roy
(&
surçûs
[
i
]);

196 ià(
štf_fd
 >ğ0è
	`şo£
(intf_fd);

197 
	}
}

	@minui/graphics_adf.h

17 #iâdeà
_GRAPHICS_ADF_H_


18 
	#_GRAPHICS_ADF_H_


	)

20 
	~<adf/adf.h
>

22 
	~"g¿phics.h
"

24 şas 
	cGRSurçûAdf
 : 
public
 
GRSurçû
 {

25 
´iv©e
:

26 
ãnû_fd
;

27 
	mfd
;

28 
__u32
 
	moff£t
;

29 
__u32
 
	mp™ch
;

31 
ä›nd
 
şass
 
	mMšuiBack’dAdf
;

34 şas 
	cMšuiBack’dAdf
 : 
public
 
MšuiBack’d
 {

35 
public
:

36 
GRSurçû
* 
	$In™
(è
ov”ride
;

37 
GRSurçû
* 
	$Fl
(è
ov”ride
;

38 
	$BÏnk
(
boŞ
è
ov”ride
;

39 ~
	$MšuiBack’dAdf
(è
ov”ride
;

40 
	`MšuiBack’dAdf
();

42 
´iv©e
:

43 
	`SurçûIn™
(cÚ¡ 
drm_mode_modešfo
* 
mode
, 
GRSurçûAdf
* 
surf
);

44 
	`IÁ”çûIn™
();

45 
	`DeviûIn™
(
adf_deviû
* 
dev
);

46 
	`SurçûDe¡roy
(
GRSurçûAdf
* 
surf
);

47 
	`Sync
(
GRSurçûAdf
* 
surf
);

49 
štf_fd
;

50 
adf_id_t
 
’g_id
;

51 
__u32
 
fÜm©
;

52 
adf_deviû
 
dev
;

53 
cu¼’t_surçû
;

54 
n_surçûs
;

55 
GRSurçûAdf
 
surçûs
[2];

	@minui/graphics_drm.cpp

17 
	~"g¿phics_drm.h
"

19 
	~<fú.h
>

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<sys/mmª.h
>

23 
	~<sys/ty³s.h
>

24 
	~<uni¡d.h
>

26 
	~<drm_fourcc.h
>

27 
	~<xf86drm.h
>

28 
	~<xf86drmMode.h
>

30 
	~"mšui/mšui.h
"

32 
	#ARRAY_SIZE
(
A
è((A)/(*(A)))

	)

34 
	gMšuiBack’dDrm
::
	$MšuiBack’dDrm
()

35 : 
	`GRSurçûDrms
(), 
	`maš_mÚ™Ü_ütc
(
nuÎ±r
), 
	`maš_mÚ™Ü_cÚÃùÜ
ÒuÎ±r), 
	`drm_fd
(-1è{
	}
}

37 
	gMšuiBack’dDrm
::
	$DrmDi§bËC¹c
(
drm_fd
, 
drmModeC¹c
* 
ütc
) {

38 ià(
ütc
) {

39 
	`drmModeS‘C¹c
(
drm_fd
, 
ütc
->
ütc_id
,

42 
nuÎ±r
,

44 
nuÎ±r
);

46 
	}
}

48 
	gMšuiBack’dDrm
::
	$DrmEÇbËC¹c
(
drm_fd
, 
drmModeC¹c
* 
ütc
, 
GRSurçûDrm
* 
surçû
) {

49 
št32_t
 
»t
 = 
	`drmModeS‘C¹c
(
drm_fd
, 
ütc
->
ütc_id
, 
surçû
->
fb_id
, 0, 0,

50 &
maš_mÚ™Ü_cÚÃùÜ
->
cÚÃùÜ_id
,

52 &
maš_mÚ™Ü_ütc
->
mode
);

54 ià(
»t
) {

55 
	`´štf
("drmModeS‘C¹øçed„‘=%d\n", 
»t
);

57 
	}
}

59 
	gMšuiBack’dDrm
::
	$BÏnk
(
boŞ
 
bÏnk
) {

60 ià(
bÏnk
) {

61 
	`DrmDi§bËC¹c
(
drm_fd
, 
maš_mÚ™Ü_ütc
);

63 
	`DrmEÇbËC¹c
(
drm_fd
, 
maš_mÚ™Ü_ütc
, 
GRSurçûDrms
[
cu¼’t_bufãr
]);

65 
	}
}

67 
	gMšuiBack’dDrm
::
	$DrmDe¡roySurçû
(
GRSurçûDrm
* 
surçû
) {

68 ià(!
surçû
) ;

70 ià(
surçû
->
d©a
) {

71 
	`munm­
(
surçû
->
d©a
, surçû->
row_by‹s
 * surçû->
height
);

74 ià(
surçû
->
fb_id
) {

75 
»t
 = 
	`drmModeRmFB
(
drm_fd
, 
surçû
->
fb_id
);

76 ià(
»t
) {

77 
	`´štf
("drmModeRmFB faed„‘=%d\n", 
»t
);

81 ià(
surçû
->
hªdË
) {

82 
drm_gem_şo£
 
gem_şo£
 = {};

83 
gem_şo£
.
hªdË
 = 
surçû
->handle;

85 
»t
 = 
	`drmIoùl
(
drm_fd
, 
DRM_IOCTL_GEM_CLOSE
, &
gem_şo£
);

86 ià(
»t
) {

87 
	`´štf
("DRM_IOCTL_GEM_CLOSE faed„‘=%d\n", 
»t
);

91 
d–‘e
 
surçû
;

92 
	}
}

94 
	$drm_fÜm©_to_bµ
(
ušt32_t
 
fÜm©
) {

95 
fÜm©
) {

96 
DRM_FORMAT_ABGR8888
:

97 
DRM_FORMAT_BGRA8888
:

98 
DRM_FORMAT_RGBX8888
:

99 
DRM_FORMAT_BGRX8888
:

100 
DRM_FORMAT_XBGR8888
:

101 
DRM_FORMAT_XRGB8888
:

103 
DRM_FORMAT_RGB565
:

106 
	`´štf
("UnknowÀfÜm© %d\n", 
fÜm©
);

109 
	}
}

111 
GRSurçûDrm
* 
	gMšuiBack’dDrm
::
	$DrmC»©eSurçû
(
width
, 
height
) {

112 
GRSurçûDrm
* 
surçû
 = 
Ãw
 GRSurfaceDrm;

113 *
surçû
 = {};

115 
ušt32_t
 
fÜm©
;

116 #ià
	`defšed
(
RECOVERY_ABGR
)

117 
fÜm©
 = 
DRM_FORMAT_RGBA8888
;

118 #–ià
	`defšed
(
RECOVERY_BGRA
)

119 
fÜm©
 = 
DRM_FORMAT_ARGB8888
;

120 #–ià
	`defšed
(
RECOVERY_RGBX
)

121 
fÜm©
 = 
DRM_FORMAT_XBGR8888
;

123 
fÜm©
 = 
DRM_FORMAT_RGB565
;

126 
drm_mode_ü—‹_dumb
 
ü—‹_dumb
 = {};

127 
ü—‹_dumb
.
height
 = height;

128 
ü—‹_dumb
.
width
 = width;

129 
ü—‹_dumb
.
bµ
 = 
	`drm_fÜm©_to_bµ
(
fÜm©
);

130 
ü—‹_dumb
.
æags
 = 0;

132 
»t
 = 
	`drmIoùl
(
drm_fd
, 
DRM_IOCTL_MODE_CREATE_DUMB
, &
ü—‹_dumb
);

133 ià(
»t
) {

134 
	`´štf
("DRM_IOCTL_MODE_CREATE_DUMB faed„‘=%d\n", 
»t
);

135 
	`DrmDe¡roySurçû
(
surçû
);

136  
nuÎ±r
;

138 
surçû
->
hªdË
 = 
ü—‹_dumb
.handle;

140 
ušt32_t
 
hªdËs
[4], 
p™ches
[4], 
off£ts
[4];

142 
hªdËs
[0] = 
surçû
->
hªdË
;

143 
p™ches
[0] = 
ü—‹_dumb
.
p™ch
;

144 
off£ts
[0] = 0;

146 
»t
 =

147 
	`drmModeAddFB2
(
drm_fd
, 
width
, 
height
, 
fÜm©
, 
hªdËs
, 
p™ches
, 
off£ts
, &(
surçû
->
fb_id
), 0);

148 ià(
»t
) {

149 
	`´štf
("drmModeAddFB2 faed„‘=%d\n", 
»t
);

150 
	`DrmDe¡roySurçû
(
surçû
);

151  
nuÎ±r
;

154 
drm_mode_m­_dumb
 
m­_dumb
 = {};

155 
m­_dumb
.
hªdË
 = 
ü—‹_dumb
.handle;

156 
»t
 = 
	`drmIoùl
(
drm_fd
, 
DRM_IOCTL_MODE_MAP_DUMB
, &
m­_dumb
);

157 ià(
»t
) {

158 
	`´štf
("DRM_IOCTL_MODE_MAP_DUMB faed„‘=%d\n", 
»t
);

159 
	`DrmDe¡roySurçû
(
surçû
);

160  
nuÎ±r
;

163 
surçû
->
height
 = height;

164 
surçû
->
width
 = width;

165 
surçû
->
row_by‹s
 = 
ü—‹_dumb
.
p™ch
;

166 
surçû
->
pix–_by‹s
 = 
ü—‹_dumb
.
bµ
 / 8;

167 
surçû
->
d©a
 = 
¡©ic_ÿ¡
<*>(
	`mm­
(
nuÎ±r
, surçû->
height
 * surçû->
row_by‹s
,

168 
PROT_READ
 | 
PROT_WRITE
, 
MAP_SHARED
, 
drm_fd
,

169 
m­_dumb
.
off£t
));

170 ià(
surçû
->
d©a
 =ğ
MAP_FAILED
) {

171 
	`³¼Ü
("mmap() failed");

172 
	`DrmDe¡roySurçû
(
surçû
);

173  
nuÎ±r
;

176  
surçû
;

177 
	}
}

179 
drmModeC¹c
* 
	$fšd_ütc_fÜ_cÚÃùÜ
(
fd
, 
drmModeRes
* 
»sourûs
,

180 
drmModeCÚÃùÜ
* 
cÚÃùÜ
) {

182 
drmModeEncod”
* 
’cod”
;

183 ià(
cÚÃùÜ
->
’cod”_id
) {

184 
’cod”
 = 
	`drmModeG‘Encod”
(
fd
, 
cÚÃùÜ
->
’cod”_id
);

186 
’cod”
 = 
nuÎ±r
;

189 
št32_t
 
ütc
;

190 ià(
’cod”
 &&ƒncod”->
ütc_id
) {

191 
ütc
 = 
’cod”
->
ütc_id
;

192 
	`drmModeF»eEncod”
(
’cod”
);

193  
	`drmModeG‘C¹c
(
fd
, 
ütc
);

197 
ütc
 = -1;

198 
i
 = 0; i < 
cÚÃùÜ
->
couÁ_’cod”s
; i++) {

199 
’cod”
 = 
	`drmModeG‘Encod”
(
fd
, 
cÚÃùÜ
->
’cod”s
[
i
]);

201 ià(
’cod”
) {

202 
j
 = 0; j < 
»sourûs
->
couÁ_ütcs
; j++) {

203 ià(!(
’cod”
->
possibË_ütcs
 & (1 << 
j
))) ;

204 
ütc
 = 
»sourûs
->
ütcs
[
j
];

207 ià(
ütc
 >= 0) {

208 
	`drmModeF»eEncod”
(
’cod”
);

209  
	`drmModeG‘C¹c
(
fd
, 
ütc
);

214  
nuÎ±r
;

215 
	}
}

217 
drmModeCÚÃùÜ
* 
	$fšd_u£d_cÚÃùÜ_by_ty³
(
fd
, 
drmModeRes
* 
»sourûs
, 
ty³
) {

218 
i
 = 0; i < 
»sourûs
->
couÁ_cÚÃùÜs
; i++) {

219 
drmModeCÚÃùÜ
* 
cÚÃùÜ
 = 
	`drmModeG‘CÚÃùÜ
(
fd
, 
»sourûs
->
cÚÃùÜs
[
i
]);

220 ià(
cÚÃùÜ
) {

221 ià((
cÚÃùÜ
->
cÚÃùÜ_ty³
 =ğ
ty³
è&& (cÚÃùÜ->
cÚÃùiÚ
 =ğ
DRM_MODE_CONNECTED
) &&

222 (
cÚÃùÜ
->
couÁ_modes
 > 0)) {

223  
cÚÃùÜ
;

225 
	`drmModeF»eCÚÃùÜ
(
cÚÃùÜ
);

228  
nuÎ±r
;

229 
	}
}

231 
drmModeCÚÃùÜ
* 
	$fšd_fœ¡_cÚÃùed_cÚÃùÜ
(
fd
, 
drmModeRes
* 
»sourûs
) {

232 
i
 = 0; i < 
»sourûs
->
couÁ_cÚÃùÜs
; i++) {

233 
drmModeCÚÃùÜ
* 
cÚÃùÜ
;

235 
cÚÃùÜ
 = 
	`drmModeG‘CÚÃùÜ
(
fd
, 
»sourûs
->
cÚÃùÜs
[
i
]);

236 ià(
cÚÃùÜ
) {

237 ià((
cÚÃùÜ
->
couÁ_modes
 > 0è&& (cÚÃùÜ->
cÚÃùiÚ
 =ğ
DRM_MODE_CONNECTED
))

238  
cÚÃùÜ
;

240 
	`drmModeF»eCÚÃùÜ
(
cÚÃùÜ
);

243  
nuÎ±r
;

244 
	}
}

246 
drmModeCÚÃùÜ
* 
	gMšuiBack’dDrm
::
	$FšdMašMÚ™Ü
(
fd
, 
drmModeRes
* 
»sourûs
,

247 
ušt32_t
* 
mode_šdex
) {

249 
cÚ¡ex´
 
kCÚÃùÜPriÜ™y
[] = {

250 
DRM_MODE_CONNECTOR_LVDS
,

251 
DRM_MODE_CONNECTOR_eDP
,

252 
DRM_MODE_CONNECTOR_DSI
,

255 
drmModeCÚÃùÜ
* 
maš_mÚ™Ü_cÚÃùÜ
 = 
nuÎ±r
;

256 
i
 = 0;

258 
maš_mÚ™Ü_cÚÃùÜ
 = 
	`fšd_u£d_cÚÃùÜ_by_ty³
(
fd
, 
»sourûs
, 
kCÚÃùÜPriÜ™y
[
i
]);

259 
i
++;

260 } !
maš_mÚ™Ü_cÚÃùÜ
 && 
i
 < 
	`ARRAY_SIZE
(
kCÚÃùÜPriÜ™y
));

263 ià(!
maš_mÚ™Ü_cÚÃùÜ
) {

264 
maš_mÚ™Ü_cÚÃùÜ
 = 
	`fšd_fœ¡_cÚÃùed_cÚÃùÜ
(
fd
, 
»sourûs
);

268 ià(!
maš_mÚ™Ü_cÚÃùÜ
è 
nuÎ±r
;

270 *
mode_šdex
 = 0;

271 
modes
 = 0; mode < 
maš_mÚ™Ü_cÚÃùÜ
->
couÁ_modes
; modes++) {

272 ià(
maš_mÚ™Ü_cÚÃùÜ
->
modes
[modes].
ty³
 & 
DRM_MODE_TYPE_PREFERRED
) {

273 *
mode_šdex
 = 
modes
;

278  
maš_mÚ™Ü_cÚÃùÜ
;

279 
	}
}

281 
	gMšuiBack’dDrm
::
	$Di§bËNÚMašC¹cs
(
fd
, 
drmModeRes
* 
»sourûs
, 
drmModeC¹c
* 
maš_ütc
) {

282 
i
 = 0; i < 
»sourûs
->
couÁ_cÚÃùÜs
; i++) {

283 
drmModeCÚÃùÜ
* 
cÚÃùÜ
 = 
	`drmModeG‘CÚÃùÜ
(
fd
, 
»sourûs
->
cÚÃùÜs
[
i
]);

284 
drmModeC¹c
* 
ütc
 = 
	`fšd_ütc_fÜ_cÚÃùÜ
(
fd
, 
»sourûs
, 
cÚÃùÜ
);

285 ià(
ütc
->
ütc_id
 !ğ
maš_ütc
->crtc_id) {

286 
	`DrmDi§bËC¹c
(
fd
, 
ütc
);

288 
	`drmModeF»eC¹c
(
ütc
);

290 
	}
}

292 
GRSurçû
* 
	gMšuiBack’dDrm
::
	$In™
() {

293 
drmModeRes
* 
»s
 = 
nuÎ±r
;

295 
	`³¼Ü
("zzytest MinuiBackendDrm::Init\n");

297 
i
 = 0; i < 
DRM_MAX_MINOR
; i++) {

298 * 
dev_Çme
;

299 
»t
 = 
	`a¥rštf
(&
dev_Çme
, 
DRM_DEV_NAME
, 
DRM_DIR_NAME
, 
i
);

300 ià(
»t
 < 0) ;

302 
	`³¼Ü
("dev_Çme=%s\n", 
dev_Çme
);

303 
drm_fd
 = 
	`İ’
(
dev_Çme
, 
O_RDWR
, 0);

304 
	`ä“
(
dev_Çme
);

305 ià(
drm_fd
 < 0) ;

307 
ušt64_t
 
ÿp
 = 0;

309 
»t
 = 
	`drmG‘C­
(
drm_fd
, 
DRM_CAP_DUMB_BUFFER
, &
ÿp
);

310 ià(
»t
 || 
ÿp
 == 0) {

311 
	`şo£
(
drm_fd
);

315 
»s
 = 
	`drmModeG‘Resourûs
(
drm_fd
);

316 ià(!
»s
) {

317 
	`şo£
(
drm_fd
);

322 ià(
»s
->
couÁ_ütcs
 > 0 &&„es->
couÁ_cÚÃùÜs
 > 0) {

323 ià(
	`fšd_fœ¡_cÚÃùed_cÚÃùÜ
(
drm_fd
, 
»s
)) ;

326 
	`drmModeF»eResourûs
(
»s
);

327 
	`şo£
(
drm_fd
);

328 
»s
 = 
nuÎ±r
;

331 ià(
drm_fd
 < 0 || 
»s
 =ğ
nuÎ±r
) {

332 
	`³¼Ü
("cannot find/open‡ drm device");

333  
nuÎ±r
;

336 
ušt32_t
 
£Ëùed_mode
;

337 
maš_mÚ™Ü_cÚÃùÜ
 = 
	`FšdMašMÚ™Ü
(
drm_fd
, 
»s
, &
£Ëùed_mode
);

339 ià(!
maš_mÚ™Ü_cÚÃùÜ
) {

340 
	`´štf
("main_monitor_connector‚ot found\n");

341 
	`drmModeF»eResourûs
(
»s
);

342 
	`şo£
(
drm_fd
);

343  
nuÎ±r
;

346 
maš_mÚ™Ü_ütc
 = 
	`fšd_ütc_fÜ_cÚÃùÜ
(
drm_fd
, 
»s
, 
maš_mÚ™Ü_cÚÃùÜ
);

348 ià(!
maš_mÚ™Ü_ütc
) {

349 
	`´štf
("main_monitor_crtc‚ot found\n");

350 
	`drmModeF»eResourûs
(
»s
);

351 
	`şo£
(
drm_fd
);

352  
nuÎ±r
;

355 
	`Di§bËNÚMašC¹cs
(
drm_fd
, 
»s
, 
maš_mÚ™Ü_ütc
);

357 
maš_mÚ™Ü_ütc
->
mode
 = 
maš_mÚ™Ü_cÚÃùÜ
->
modes
[
£Ëùed_mode
];

359 
width
 = 
maš_mÚ™Ü_ütc
->
mode
.
hdi¥Ïy
;

360 
height
 = 
maš_mÚ™Ü_ütc
->
mode
.
vdi¥Ïy
;

362 
	`drmModeF»eResourûs
(
»s
);

364 
GRSurçûDrms
[0] = 
	`DrmC»©eSurçû
(
width
, 
height
);

365 
GRSurçûDrms
[1] = 
	`DrmC»©eSurçû
(
width
, 
height
);

366 ià(!
GRSurçûDrms
[0] || !GRSurfaceDrms[1]) {

368  
nuÎ±r
;

371 
cu¼’t_bufãr
 = 0;

373 
	`DrmEÇbËC¹c
(
drm_fd
, 
maš_mÚ™Ü_ütc
, 
GRSurçûDrms
[1]);

375  
GRSurçûDrms
[0];

376 
	}
}

378 
GRSurçû
* 
	gMšuiBack’dDrm
::
	$Fl
() {

379 
»t
 = 
	`drmModePageFl
(
drm_fd
, 
maš_mÚ™Ü_ütc
->
ütc_id
,

380 
GRSurçûDrms
[
cu¼’t_bufãr
]->
fb_id
, 0, 
nuÎ±r
);

381 ià(
»t
 < 0) {

382 
	`´štf
("drmModePageFl faed„‘=%d\n", 
»t
);

383  
nuÎ±r
;

385 
cu¼’t_bufãr
 = 1 - current_buffer;

386  
GRSurçûDrms
[
cu¼’t_bufãr
];

387 
	}
}

389 
	gMšuiBack’dDrm
::~
	$MšuiBack’dDrm
() {

390 
	`DrmDi§bËC¹c
(
drm_fd
, 
maš_mÚ™Ü_ütc
);

391 
	`DrmDe¡roySurçû
(
GRSurçûDrms
[0]);

392 
	`DrmDe¡roySurçû
(
GRSurçûDrms
[1]);

393 
	`drmModeF»eC¹c
(
maš_mÚ™Ü_ütc
);

394 
	`drmModeF»eCÚÃùÜ
(
maš_mÚ™Ü_cÚÃùÜ
);

395 
	`şo£
(
drm_fd
);

396 
drm_fd
 = -1;

397 
	}
}

	@minui/graphics_drm.h

17 #iâdeà
_GRAPHICS_DRM_H_


18 
	#_GRAPHICS_DRM_H_


	)

20 
	~<¡dšt.h
>

22 
	~<xf86drmMode.h
>

24 
	~"g¿phics.h
"

25 
	~"mšui/mšui.h
"

27 şas 
	cGRSurçûDrm
 : 
public
 
GRSurçû
 {

28 
´iv©e
:

29 
ušt32_t
 
fb_id
;

30 
ušt32_t
 
	mhªdË
;

32 
ä›nd
 
şass
 
	mMšuiBack’dDrm
;

35 şas 
	cMšuiBack’dDrm
 : 
public
 
MšuiBack’d
 {

36 
public
:

37 
GRSurçû
* 
	$In™
(è
ov”ride
;

38 
GRSurçû
* 
	$Fl
(è
ov”ride
;

39 
	$BÏnk
(
boŞ
è
ov”ride
;

40 ~
	$MšuiBack’dDrm
(è
ov”ride
;

41 
	`MšuiBack’dDrm
();

43 
´iv©e
:

44 
	`DrmDi§bËC¹c
(
drm_fd
, 
drmModeC¹c
* 
ütc
);

45 
	`DrmEÇbËC¹c
(
drm_fd
, 
drmModeC¹c
* 
ütc
, 
GRSurçûDrm
* 
surçû
);

46 
GRSurçûDrm
* 
	`DrmC»©eSurçû
(
width
, 
height
);

47 
	`DrmDe¡roySurçû
(
GRSurçûDrm
* 
surçû
);

48 
	`Di§bËNÚMašC¹cs
(
fd
, 
drmModeRes
* 
»sourûs
, 
drmModeC¹c
* 
maš_ütc
);

49 
drmModeCÚÃùÜ
* 
	`FšdMašMÚ™Ü
(
fd
, 
drmModeRes
* 
»sourûs
, 
ušt32_t
* 
mode_šdex
);

51 
GRSurçûDrm
* 
GRSurçûDrms
[2];

52 
cu¼’t_bufãr
;

53 
drmModeC¹c
* 
maš_mÚ™Ü_ütc
;

54 
drmModeCÚÃùÜ
* 
maš_mÚ™Ü_cÚÃùÜ
;

55 
drm_fd
;

	@minui/graphics_fbdev.cpp

17 
	~"g¿phics_fbdev.h
"

19 
	~<fú.h
>

20 
	~<lšux/fb.h
>

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<sys/ioùl.h
>

25 
	~<sys/mmª.h
>

26 
	~<sys/ty³s.h
>

27 
	~<uni¡d.h
>

29 
	~"mšui/mšui.h
"

31 
	gMšuiBack’dFbdev
::
	$MšuiBack’dFbdev
(è: 
	`gr_d¿w
(
nuÎ±r
), 
	`fb_fd
(-1è{
	}
}

33 
	gMšuiBack’dFbdev
::
	$BÏnk
(
boŞ
 
bÏnk
) {

34 
»t
 = 
	`ioùl
(
fb_fd
, 
FBIOBLANK
, 
bÏnk
 ? 
FB_BLANK_POWERDOWN
 : 
FB_BLANK_UNBLANK
);

35 ià(
»t
 < 0è
	`³¼Ü
("ioctl(): blank");

36 
	}
}

38 
	gMšuiBack’dFbdev
::
	$S‘Di¥ÏyedF¿mebufãr
(
n
) {

39 ià(
n
 > 1 || !
doubË_bufã»d
) ;

41 
vi
.
y»s_vœtu®
 = 
gr_äamebufãr
[0].
height
 * 2;

42 
vi
.
yoff£t
 = 
n
 * 
gr_äamebufãr
[0].
height
;

43 
vi
.
b™s_³r_pix–
 = 
gr_äamebufãr
[0].
pix–_by‹s
 * 8;

44 ià(
	`ioùl
(
fb_fd
, 
FBIOPUT_VSCREENINFO
, &
vi
) < 0) {

45 
	`³¼Ü
("active fb swap failed");

47 
di¥Ïyed_bufãr
 = 
n
;

48 
	}
}

50 
GRSurçû
* 
	gMšuiBack’dFbdev
::
	$In™
() {

51 
fd
 = 
	`İ’
("/dev/g¿phics/fb0", 
O_RDWR
);

52 ià(
fd
 == -1) {

53 
	`³¼Ü
("cannot open fb0");

54  
nuÎ±r
;

57 
fb_fix_sü“nšfo
 
fi
;

58 ià(
	`ioùl
(
fd
, 
FBIOGET_FSCREENINFO
, &
fi
) < 0) {

59 
	`³¼Ü
("failedo get fb0 info");

60 
	`şo£
(
fd
);

61  
nuÎ±r
;

64 ià(
	`ioùl
(
fd
, 
FBIOGET_VSCREENINFO
, &
vi
) < 0) {

65 
	`³¼Ü
("failedo get fb0 info");

66 
	`şo£
(
fd
);

67  
nuÎ±r
;

81 
	`´štf
(

87 
vi
.
b™s_³r_pix–
, vi.
»d
.
off£t
, vi.»d.
Ëngth
, vi.
g»’
.offset, vi.green.length,

88 
vi
.
blue
.
off£t
, vi.blue.
Ëngth
);

90 * 
b™s
 = 
	`mm­
(0, 
fi
.
smem_Ën
, 
PROT_READ
 | 
PROT_WRITE
, 
MAP_SHARED
, 
fd
, 0);

91 ià(
b™s
 =ğ
MAP_FAILED
) {

92 
	`³¼Ü
("failedo mmap framebuffer");

93 
	`şo£
(
fd
);

94  
nuÎ±r
;

97 
	`mem£t
(
b™s
, 0, 
fi
.
smem_Ën
);

99 
gr_äamebufãr
[0].
width
 = 
vi
.
x»s
;

100 
gr_äamebufãr
[0].
height
 = 
vi
.
y»s
;

101 
gr_äamebufãr
[0].
row_by‹s
 = 
fi
.
lše_Ëngth
;

102 
gr_äamebufãr
[0].
pix–_by‹s
 = 
vi
.
b™s_³r_pix–
 / 8;

103 
gr_äamebufãr
[0].
d©a
 = 
¡©ic_ÿ¡
<
ušt8_t
*>(
b™s
);

104 
	`mem£t
(
gr_äamebufãr
[0].
d©a
, 0, gr_äamebufãr[0].
height
 * gr_äamebufãr[0].
row_by‹s
);

107 ià(
vi
.
y»s
 * 
fi
.
lše_Ëngth
 * 2 <ğfi.
smem_Ën
) {

108 
doubË_bufã»d
 = 
Œue
;

110 
	`memıy
(
gr_äamebufãr
 + 1, gr_äamebufãr, (
GRSurçû
));

111 
gr_äamebufãr
[1].
d©a
 =

112 
gr_äamebufãr
[0].
d©a
 + gr_äamebufãr[0].
height
 * gr_äamebufãr[0].
row_by‹s
;

114 
gr_d¿w
 = 
gr_äamebufãr
 + 1;

117 
doubË_bufã»d
 = 
çl£
;

123 
gr_d¿w
 = 
¡©ic_ÿ¡
<
GRSurçû
*>(
	`m®loc
((GRSurface)));

124 
	`memıy
(
gr_d¿w
, 
gr_äamebufãr
, (
GRSurçû
));

125 
gr_d¿w
->
d©a
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(gr_d¿w->
height
 * gr_d¿w->
row_by‹s
));

126 ià(!
gr_d¿w
->
d©a
) {

127 
	`³¼Ü
("failedo‡llocate in-memory surface");

128  
nuÎ±r
;

132 
	`mem£t
(
gr_d¿w
->
d©a
, 0, gr_d¿w->
height
 * gr_d¿w->
row_by‹s
);

133 
fb_fd
 = 
fd
;

134 
	`S‘Di¥ÏyedF¿mebufãr
(0);

136 
	`´štf
("äamebufãr: %d (%d x %d)\n", 
fb_fd
, 
gr_d¿w
->
width
, gr_d¿w->
height
);

138 
	`BÏnk
(
Œue
);

139 
	`BÏnk
(
çl£
);

141  
gr_d¿w
;

142 
	}
}

144 
GRSurçû
* 
	gMšuiBack’dFbdev
::
	$Fl
() {

145 ià(
doubË_bufã»d
) {

149 
gr_d¿w
 = 
gr_äamebufãr
 + 
di¥Ïyed_bufãr
;

150 
	`S‘Di¥ÏyedF¿mebufãr
(1 - 
di¥Ïyed_bufãr
);

153 
	`memıy
(
gr_äamebufãr
[0].
d©a
, 
gr_d¿w
->d©a, gr_d¿w->
height
 * gr_d¿w->
row_by‹s
);

155  
gr_d¿w
;

156 
	}
}

158 
	gMšuiBack’dFbdev
::~
	$MšuiBack’dFbdev
() {

159 
	`şo£
(
fb_fd
);

160 
fb_fd
 = -1;

162 ià(!
doubË_bufã»d
 && 
gr_d¿w
) {

163 
	`ä“
(
gr_d¿w
->
d©a
);

164 
	`ä“
(
gr_d¿w
);

166 
gr_d¿w
 = 
nuÎ±r
;

167 
	}
}

	@minui/graphics_fbdev.h

17 #iâdeà
_GRAPHICS_FBDEV_H_


18 
	#_GRAPHICS_FBDEV_H_


	)

20 
	~<lšux/fb.h
>

22 
	~"g¿phics.h
"

23 
	~"mšui/mšui.h
"

25 şas 
	cMšuiBack’dFbdev
 : 
public
 
MšuiBack’d
 {

26 
public
:

27 
GRSurçû
* 
	$In™
(è
ov”ride
;

28 
GRSurçû
* 
	$Fl
(è
ov”ride
;

29 
	$BÏnk
(
boŞ
è
ov”ride
;

30 ~
	$MšuiBack’dFbdev
(è
ov”ride
;

31 
	`MšuiBack’dFbdev
();

33 
´iv©e
:

34 
	`S‘Di¥ÏyedF¿mebufãr
(
n
);

36 
GRSurçû
 
gr_äamebufãr
[2];

37 
boŞ
 
doubË_bufã»d
;

38 
GRSurçû
* 
gr_d¿w
;

39 
di¥Ïyed_bufãr
;

40 
fb_v¬_sü“nšfo
 
vi
;

41 
fb_fd
;

	@minui/include/minui/minui.h

17 #iâdeà
_MINUI_H_


18 
	#_MINUI_H_


	)

20 
	~<sys/ty³s.h
>

22 
	~<funùiÚ®
>

23 
	~<¡ršg
>

29 
	sGRSurçû
 {

30 
	mwidth
;

31 
	mheight
;

32 
	mrow_by‹s
;

33 
	mpix–_by‹s
;

34 * 
	md©a
;

37 
	sGRFÚt
 {

38 
GRSurçû
* 
	m‹xtu»
;

39 
	mch¬_width
;

40 
	mch¬_height
;

44 
gr_fb_width_modif›d
();

45 
gr_fb_width_Üigš®
();

46 
gr_fb_pix–
();

47 *
gr_fb_d©a
();

50 
gr_š™
();

51 
gr_ex™
();

53 
gr_fb_width
();

54 
gr_fb_height
();

56 
gr_æ
();

57 
gr_fb_bÏnk
(
boŞ
 
bÏnk
);

59 
gr_ş—r
();

60 
gr_cŞÜ
(
r
, 
g
, 
b
, 
a
);

61 
gr_fl
(
x1
, 
y1
, 
x2
, 
y2
);

63 
htc_gr_‹xt
(
x
, 
y
, cÚ¡ *
s
, 
boŞ
 
bŞd
);

64 
gr_‹xticÚ
(
x
, 
y
, 
GRSurçû
* 
icÚ
);

66 cÚ¡ 
GRFÚt
* 
gr_sys_fÚt
();

67 
gr_š™_fÚt
(cÚ¡ * 
Çme
, 
GRFÚt
** 
de¡
);

68 
gr_‹xt
(cÚ¡ 
GRFÚt
* 
fÚt
, 
x
, 
y
, cÚ¡ *
s
, 
boŞ
 
bŞd
);

69 
gr_m—su»
(cÚ¡ 
GRFÚt
* 
fÚt
, cÚ¡ *
s
);

70 
gr_fÚt_size
(cÚ¡ 
GRFÚt
* 
fÚt
, *
x
, *
y
);

71 
htc_gr_fÚt_size
(*
x
, *
y
);

73 
gr_bl™
(
GRSurçû
* 
sourû
, 
sx
, 
sy
, 
w
, 
h
, 
dx
, 
dy
);

74 
gr_g‘_width
(
GRSurçû
* 
surçû
);

75 
gr_g‘_height
(
GRSurçû
* 
surçû
);

81 
	gšput_ev’t
;

83 
usšg
 
	gev_ÿÎback
 = 
¡d
::
funùiÚ
<(
fd
, 
ušt32_t
 
	g•ev’ts
)>;

84 
usšg
 
	gev_£t_key_ÿÎback
 = 
¡d
::
funùiÚ
<(
code
, 
	gv®ue
)>;

86 
ev_š™
(
ev_ÿÎback
 
šput_cb
);

87 
ev_ex™
();

88 
ev_add_fd
(
fd
, 
ev_ÿÎback
 
cb
);

89 
ev_™”©e_avaabË_keys
(cÚ¡ 
¡d
::
funùiÚ
<()>& 
f
);

90 
ev_sync_key_¡©e
(cÚ¡ 
ev_£t_key_ÿÎback
& 
£t_key_cb
);

96 
ev_wa™
(
timeout
);

98 
ev_g‘_šput
(
fd
, 
ušt32_t
 
•ev’ts
, 
šput_ev’t
* 
ev
);

99 
ev_di¥©ch
();

100 
ev_g‘_•Şlfd
();

106 
boŞ
 
m©ches_loÿË
(cÚ¡ 
¡d
::
¡ršg
& 
´efix
, cÚ¡ std::¡ršg& 
loÿË
);

119 
»s_ü—‹_di¥Ïy_surçû
(cÚ¡ * 
Çme
, 
GRSurçû
** 
pSurçû
);

125 
»s_ü—‹_muÉi_di¥Ïy_surçû
(cÚ¡ * 
Çme
, * 
äames
,

126 * 
ås
, 
GRSurçû
*** 
pSurçû
);

129 
»s_ü—‹_®pha_surçû
(cÚ¡ * 
Çme
, 
GRSurçû
** 
pSurçû
);

137 
»s_ü—‹_loÿlized_®pha_surçû
(cÚ¡ * 
Çme
, cÚ¡ * 
loÿË
,

138 
GRSurçû
** 
pSurçû
);

142 
»s_ä“_surçû
(
GRSurçû
* 
surçû
);

	@minui/mkfont.c

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

4 
	$maš
(
¬gc
, *
¬gv
)

6 
n
;

7 *
x
;

8 
m
;

9 
run_v®
;

10 
run_couÁ
;

12 
n
 = 
gimp_image
.
width
 * gimp_image.
height
;

13 
m
 = 0;

14 
x
 = 
gimp_image
.
pix–_d©a
;

16 
	`´štf
("struct {\n");

17 
	`´štf
(" unsigned width;\n");

18 
	`´štf
(" unsigned height;\n");

19 
	`´štf
(" unsigned char_width;\n");

20 
	`´štf
(" unsigned char_height;\n");

21 
	`´štf
(" unsigned char„undata[];\n");

22 
	`´štf
("} font = {\n");

23 
	`´štf
(" .width = %d,\À .heighˆğ%d,\À .ch¬_width = %d,\À .ch¬_heighˆğ%d,\n", 
gimp_image
.
width
, gimp_image.
height
,

24 
gimp_image
.
width
 / 96, gimp_image.
height
);

25 
	`´štf
(" .rundata = {\n");

27 
run_v®
 = (*
x
 ? 0 : 255);

28 
run_couÁ
 = 1;

29 
n
--;

30 
x
+=3;

32 
n
-- > 0) {

33 
v®
 = (*
x
 ? 0 : 255);

34 
x
+=3;

35 if((
v®
 =ğ
run_v®
è&& (
run_couÁ
 < 127)) {

36 
run_couÁ
++;

38 
ejeù
:

39 
	`´štf
("0x%02x,",
run_couÁ
 | (
run_v®
 ? 0x80 : 0x00));

40 
run_v®
 = 
v®
;

41 
run_couÁ
 = 1;

42 
m
 += 5;

43 if(
m
 >= 75) {

44 
	`´štf
("\n");

45 
m
 = 0;

49 
	`´štf
("0x%02x,",
run_couÁ
 | (
run_v®
 ? 0x80 : 0x00));

50 
	`´štf
("\n0x00,");

51 
	`´štf
("\n");

52 
	`´štf
(" }\n};\n");

54 
	}
}

	@minui/resources.cpp

17 
	~<fú.h
>

18 
	~<lšux/fb.h
>

19 
	~<lšux/kd.h
>

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<sys/ioùl.h
>

24 
	~<sys/mmª.h
>

25 
	~<sys/ty³s.h
>

26 
	~<uni¡d.h
>

28 
	~<»gex
>

29 
	~<¡ršg
>

30 
	~<veùÜ
>

32 
	~<ªdroid-ba£/¡ršgs.h
>

33 
	~<²g.h
>

35 
	~"mšui/mšui.h
"

37 
	#SURFACE_DATA_ALIGNMENT
 8

	)

39 
GRSurçû
* 
	$m®loc_surçû
(
size_t
 
d©a_size
) {

40 
size_t
 
size
 = (
GRSurçû
è+ 
d©a_size
 + 
SURFACE_DATA_ALIGNMENT
;

41 * 
‹mp
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
size
));

42 ià(
‹mp
 =ğ
NULL
)  NULL;

43 
GRSurçû
* 
surçû
 = 
»š‹½»t_ÿ¡
<GRSurçû*>(
‹mp
);

44 
surçû
->
d©a
 = 
‹mp
 + (
GRSurçû
) +

45 (
SURFACE_DATA_ALIGNMENT
 - ((
GRSurçû
) % SURFACE_DATA_ALIGNMENT));

46  
surçû
;

47 
	}
}

49 
	$İ’_²g
(cÚ¡ * 
Çme
, 
²g_¡ruùp
* 
²g_±r
, 
²g_šfİ
* 
šfo_±r
,

50 
²g_ušt_32
* 
width
,…ng_ušt_32* 
height
, 
²g_by‹
* 
chªÃls
) {

51 
»sP©h
[256];

52 
h—d”
[8];

53 
»suÉ
 = 0;

54 
cŞÜ_ty³
, 
b™_d•th
;

55 
size_t
 
by‹sR—d
;

57 
	`¢´štf
(
»sP©h
, ÔesP©h)-1, "/»s/images/%s.²g", 
Çme
);

58 
»sP©h
[(resPath)-1] = '\0';

59 
FILE
* 
å
 = 
	`fİ’
(
»sP©h
, "rb");

60 ià(
å
 =ğ
NULL
) {

61 
»suÉ
 = -1;

62 
ex™
;

65 
by‹sR—d
 = 
	`ä—d
(
h—d”
, 1, (h—d”), 
å
);

66 ià(
by‹sR—d
 !ğ(
h—d”
)) {

67 
»suÉ
 = -2;

68 
ex™
;

71 ià(
	`²g_sig_cmp
(
h—d”
, 0, (header))) {

72 
»suÉ
 = -3;

73 
ex™
;

76 *
²g_±r
 = 
	`²g_ü—‹_»ad_¡ruù
(
PNG_LIBPNG_VER_STRING
, 
NULL
, NULL, NULL);

77 ià(!*
²g_±r
) {

78 
»suÉ
 = -4;

79 
ex™
;

82 *
šfo_±r
 = 
	`²g_ü—‹_šfo_¡ruù
(*
²g_±r
);

83 ià(!*
šfo_±r
) {

84 
»suÉ
 = -5;

85 
ex™
;

88 ià(
	`£tjmp
(
	`²g_jmpbuf
(*
²g_±r
))) {

89 
»suÉ
 = -6;

90 
ex™
;

93 
	`²g_š™_io
(*
²g_±r
, 
å
);

94 
	`²g_£t_sig_by‹s
(*
²g_±r
, (
h—d”
));

95 
	`²g_»ad_šfo
(*
²g_±r
, *
šfo_±r
);

97 
	`²g_g‘_IHDR
(*
²g_±r
, *
šfo_±r
, 
width
, 
height
, &
b™_d•th
,

98 &
cŞÜ_ty³
, 
NULL
, NULL, NULL);

100 *
chªÃls
 = 
	`²g_g‘_chªÃls
(*
²g_±r
, *
šfo_±r
);

102 ià(
b™_d•th
 =ğ8 && *
chªÃls
 =ğ3 && 
cŞÜ_ty³
 =ğ
PNG_COLOR_TYPE_RGB
) {

104 } ià(
b™_d•th
 <ğ8 && *
chªÃls
 =ğ1 && 
cŞÜ_ty³
 =ğ
PNG_COLOR_TYPE_GRAY
) {

106 
	`²g_£t_ex·nd_g¿y_1_2_4_to_8
(*
²g_±r
);

107 } ià(
b™_d•th
 <ğ8 && *
chªÃls
 =ğ1 && 
cŞÜ_ty³
 =ğ
PNG_COLOR_TYPE_PALETTE
) {

112 
	`²g_£t_·Ë‰e_to_rgb
(*
²g_±r
);

113 *
chªÃls
 = 3;

115 
	`årštf
(
¡d”r
, "minui doesn't support PNG depth %d channels %d color_type %d\n",

116 
b™_d•th
, *
chªÃls
, 
cŞÜ_ty³
);

117 
»suÉ
 = -7;

118 
ex™
;

121  
»suÉ
;

123 
ex™
:

124 ià(
»suÉ
 < 0) {

125 
	`²g_de¡roy_»ad_¡ruù
(
²g_±r
, 
šfo_±r
, 
NULL
);

127 ià(
å
 !ğ
NULL
) {

128 
	`fşo£
(
å
);

131  
»suÉ
;

132 
	}
}

143 
GRSurçû
* 
	$š™_di¥Ïy_surçû
(
²g_ušt_32
 
width
,…ng_ušt_32 
height
) {

144 
GRSurçû
* 
surçû
 = 
	`m®loc_surçû
(
width
 * 
height
 * 4);

145 ià(
surçû
 =ğ
NULL
)  NULL;

147 
surçû
->
width
 = width;

148 
surçû
->
height
 = height;

149 
surçû
->
row_by‹s
 = 
width
 * 4;

150 
surçû
->
pix–_by‹s
 = 4;

152  
surçû
;

153 
	}
}

164 
	$ŒªsfÜm_rgb_to_d¿w
(* 
šput_row
,

165 * 
ouut_row
,

166 
chªÃls
, 
width
) {

167 
x
;

168 * 

 = 
šput_row
;

169 * 
İ
 = 
ouut_row
;

171 
chªÃls
) {

174 
x
 = 0; x < 
width
; ++x) {

175 *
İ
++ = *

;

176 *
İ
++ = *

;

177 *
İ
++ = *

;

178 *
İ
++ = 0xff;

179 

++;

185 
x
 = 0; x < 
width
; ++x) {

186 *
İ
++ = *

++;

187 *
İ
++ = *

++;

188 *
İ
++ = *

++;

189 *
İ
++ = 0xff;

195 
	`memıy
(
ouut_row
, 
šput_row
, 
width
*4);

198 
	}
}

200 
	$»s_ü—‹_di¥Ïy_surçû
(cÚ¡ * 
Çme
, 
GRSurçû
** 
pSurçû
) {

201 
GRSurçû
* 
surçû
 = 
NULL
;

202 
»suÉ
 = 0;

203 
²g_¡ruùp
 
²g_±r
 = 
NULL
;

204 
²g_šfİ
 
šfo_±r
 = 
NULL
;

205 
²g_ušt_32
 
width
, 
height
;

206 
²g_by‹
 
chªÃls
;

207 * 
p_row
;

208 
y
;

209 
aod_height
 = 0;

210 
FILE
 *
pFe
;

211 
bufãr
[1024] = {};

213 *
pSurçû
 = 
NULL
;

215 
»suÉ
 = 
	`İ’_²g
(
Çme
, &
²g_±r
, &
šfo_±r
, &
width
, &
height
, &
chªÃls
);

216 ià(
»suÉ
 < 0) „esult;

218 
pFe
 = 
	`fİ’
( "/sys/class/graphics/fb0/msm_fb_panel_info", "r" );

219 ià(
NULL
 !ğ
pFe
) {

220 
	`fsÿnf
(
pFe
, "%1023s", 
bufãr
è!ğ
EOF
) {

221 if(
	`¡ºcmp
(
bufãr
, "aod_height", 10) == 0){

222 
aod_height
 = 
	`©oi
(
bufãr
 + 11);

223 
aod_height
 = (aod_heighˆ> 0 &&‡od_heighˆ<ğ
	`gr_fb_height
()) ?‡od_height : 0;

226 
	`fşo£
(
pFe
);

229 
surçû
 = 
	`š™_di¥Ïy_surçû
(
width
, 
height
 + 
aod_height
);

230 ià(
surçû
 =ğ
NULL
) {

231 
»suÉ
 = -8;

232 
ex™
;

235 #ià
	`defšed
(
RECOVERY_ABGR
è|| defšed(
RECOVERY_BGRA
)

236 
	`²g_£t_bgr
(
²g_±r
);

239 
p_row
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
width
 * 4));

240 
y
 = 
aod_height
; y < 
height
 +‡od_height; ++y) {

241 
	`²g_»ad_row
(
²g_±r
, 
p_row
, 
NULL
);

242 
	`ŒªsfÜm_rgb_to_d¿w
(
p_row
, 
surçû
->
d©a
 + 
y
 * surçû->
row_by‹s
, 
chªÃls
, 
width
);

244 
	`ä“
(
p_row
);

246 *
pSurçû
 = 
surçû
;

248 
ex™
:

249 
	`²g_de¡roy_»ad_¡ruù
(&
²g_±r
, &
šfo_±r
, 
NULL
);

250 ià(
»suÉ
 < 0 && 
surçû
 !ğ
NULL
è
	`ä“
(surface);

251  
»suÉ
;

252 
	}
}

254 
	$»s_ü—‹_muÉi_di¥Ïy_surçû
(cÚ¡ * 
Çme
, * 
äames
, * 
ås
,

255 
GRSurçû
*** 
pSurçû
) {

256 
GRSurçû
** 
surçû
 = 
NULL
;

257 
»suÉ
 = 0;

258 
²g_¡ruùp
 
²g_±r
 = 
NULL
;

259 
²g_šfİ
 
šfo_±r
 = 
NULL
;

260 
²g_ušt_32
 
width
, 
height
;

261 
²g_by‹
 
chªÃls
;

262 
²g_‹x
 
‹xt
;

263 
num_‹xt
;

264 * 
p_row
;

265 
y
;

267 *
pSurçû
 = 
NULL
;

268 *
äames
 = -1;

270 
»suÉ
 = 
	`İ’_²g
(
Çme
, &
²g_±r
, &
šfo_±r
, &
width
, &
height
, &
chªÃls
);

271 ià(
»suÉ
 < 0) „esult;

273 *
äames
 = 1;

274 *
ås
 = 20;

275 ià(
	`²g_g‘_‹xt
(
²g_±r
, 
šfo_±r
, &
‹xt
, &
num_‹xt
)) {

276 
i
 = 0; i < 
num_‹xt
; ++i) {

277 ià(
‹xt
[
i
].
key
 && 
	`¡rcmp
(text[i].key, "Frames") == 0 &&ext[i].text) {

278 *
äames
 = 
	`©oi
(
‹xt
[
i
].text);

279 } ià(
‹xt
[
i
].
key
 && 
	`¡rcmp
(text[i].key, "FPS") == 0 &&ext[i].text) {

280 *
ås
 = 
	`©oi
(
‹xt
[
i
].text);

283 
	`´štf
(" found f¿me ğ%d\n", *
äames
);

284 
	`´štf
(" found fp ğ%d\n", *
ås
);

287 ià(*
äames
 <ğ0 || *
ås
 <= 0) {

288 
	`´štf
("bad‚umb” oàäame (%dèªd/Ü FPS (%d)\n", *
äames
, *
ås
);

289 
»suÉ
 = -10;

290 
ex™
;

293 ià(
height
 % *
äames
 != 0) {

294 
	`´štf
("bad heighˆ(%dèfÜ f¿mcouÁ (%d)\n", 
height
, *
äames
);

295 
»suÉ
 = -9;

296 
ex™
;

299 
surçû
 = 
¡©ic_ÿ¡
<
GRSurçû
**>(
	`ÿÎoc
(*
äames
, (GRSurface*)));

300 ià(
surçû
 =ğ
NULL
) {

301 
»suÉ
 = -8;

302 
ex™
;

304 
i
 = 0; i < *
äames
; ++i) {

305 
surçû
[
i
] = 
	`š™_di¥Ïy_surçû
(
width
, 
height
 / *
äames
);

306 ià(
surçû
[
i
] =ğ
NULL
) {

307 
»suÉ
 = -8;

308 
ex™
;

312 #ià
	`defšed
(
RECOVERY_ABGR
è|| defšed(
RECOVERY_BGRA
)

313 
	`²g_£t_bgr
(
²g_±r
);

316 
p_row
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
width
 * 4));

317 
y
 = 0; y < 
height
; ++y) {

318 
	`²g_»ad_row
(
²g_±r
, 
p_row
, 
NULL
);

319 
äame
 = 
y
 % *
äames
;

320 * 
out_row
 = 
surçû
[
äame
]->
d©a
 +

321 (
y
 / *
äames
è* 
surçû
[
äame
]->
row_by‹s
;

322 
	`ŒªsfÜm_rgb_to_d¿w
(
p_row
, 
out_row
, 
chªÃls
, 
width
);

324 
	`ä“
(
p_row
);

326 *
pSurçû
 = 
surçû
;

328 
ex™
:

329 
	`²g_de¡roy_»ad_¡ruù
(&
²g_±r
, &
šfo_±r
, 
NULL
);

331 ià(
»suÉ
 < 0) {

332 ià(
surçû
) {

333 
i
 = 0; i < *
äames
; ++i) {

334 
	`ä“
(
surçû
[
i
]);

336 
	`ä“
(
surçû
);

339  
»suÉ
;

340 
	}
}

342 
	$»s_ü—‹_®pha_surçû
(cÚ¡ * 
Çme
, 
GRSurçû
** 
pSurçû
) {

343 
GRSurçû
* 
surçû
 = 
NULL
;

344 
»suÉ
 = 0;

345 
²g_¡ruùp
 
²g_±r
 = 
NULL
;

346 
²g_šfİ
 
šfo_±r
 = 
NULL
;

347 
²g_ušt_32
 
width
, 
height
;

348 
²g_by‹
 
chªÃls
;

350 *
pSurçû
 = 
NULL
;

352 
	`LOG
(
ERROR
è<< "»s_ü—‹_®pha_surçû,‚ame=" << 
Çme
;

353 
»suÉ
 = 
	`İ’_²g
(
Çme
, &
²g_±r
, &
šfo_±r
, &
width
, &
height
, &
chªÃls
);

354 ià(
»suÉ
 < 0) „esult;

356 ià(
chªÃls
 != 1) {

357 
»suÉ
 = -7;

358 
ex™
;

361 
surçû
 = 
	`m®loc_surçû
(
width
 * 
height
);

362 ià(
surçû
 =ğ
NULL
) {

363 
»suÉ
 = -8;

364 
ex™
;

366 
surçû
->
width
 = width;

367 
surçû
->
height
 = height;

368 
surçû
->
row_by‹s
 = 
width
;

369 
surçû
->
pix–_by‹s
 = 1;

371 #ià
	`defšed
(
RECOVERY_ABGR
è|| defšed(
RECOVERY_BGRA
)

372 
	`²g_£t_bgr
(
²g_±r
);

375 * 
p_row
;

376 
y
;

377 
y
 = 0; y < 
height
; ++y) {

378 
p_row
 = 
surçû
->
d©a
 + 
y
 * surçû->
row_by‹s
;

379 
	`²g_»ad_row
(
²g_±r
, 
p_row
, 
NULL
);

382 *
pSurçû
 = 
surçû
;

384 
ex™
:

385 
	`²g_de¡roy_»ad_¡ruù
(&
²g_±r
, &
šfo_±r
, 
NULL
);

386 ià(
»suÉ
 < 0 && 
surçû
 !ğ
NULL
è
	`ä“
(surface);

387  
»suÉ
;

388 
	}
}

392 
boŞ
 
	$m©ches_loÿË
(cÚ¡ 
¡d
::
¡ršg
& 
´efix
, cÚ¡ std::¡ršg& 
loÿË
) {

402 ià(
ªdroid
::
ba£
::
	`S¹sW™h
(
loÿË
, 
´efix
.
	`c_¡r
())) {

403  
Œue
;

406 
size_t
 
£·¿tÜ
 = 
´efix
.
	`fšd
('-');

407 ià(
£·¿tÜ
 =ğ
¡d
::
¡ršg
::
Åos
) {

408  
çl£
;

410 
¡d
::
»gex
 
	`loc_»gex
(
´efix
.
	`sub¡r
(0, 
£·¿tÜ
) + "-[A-Za-z]*" +…refix.substr(separator));

411  
¡d
::
	`»gex_m©ch
(
loÿË
, 
loc_»gex
);

412 
	}
}

414 
	$»s_ü—‹_loÿlized_®pha_surçû
(cÚ¡ * 
Çme
,

415 cÚ¡ * 
loÿË
,

416 
GRSurçû
** 
pSurçû
) {

417 
GRSurçû
* 
surçû
 = 
NULL
;

418 
»suÉ
 = 0;

419 
²g_¡ruùp
 
²g_±r
 = 
NULL
;

420 
²g_šfİ
 
šfo_±r
 = 
NULL
;

421 
²g_ušt_32
 
width
, 
height
;

422 
²g_by‹
 
chªÃls
;

423 
²g_ušt_32
 
y
;

424 
¡d
::
veùÜ
<> 
row
;

426 *
pSurçû
 = 
NULL
;

428 ià(
loÿË
 =ğ
NULL
) {

429  
»suÉ
;

432 
»suÉ
 = 
	`İ’_²g
(
Çme
, &
²g_±r
, &
šfo_±r
, &
width
, &
height
, &
chªÃls
);

433 ià(
»suÉ
 < 0) „esult;

435 ià(
chªÃls
 != 1) {

436 
»suÉ
 = -7;

437 
ex™
;

440 
row
.
	`»size
(
width
);

441 
y
 = 0; y < 
height
; ++y) {

442 
	`²g_»ad_row
(
²g_±r
, 
row
.
	`d©a
(), 
NULL
);

443 
w
 = (
row
[1] << 8) |„ow[0];

444 
h
 = (
row
[3] << 8) |„ow[2];

445 
__unu£d
 
Ën
 = 
row
[4];

446 * 
loc
 = 
»š‹½»t_ÿ¡
<*>(&
row
[5]);

448 ià(
y
+1+
h
 >ğ
height
 || 
	`m©ches_loÿË
(
loc
, 
loÿË
)) {

449 
	`´štf
(" %20s: % (%d x %d @ %d)\n", 
Çme
, 
loc
, 
w
, 
h
, 
y
);

451 
surçû
 = 
	`m®loc_surçû
(
w
*
h
);

452 ià(
surçû
 =ğ
NULL
) {

453 
»suÉ
 = -8;

454 
ex™
;

456 
surçû
->
width
 = 
w
;

457 
surçû
->
height
 = 
h
;

458 
surçû
->
row_by‹s
 = 
w
;

459 
surçû
->
pix–_by‹s
 = 1;

461 
i
;

462 
i
 = 0; i < 
h
; ++i, ++
y
) {

463 
	`²g_»ad_row
(
²g_±r
, 
row
.
	`d©a
(), 
NULL
);

464 
	`memıy
(
surçû
->
d©a
 + 
i
*
w
, 
row
.
	`d©a
(), w);

467 *
pSurçû
 = 
surçû
;

470 
i
;

471 
i
 = 0; i < 
h
; ++i, ++
y
) {

472 
	`²g_»ad_row
(
²g_±r
, 
row
.
	`d©a
(), 
NULL
);

477 
ex™
:

478 
	`²g_de¡roy_»ad_¡ruù
(&
²g_±r
, &
šfo_±r
, 
NULL
);

479 ià(
»suÉ
 < 0 && 
surçû
 !ğ
NULL
è
	`ä“
(surface);

480  
»suÉ
;

481 
	}
}

483 
	$»s_ä“_surçû
(
GRSurçû
* 
surçû
) {

484 
	`ä“
(
surçû
);

485 
	}
}

	@mounts.cpp

17 
	~"mouÁs.h
"

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<mÁ’t.h
>

22 
	~<¡dio.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/mouÁ.h
>

27 
	~<¡ršg
>

28 
	~<veùÜ
>

30 
	sMouÁedVŞume
 {

31 
	m¡d
::
¡ršg
 
deviû
;

32 
	m¡d
::
¡ršg
 
mouÁ_pošt
;

33 
	m¡d
::
¡ršg
 
fesy¡em
;

34 
	m¡d
::
¡ršg
 
æags
;

37 
	g¡d
::
veùÜ
<
MouÁedVŞume
*> 
g_mouÁs_¡©e
;

39 
boŞ
 
	$sÿn_mouÁed_vŞumes
() {

40 
size_t
 
i
 = 0; i < 
g_mouÁs_¡©e
.
	`size
(); ++i) {

41 
d–‘e
 
g_mouÁs_¡©e
[
i
];

43 
g_mouÁs_¡©e
.
	`ş—r
();

46 
FILE
* 
å
 = 
	`£tmÁ’t
("/proc/mounts", "re");

47 ià(
å
 =ğ
NULL
) {

48  
çl£
;

50 
mÁ’t
* 
e
;

51 (
e
 = 
	`g‘mÁ’t
(
å
)è!ğ
NULL
) {

52 
MouÁedVŞume
* 
v
 = 
Ãw
 MountedVolume;

53 
v
->
deviû
 = 
e
->
mÁ_f¢ame
;

54 
v
->
mouÁ_pošt
 = 
e
->
mÁ_dœ
;

55 
v
->
fesy¡em
 = 
e
->
mÁ_ty³
;

56 
v
->
æags
 = 
e
->
mÁ_İts
;

57 
g_mouÁs_¡©e
.
	`push_back
(
v
);

59 
	`’dmÁ’t
(
å
);

60  
Œue
;

61 
	}
}

63 
MouÁedVŞume
* 
	$fšd_mouÁed_vŞume_by_deviû
(cÚ¡ * 
deviû
) {

64 
size_t
 
i
 = 0; i < 
g_mouÁs_¡©e
.
	`size
(); ++i) {

65 ià(
g_mouÁs_¡©e
[
i
]->
deviû
 == device)  g_mounts_state[i];

67  
nuÎ±r
;

68 
	}
}

70 
MouÁedVŞume
* 
	$fšd_mouÁed_vŞume_by_mouÁ_pošt
(cÚ¡ * 
mouÁ_pošt
) {

71 
size_t
 
i
 = 0; i < 
g_mouÁs_¡©e
.
	`size
(); ++i) {

72 ià(
g_mouÁs_¡©e
[
i
]->
mouÁ_pošt
 == mount_point)  g_mounts_state[i];

74  
nuÎ±r
;

75 
	}
}

77 
	$unmouÁ_mouÁed_vŞume
(
MouÁedVŞume
* 
vŞume
) {

81 
¡d
::
¡ršg
 
mouÁ_pošt
 = 
vŞume
->mount_point;

82 
vŞume
->
mouÁ_pošt
.
	`ş—r
();

83  
	`umouÁ
(
mouÁ_pošt
.
	`c_¡r
());

84 
	}
}

86 
	$»mouÁ_»ad_Úly
(
MouÁedVŞume
* 
vŞume
) {

87  
	`mouÁ
(
vŞume
->
deviû
.
	`c_¡r
(), vŞume->
mouÁ_pošt
.c_¡r(), vŞume->
fesy¡em
.c_str(),

88 
MS_NOATIME
 | 
MS_NODEV
 | 
MS_NODIRATIME
 | 
MS_RDONLY
 | 
MS_REMOUNT
, 0);

89 
	}
}

	@mounts.h

17 #iâdeà
MOUNTS_H_


18 
	#MOUNTS_H_


	)

20 
	gMouÁedVŞume
;

22 
boŞ
 
sÿn_mouÁed_vŞumes
();

24 
MouÁedVŞume
* 
fšd_mouÁed_vŞume_by_deviû
(cÚ¡ * 
deviû
);

26 
MouÁedVŞume
* 
fšd_mouÁed_vŞume_by_mouÁ_pošt
(cÚ¡ * 
mouÁ_pošt
);

28 
unmouÁ_mouÁed_vŞume
(
MouÁedVŞume
* 
vŞume
);

30 
»mouÁ_»ad_Úly
(
MouÁedVŞume
* 
vŞume
);

	@mtdutils/emmcutils.c

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<sys/ty³s.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/mouÁ.h
>

26 
	~<fú.h
>

27 
	~<”ºo.h
>

28 
	~<sys/wa™.h
>

29 
	~<sys/ioùl.h
>

30 
	~<lšux/dm-ioùl.h
>

31 
	~"cuts/´İ”t›s.h
"

33 
	~"make_ext4fs.h
"

35 
	~"emmcuts.h
"

36 
	~"’cdeviû.h
"

37 
	~"sduts.h
"

44 
	#EMMC_PROC_FILENAME
 "/´oc/emmc"

	)

46 
	gemmc_·ge_size
=
EMMC_DEFAULT_PAGE_SIZE
;

48 
eMMCS‹
 
	gg_emmc_¡©e
 = {

49 
NULL
,

54 
	$emmc_£t_·ge_size
(
·ge_size
){

55 
	`årštf
(
¡d”r
,"%s:…agsiz%d\n",
__FUNCTION__
,
·ge_size
);

56 if(
·ge_size
!=0)
emmc_·ge_size
=page_size;

57 
	}
}

59 
	$emmc_g‘_·ge_size
(){

60  
emmc_·ge_size
;

61 
	}
}

63 
	$emmc_sÿn_·¹™iÚs
(){

64 
buf
[4096];

65 cÚ¡ *
buå
;

66 
fd
;

67 
i
;

68 
ssize_t
 
nby‹s
;

70 ià(
g_emmc_¡©e
.
·¹™iÚs
 =ğ
NULL
) {

72 cÚ¡ 
nump
 = 128;

73 
eMMCP¬t™iÚ
 *
·¹™iÚs
 = 
	`m®loc
(
nump
 * (*partitions));

74 ià(
·¹™iÚs
 =ğ
NULL
) {

75 
”ºo
 = 
ENOMEM
;

78 
g_emmc_¡©e
.
·¹™iÚs
 =…artitions;

79 
g_emmc_¡©e
.
·¹™iÚs_®locd
 = 
nump
;

80 
	`mem£t
(
·¹™iÚs
, 0, 
nump
 * (*partitions));

82 
g_emmc_¡©e
.
·¹™iÚ_couÁ
 = 0;

88 
i
 = 0; i < 
g_emmc_¡©e
.
·¹™iÚs_®locd
; i++) {

89 
eMMCP¬t™iÚ
 *
p
 = &
g_emmc_¡©e
.
·¹™iÚs
[
i
];

90 ià(
p
->
dev
 !=
NULL
) {

91 
	`ä“
(
p
->
dev
);

92 
p
->
dev
 = 
NULL
;

94 ià(
p
->
Çme
 !ğ
NULL
) {

95 
	`ä“
(
p
->
Çme
);

96 
p
->
Çme
 = 
NULL
;

102 
fd
 = 
	`İ’
(
EMMC_PROC_FILENAME
, 
O_RDONLY
);

103 ià(
fd
 < 0) {

104 
	`årštf
(
¡d”r
,"%s: FaedØİ’ %s\n",
__FUNCTION__
,
EMMC_PROC_FILENAME
);

105 
ba
;

107 
nby‹s
 = 
	`»ad
(
fd
, 
buf
, (buf) - 1);

108 
	`şo£
(
fd
);

109 ià(
nby‹s
 < 0) {

110 
ba
;

112 
buf
[
nby‹s
] = '\0';

123 
buå
 = 
buf
;

124 
nby‹s
 > 0) {

125 
emmcsize
, 
emmû¿£size
;

126 
m©ches
;

127 
emmcdev
[64];

128 
emmúame
[64];

129 
emmúame
[0] = '\0';

131 
m©ches
 = 
	`ssÿnf
(
buå
, "%63[^:]: %x %x \"%63[^\"]",
emmcdev
, &
emmcsize
, &
emmû¿£size
, 
emmúame
);

136 ià(
m©ches
 == 4) {

137 
eMMCP¬t™iÚ
 *
p
 = &
g_emmc_¡©e
.
·¹™iÚs
[g_emmc_¡©e.
·¹™iÚ_couÁ
];

138 
p
->
dev
 = 
	`¡rdup
(
emmcdev
);

139 
p
->
size
 = 
emmcsize
;

140 
p
->
”a£size
 = 
emmû¿£size
;

141 
p
->
Çme
 = 
	`¡rdup
(
emmúame
);

142 ià(
p
->
dev
==
NULL
||p->
Çme
==NULL) {

143 
”ºo
 = 
ENOMEM
;

144 
ba
;

146 
g_emmc_¡©e
.
·¹™iÚ_couÁ
++;

151 
nby‹s
 > 0 && *
buå
 != '\n') {

152 
buå
++;

153 
nby‹s
--;

155 ià(
nby‹s
 > 0) {

156 
buå
++;

157 
nby‹s
--;

160 
	`LOGI
("%s:[·¹™iÚ_couÁ:%d] [®loÿt_num:%d]\n", 
__FUNCTION__
, 
g_emmc_¡©e
.
·¹™iÚ_couÁ
, g_emmc_¡©e.
·¹™iÚs_®locd
);

161  
g_emmc_¡©e
.
·¹™iÚ_couÁ
;

163 
ba
:

165 
g_emmc_¡©e
.
·¹™iÚ_couÁ
 = -1;

168 
	}
}

170 cÚ¡ 
eMMCP¬t™iÚ
* 
	$emmc_fšd_·¹™iÚ_by_dev
(cÚ¡ *
dev
){

171 ià(
g_emmc_¡©e
.
·¹™iÚs
 !ğ
NULL
 && 
dev
 != NULL) {

172 
i
;

173 cÚ¡ *
devÇme
=
NULL
;

175 if(
	`¡ºcmp
(
dev
,"/dev/block/",
	`¡¾’
("/dev/block/")) == 0)

176 
devÇme
=
dev
+
	`¡¾’
("/dev/block/");

178 
devÇme
=
dev
;

180 
i
 = 0; i < 
g_emmc_¡©e
.
·¹™iÚs_®locd
; i++) {

181 
eMMCP¬t™iÚ
 *
p
 = &
g_emmc_¡©e
.
·¹™iÚs
[
i
];

182 ià(
p
->
dev
!=
NULL
&&
	`¡rcmp
Õ->dev, 
devÇme
) == 0) {

183  
p
;

187  
NULL
;

188 
	}
}

190 cÚ¡ 
eMMCP¬t™iÚ
* 
	$emmc_fšd_·¹™iÚ_by_Çme
(cÚ¡ *
Çme
){

192 ià(
g_emmc_¡©e
.
·¹™iÚs
 =ğ
NULL
){

193 
	`LOGE
("%s: g_emmc_¡©e.·¹™iÚ i NULL\n",
__FUNCTION__
);

194  
NULL
;

196 ià(
Çme
 =ğ
NULL
){

197 
	`LOGE
("%s:‚ami NULL\n",
__FUNCTION__
);

198  
NULL
;

200 ià(
g_emmc_¡©e
.
·¹™iÚs
 !ğ
NULL
 && 
Çme
 != NULL) {

201 
i
;

202 
i
 = 0; i < 
g_emmc_¡©e
.
·¹™iÚs_®locd
; i++) {

203 
eMMCP¬t™iÚ
 *
p
 = &
g_emmc_¡©e
.
·¹™iÚs
[
i
];

204 ià(
p
->
Çme
!=
NULL
 && 
	`¡rcmp
(p->name,‚ame) == 0) {

205  
p
;

210 
	`LOGE
("%s: Cª'ˆnÙ fšd…¬t™iÚ:%s\n", 
__FUNCTION__
, 
Çme
);

211  
NULL
;

212 
	}
}

214 
	$emmc_mouÁ_·¹™iÚ
(cÚ¡ 
eMMCP¬t™iÚ
 *
·¹™iÚ
,cÚ¡ *
mouÁ_pošt
,cÚ¡ *
fesy¡em
){

215 
dev·th
[32]="/dev/block/";

216 
’c_dev·th
[
DEVPATHLENGTH
]={0};

217 
ma¡”_key_ascii
[128]={0};;

218 
·¿m
[256]={0};

219 
tz_’c_key
[32]={0};

220 
tz_dec_key
[32]={0};

221 
keysize
 = 0;

222 
»Œy_couÁ
 = 0;

223 
»Œy_max
 = 10;

225 
	`¡ºÿt
(
dev·th
,
·¹™iÚ
->
dev
,
	`¡¾’
(partition->dev));

226 if(
	`¡rcmp
(
fesy¡em
, "ext3") == 0 ||

227 
	`¡rcmp
(
fesy¡em
, "ext4") == 0){

228 if(!
	`¡ºcmp
(
·¹™iÚ
->
Çme
,"u£rd©a",
	`¡¾’
("u£rd©a"))&&
	`ext_check_’üy±
(
dev·th
)){

230 if(
	`emmc_g‘_tz_’üy±ed_key
(
tz_’c_key
,Ñz_’c_key),
ENC_KEY_OFFSET_EXT
,0)){

231 
	`årštf
(
¡d”r
,"%s:„—d key faed\n",
__FUNCTION__
);

234 if(
	`tz_deüy±_key
(
tz_’c_key
,
tz_dec_key
,(tz_enc_key))){

235 
	`årštf
(
¡d”r
,"%s: deüy± key faed\n",
__FUNCTION__
);

238 if(!
	`dm_dev_exi¡s
(
·¹™iÚ
->
Çme
,
’c_dev·th
)){

240 
	`cÚv”t_key_to_hex_ascii
(
tz_dec_key
,32,
ma¡”_key_ascii
);

241 
keysize
=
	`ext_check_’üy±_keysize
();

242 if(
keysize
!=16&&keysize!=32){

243 
	`årštf
(
¡d”r
, "%s: inv®idƒnüy±iÚ keysiz%d\n",
__FUNCTION__
, 
keysize
);

245 }if(
keysize
==16){

247 
ma¡”_key_ascii
[32]=0;

249 
	`årštf
(
¡dout
, "%s: The keysize in crypto footer of %s is %d\n",

250 
__FUNCTION__
,
·¹™iÚ
->
Çme
,
keysize
);

251 
	`¢´štf
(
·¿m
,Õ¬am), "% % 0 % 0", "«s-cbc-essiv:sha256",
ma¡”_key_ascii
,
dev·th
);

252 if(
	`dm_dev_ü—‹
(
·¹™iÚ
->
Çme
,
DM_TYPE_EXT
,
·¿m
,
dev·th
,
’c_dev·th
)){

253 
	`årštf
(
¡d”r
,"%s: c»©dm-üy± deviû faed\n",
__FUNCTION__
);

257 
»Œy_couÁ
 = 0;„‘ry_couÁ < 
»Œy_max
;„etry_count++){

258 if(!
	`mouÁ
(
’c_dev·th
,
mouÁ_pošt
,
fesy¡em
,
MS_NOATIME
|
MS_NODEV
|
MS_NODIRATIME
,"")){

259 
	`årštf
(
¡d”r
,"%s: mouÁ dm-dev % sucûss\n",
__FUNCTION__
,
·¹™iÚ
->
Çme
);

262 
	`u¦“p
(50000);

265 
	`årštf
(
¡d”r
,"%s: mouÁ dm-dev % çed\n",
__FUNCTION__
,
·¹™iÚ
->
Çme
);

266 
	`dm_dev_de¡roy
(
·¹™iÚ
->
Çme
);

270 if(!
	`mouÁ
(
dev·th
,
mouÁ_pošt
,
fesy¡em
,
MS_NOATIME
|
MS_NODEV
|
MS_NODIRATIME
,"discard")){

271 
	`årštf
(
¡d”r
,"%s: mouÁ dev % sucûss\n",
__FUNCTION__
,
·¹™iÚ
->
Çme
);

274 
	`årštf
(
¡d”r
,"%s: mouÁ dev % çed\n",
__FUNCTION__
,
·¹™iÚ
->
Çme
);

278 }if(
	`¡rcmp
(
fesy¡em
, "vfat") == 0){

279  
	`sd_mouÁ_·¹™iÚ
(
dev·th
,
NULL
,
mouÁ_pošt
,
fesy¡em
);

281 
	`årštf
(
¡d”r
,"%s: unknowÀfesy¡em %s\n",
__FUNCTION__
,
fesy¡em
);

285 
	}
}

287 
	$emmc_umouÁ_·¹™iÚ
(cÚ¡ *
dev·th
,cÚ¡ *
mouÁ_pošt
){

288 
»t
 = 0;

289 
»Œy_couÁ
=0;

290 
»Œy_max
=10;

291 
»Œy_¦“p_time
=1;

292 
id
=0;

293 
dm_dev_Çme
[32]={0};

296 
»Œy_couÁ
=0;»Œy_couÁ<
»Œy_max
;++retry_count){

297 
»t
=
	`umouÁ
(
mouÁ_pošt
);

298 ià(
»t
 == 0)

301 
	`årštf
(
¡d”r
,"%s: umount %s failed,„et %d,ƒrrno %d (%s)..„etry....%d\n",

302 
__FUNCTION__
, 
mouÁ_pošt
, 
»t
, 
”ºo
, 
	`¡»¼Ü
Ó¼no), 
»Œy_couÁ
);

303 
	`¦“p
(
»Œy_¦“p_time
);

306 if(
»t
 != 0){

307 
	`årštf
(
¡d”r
,"%s: umount %s failed,„et %d,ƒrrno %d (%s)\n",

308 
__FUNCTION__
, 
mouÁ_pošt
, 
»t
, 
”ºo
, 
	`¡»¼Ü
(errno));

309  
»t
;

313 if(
	`¡ºcmp
(
dev·th
,"/dev/block/dm-",
	`¡¾’
("/dev/block/dm-"))==0){

314 
	`ssÿnf
(
dev·th
,"/dev/block/dm-%d",&
id
);

315 if(
	`dm_dev_fšd_Çme_by_id
(()
id
,
dm_dev_Çme
)){

316 
»Œy_couÁ
=0;»Œy_couÁ<
»Œy_max
;++retry_count){

317 
»t
=
	`dm_dev_de¡roy
(
dm_dev_Çme
);

318 if(
»t
==0){

319 
	`årštf
(
¡d”r
,"%s: de¡roy % sucûssful\n",
__FUNCTION__
,
dm_dev_Çme
);

322 
	`årštf
(
¡d”r
,"%s: de¡roy % çed\n",
__FUNCTION__
,
dm_dev_Çme
);

324 
	`¦“p
(
»Œy_¦“p_time
);

329  
»t
;

330 
	}
}

332 
	$emmc_fÜm©_·¹™iÚ
(cÚ¡ 
eMMCP¬t™iÚ
 *
·¹™iÚ
,cÚ¡ * 
mouÁ_pošt
,cÚ¡ *
fesy¡em
,
Ëngth
,
£Ïb–_hªdË
 *
£hªdË
){

333 
dev·th
[32]="/dev/block/";

334 
	`¡ºÿt
(
dev·th
,
·¹™iÚ
->
dev
,
	`¡¾’
(partition->dev));

335 if(
	`¡rcmp
(
fesy¡em
, "ext4") == 0) {

336  
	`make_ext4fs
(
dev·th
,
Ëngth
,
mouÁ_pošt
,
£hªdË
);

337 }if(
	`¡rcmp
(
fesy¡em
, "ext3") == 0) {

339 
	`årštf
(
¡d”r
,"%s: NÙ suµÜˆfÜ %s!\n",
__FUNCTION__
,
fesy¡em
);

341 }if(
	`¡rcmp
(
fesy¡em
, "vfat") == 0) {

342  
	`sd_fÜm©_·¹™iÚ
(
dev·th
,
mouÁ_pošt
,
fesy¡em
);

343 }if(
	`¡rcmp
(
fesy¡em
, "raw") == 0) {

344  
	`emmc_”a£_·¹™iÚ
(
·¹™iÚ
);

346 
	`årštf
(
¡d”r
,"%s: NÙ suµÜˆfÜ %s!\n",
__FUNCTION__
,
fesy¡em
);

348 
	}
}

350 
	$emmc_»ad
(cÚ¡ 
eMMCP¬t™iÚ
 *
•
,
loff_t
 
off£t
,
Ëngth
,*
pd©a
) {

351 
fd
=-1;

352 
dev·th
[32]="/dev/block/";

353 ià((!
•
)||(
off£t
<0)||(
Ëngth
<=0)||(!
pd©a
)){

354 
	`årštf
(
¡d”r
,"%s: inv®id‡rgum’t!\n",
__FUNCTION__
);

358 
	`¡ºÿt
(
dev·th
,
•
->
dev
,
	`¡¾’
(ep->dev));

359 
fd
=
	`İ’
(
dev·th
,
O_RDWR
);

360 if(
fd
<0){

361 
	`årštf
(
¡d”r
,"%s: o³À% çed %s\n",
__FUNCTION__
,
dev·th
,
	`¡»¼Ü
(
”ºo
));

365 if(
	`l£ek64
(
fd
,
off£t
,
SEEK_SET
)<0){

366 
	`årštf
(
¡d”r
,"%s: s“k % çed %s\n",
__FUNCTION__
,
dev·th
,
	`¡»¼Ü
(
”ºo
));

367 
	`şo£
(
fd
);

371 ià(
	`»ad
(
fd
,
pd©a
,
Ëngth
)!=length){

372 
	`årštf
(
¡d”r
,"%s:„—d % çed %s\n",
__FUNCTION__
,
dev·th
,
	`¡»¼Ü
(
”ºo
));

373 
	`şo£
(
fd
);

376 
	`şo£
(
fd
);

378 
	}
}

380 
	$emmc_wr™e
(cÚ¡ 
eMMCP¬t™iÚ
 *
•
,
loff_t
 
off£t
,
Ëngth
,*
pd©a
){

381 
fd
=-1;

382 
dev·th
[32]="/dev/block/";

383 if((!
•
)||(
off£t
<0)||(
Ëngth
<=0)||(!
pd©a
)){

384 
	`årštf
(
¡d”r
,"%s: inv®id‡rgum’t!\n",
__FUNCTION__
);

388 
	`¡ºÿt
(
dev·th
,
•
->
dev
,
	`¡¾’
(ep->dev));

389 
fd
=
	`İ’
(
dev·th
,
O_RDWR
);

390 if(
fd
<0){

391 
	`årštf
(
¡d”r
,"%s: o³À% çed %s\n",
__FUNCTION__
,
dev·th
,
	`¡»¼Ü
(
”ºo
));

395 if(
	`l£ek64
(
fd
,
off£t
,
SEEK_SET
)<0){

396 
	`årštf
(
¡d”r
,"%s: s“k % çed %s\n",
__FUNCTION__
,
dev·th
,
	`¡»¼Ü
(
”ºo
));

397 
	`şo£
(
fd
);

401 ià(
	`wr™e
(
fd
,
pd©a
,
Ëngth
)!=length){

402 
	`årštf
(
¡d”r
,"%s: wr™% çed %s\n",
__FUNCTION__
,
dev·th
,
	`¡»¼Ü
(
”ºo
));

403 
	`şo£
(
fd
);

406 
	`şo£
(
fd
);

407 
	`sync
();sync();sync();

409 
	}
}

411 
	$emmc_”a£_·¹™iÚ
(cÚ¡ 
eMMCP¬t™iÚ
 *
·¹™iÚ
) {

412 
fd
=-1;

413 
i
=0,
size
=0,
couÁ
=0;

414 
dev·th
[32]="/dev/block/";

415 
dummy
[512]={0};

416 if(!
·¹™iÚ
){

417 
	`årštf
(
¡d”r
,"%s: inv®id‡rgum’t!\n",
__FUNCTION__
);

421 
	`¡ºÿt
(
dev·th
,
·¹™iÚ
->
dev
,
	`¡¾’
(partition->dev));

422 
fd
=
	`İ’
(
dev·th
,
O_RDWR
);

423 if(
fd
<0){

424 
	`årštf
(
¡d”r
,"%s: o³À% çed %s\n",
__FUNCTION__
,
dev·th
,
	`¡»¼Ü
(
”ºo
));

429 
size
=
	`l£ek
(
fd
,0,
SEEK_END
);

430 if(
size
<0)

434 if(
	`l£ek
(
fd
,0,
SEEK_SET
)!=0)

438 
couÁ
=
size
/512;

439 
i
=0;i<
couÁ
;++i){

440 if(
	`wr™e
(
fd
,
dummy
,512)!=512)

445 
couÁ
=
size
%512;

446 if(
couÁ
!=0){

447 if(
	`wr™e
(
fd
,
dummy
,
couÁ
)!=count)

450 
	`fsync
(
fd
);

451 
	`şo£
(
fd
);

453 
	}
}

456 
	$emmc_g‘_boÙlßd”_mes§ge
(*
d©a
,
size
){

457 cÚ¡ 
eMMCP¬t™iÚ
 *
•
=
NULL
;

458 
»adsize
 = 
	`emmc_g‘_·ge_size
(è* 
EMMC_MISC_PAGES
;

459 
»add©a
[
»adsize
];

461 if(!
d©a
||
size
<=0){

462 
	`årštf
(
¡d”r
,"%s: inv®id‡rgum’t!\n",
__FUNCTION__
);

466 
•
=
	`emmc_fšd_·¹™iÚ_by_Çme
(
EMMC_PARTITION_MISC_NAME
);

467 if(
•
==
NULL
){

468 
	`årštf
(
¡d”r
,"%s: Cª'ˆfšdƒmmø·¹™iÚ %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
);

472 if(
	`emmc_»ad
(
•
 ,0,
»adsize
,
»add©a
)) {

473 
	`årštf
(
¡d”r
,"%s: Cª'ˆ»adƒmmø·¹™iÚ % %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
,
	`¡»¼Ü
(
”ºo
));

477 
	`memıy
(
d©a
,&
»add©a
[
	`emmc_g‘_·ge_size
()*
EMMC_MISC_COMMAND_PAGE
],
size
);

479 
	}
}

481 
	$emmc_£t_boÙlßd”_mes§ge
(*
d©a
,
size
){

482 cÚ¡ 
eMMCP¬t™iÚ
 *
•
=
NULL
;

483 
»adsize
 = 
	`emmc_g‘_·ge_size
(è* 
EMMC_MISC_PAGES
;

484 
»add©a
[
»adsize
];

486 if(!
d©a
||
size
<=0){

487 
	`årštf
(
¡d”r
,"%s: inv®id‡rgum’t!\n",
__FUNCTION__
);

491 
•
=
	`emmc_fšd_·¹™iÚ_by_Çme
(
EMMC_PARTITION_MISC_NAME
);

492 if(
•
==
NULL
){

493 
	`årštf
(
¡d”r
,"%s: Cª'ˆfšdƒmmø·¹™iÚ %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
);

497 if(
	`emmc_»ad
(
•
 ,0,
»adsize
,
»add©a
)){

498 
	`årštf
(
¡d”r
,"%s: Cª'ˆ»adƒmmø·¹™iÚ % %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
,
	`¡»¼Ü
(
”ºo
));

502 
	`memıy
(&
»add©a
[
	`emmc_g‘_·ge_size
()*
EMMC_MISC_COMMAND_PAGE
],
d©a
,
size
);

504 if(
	`emmc_wr™e
(
•
,0,
»adsize
,(*)
»add©a
)){

505 
	`årštf
(
¡d”r
,"%s: Cª'ˆwr™emmø·¹™iÚ % %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
,
	`¡»¼Ü
(
”ºo
));

510 
	}
}

512 
	$emmc_g‘_misc_·ge0
(*
d©a
,
size
){

513 cÚ¡ 
eMMCP¬t™iÚ
 *
•
=
NULL
;

514 
»adsize
 = 
	`emmc_g‘_·ge_size
(è* 
EMMC_MISC_PAGES
;

515 
»add©a
[
»adsize
];

517 if(!
d©a
||
size
<=0){

518 
	`årštf
(
¡d”r
,"%s: inv®id‡rgum’t!\n",
__FUNCTION__
);

522 
•
=
	`emmc_fšd_·¹™iÚ_by_Çme
(
EMMC_PARTITION_MISC_NAME
);

523 if(
•
==
NULL
){

524 
	`årštf
(
¡d”r
,"%s: Cª'ˆfšdƒmmø·¹™iÚ %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
);

528 if(
	`emmc_»ad
(
•
 ,0,
»adsize
,
»add©a
)) {

529 
	`årštf
(
¡d”r
,"%s: Cª'ˆ»adƒmmø·¹™iÚ % %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
,
	`¡»¼Ü
(
”ºo
));

533 
	`memıy
(
d©a
,&
»add©a
[
	`emmc_g‘_·ge_size
()*
EMMC_MISC_PAGE0_PAGE
],
size
);

535 
	}
}

537 
	$emmc_£t_misc_·ge0
(*
d©a
,
size
){

538 cÚ¡ 
eMMCP¬t™iÚ
 *
•
=
NULL
;

539 
»adsize
 = 
	`emmc_g‘_·ge_size
(è* 
EMMC_MISC_PAGES
;

540 
»add©a
[
»adsize
];

542 if(!
d©a
||
size
<=0){

543 
	`årštf
(
¡d”r
,"%s: inv®id‡rgum’t!\n",
__FUNCTION__
);

547 
•
=
	`emmc_fšd_·¹™iÚ_by_Çme
(
EMMC_PARTITION_MISC_NAME
);

548 if(
•
==
NULL
){

549 
	`årštf
(
¡d”r
,"%s: Cª'ˆfšdƒmmø·¹™iÚ %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
);

553 if(
	`emmc_»ad
(
•
 ,0,
»adsize
,
»add©a
)){

554 
	`årštf
(
¡d”r
,"%s: Cª'ˆ»adƒmmø·¹™iÚ % %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
,
	`¡»¼Ü
(
”ºo
));

558 
	`memıy
(&
»add©a
[
	`emmc_g‘_·ge_size
()*
EMMC_MISC_PAGE0_PAGE
],
d©a
,
size
);

560 if(
	`emmc_wr™e
(
•
,0,
»adsize
,(*)
»add©a
)){

561 
	`årštf
(
¡d”r
,"%s: Cª'ˆwr™emmø·¹™iÚ % %s\n",
__FUNCTION__
,
EMMC_PARTITION_MISC_NAME
,
	`¡»¼Ü
(
”ºo
));

566 
	}
}

568 
	$emmc_g‘_tz_’üy±ed_key
(*
d©a
,
size
,
·ge_num
,
off£t
){

569 cÚ¡ 
eMMCP¬t™iÚ
 *
•
=
NULL
;

570 
blk_size
=512;

572 if(!
d©a
||
size
<=0){

573 
	`årštf
(
¡d”r
,"%s: inv®id‡rgum’t!\n",
__FUNCTION__
);

577 
•
=
	`emmc_fšd_·¹™iÚ_by_Çme
(
EMMC_PARTITION_EXTRA_NAME
);

578 if(
•
==
NULL
){

579 
	`årštf
(
¡d”r
,"%s: Cª'ˆfšdƒmmø·¹™iÚ %s\n",
__FUNCTION__
,
EMMC_PARTITION_EXTRA_NAME
);

583 if(
	`emmc_»ad
(
•
 ,(
·ge_num
-1)*
blk_size
+
off£t
,
size
,
d©a
)) {

584 
	`årštf
(
¡d”r
,"%s: Cª'ˆ»adƒmmø·¹™iÚ %s\n",
__FUNCTION__
,
EMMC_PARTITION_EXTRA_NAME
);

589 
	}
}

	@mtdutils/emmcutils.h

20 #iâdeà
EMMCUTILS_H


21 
	#EMMCUTILS_H


	)

23 
	~<sys/ty³s.h
>

24 
	~<uni¡d.h
>

26 #ifdeà
HAVE_SELINUX


27 
	~<£lšux/£lšux.h
>

28 
	~<£lšux/Ïb–.h
>

30 
	g£Ïb–_hªdË
;

33 #ifdeà
__ılu¥lus


37 
	#LOGE
(...è
	`årštf
(
¡dout
, "E:" 
__VA_ARGS__
)

	)

38 
	#LOGI
(...è
	`årštf
(
¡dout
, "I:" 
__VA_ARGS__
)

	)

40 
	#EMMC_PARTITION_MISC_NAME
 "misc"

	)

42 
	#EMMC_DEFAULT_PAGE_SIZE
 4096

	)

43 
	#EMMC_MISC_PAGES
 7

	)

45 
	#EMMC_MISC_PAGE0_PAGE
 0

	)

46 
	#EMMC_MISC_COMMAND_PAGE
 1

	)

48 
	#EMMC_PARTITION_EXTRA_NAME
 "exŒa"

	)

49 
	#ENC_KEY_OFFSET_EXT
 34

	)

50 
	#ENC_KEY_OFFSET_FAT
 33

	)

52 
	#DEVPATHLENGTH
 1024

	)

53 
	#DM_TYPE_EXT
 2

	)

56 *
dev
;

57 
size
;

58 
”a£size
;

59 *
Çme
;

60 }
	teMMCP¬t™iÚ
;

63 
eMMCP¬t™iÚ
 *
·¹™iÚs
;

64 
·¹™iÚs_®locd
;

65 
·¹™iÚ_couÁ
;

66 } 
	teMMCS‹
;

71 
emmc_£t_·ge_size
(
·ge_size
);

72 
emmc_g‘_·ge_size
();

74 
emmc_sÿn_·¹™iÚs
();

75 cÚ¡ 
eMMCP¬t™iÚ
* 
emmc_fšd_·¹™iÚ_by_Çme
(cÚ¡ *
Çme
);

76 cÚ¡ 
eMMCP¬t™iÚ
* 
emmc_fšd_·¹™iÚ_by_dev
(cÚ¡ *
dev
);

77 
emmc_mouÁ_·¹™iÚ
(cÚ¡ 
eMMCP¬t™iÚ
 *
·¹™iÚ
,cÚ¡ *
mouÁ_pošt
,cÚ¡ *
fesy¡em
);

78 
emmc_umouÁ_·¹™iÚ
(cÚ¡ *
dev·th
,cÚ¡ *
mouÁ_pošt
);

80 
emmc_fÜm©_·¹™iÚ
(cÚ¡ 
eMMCP¬t™iÚ
 *
·¹™iÚ
,cÚ¡ * 
mouÁ_pošt
,cÚ¡ *
fesy¡em
,
Ëngth
,
£Ïb–_hªdË
 *
£hªdË
);

82 
emmc_»ad
(cÚ¡ 
eMMCP¬t™iÚ
 *
•
,
loff_t
 
off£t
,
Ëngth
,*
pd©a
);

83 
emmc_wr™e
(cÚ¡ 
eMMCP¬t™iÚ
 *
•
,
loff_t
 
off£t
,
Ëngth
,*
pd©a
);

85 
emmc_”a£_·¹™iÚ
(cÚ¡ 
eMMCP¬t™iÚ
 *
·¹™iÚ
);

87 
emmc_g‘_boÙlßd”_mes§ge
(*
d©a
,
size
);

88 
emmc_£t_boÙlßd”_mes§ge
(*
d©a
,
size
);

90 
emmc_g‘_misc_·ge0
(*
d©a
,
size
);

91 
emmc_£t_misc_·ge0
(*
d©a
,
size
);

93 
emmc_g‘_tz_’üy±ed_key
(*
d©a
,
size
,
·ge_num
,
off£t
);

95 #ifdeà
__ılu¥lus


	@mtdutils/encdevice.c

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<sys/ty³s.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/mouÁ.h
>

26 
	~<fú.h
>

27 
	~<”ºo.h
>

28 
	~<sys/wa™.h
>

29 
	~<sys/ioùl.h
>

30 
	~<lšux/dm-ioùl.h
>

31 
	~<İ’s¦/md5.h
>

32 
	~<cuts/´İ”t›s.h
>

34 
	~"’cdeviû.h
"

35 
	~"emmcuts.h
"

40 
	$tz_deüy±_key
(*
šput_buf
, *
ouut_buf
,
keyËn
){

41 
fd
, 
»t
,
i
,
couÁ
;

42 
htc_sd£rviû_msg_s
 
sd£rviû_msg
;

44 if(
keyËn
%32!=0){

45 
	`årštf
(
¡d”r
,"%s: Thkey†’ mu¡ bmuÉË oà32\n",
__FUNCTION__
);

49 
fd
 = 
	`İ’
("/dev/htc_sd£rviû", 
O_RDWR
);

50 ià(
fd
 == -1) {

51 
	`årštf
(
¡d”r
,"%s: o³Àdeviû htc_sd£rviûƒ¼Ü\n",
__FUNCTION__
);

55 
couÁ
=
keyËn
/32;

56 
i
=0;i<
couÁ
;++i){

57 
	`mem£t
(&
sd£rviû_msg
, 0, (
htc_sd£rviû_msg_s
));

58 
sd£rviû_msg
.
func
 = 
HTC_SD_KEY_DECRYPT
;

59 
sd£rviû_msg
.
»q_Ën
 = 32;

60 
sd£rviû_msg
.
»q_buf
 = 
šput_buf
+32*
i
;

61 
sd£rviû_msg
.
»¥_buf
 = 
ouut_buf
+32*
i
;

63 
»t
 = 
	`ioùl
(
fd
, 
HTC_IOCTL_SDSERVICE
, &
sd£rviû_msg
);

64 ià(
»t
 < 0) {

65 
	`årštf
(
¡d”r
,"%s: TZ Key En/Deüy±ƒ¼Ü (%d)\n",
__FUNCTION__
,
»t
);

66 
	`şo£
(
fd
);

67  
»t
;

72 
	}
}

77 
	$cÚv”t_key_to_hex_ascii
(*
ma¡”_key
, 
keysize
, *
ma¡”_key_ascii
) {

78 
i
, 
a
;

79 
nibbË
;

81 
i
=0, 
a
=0; i<
keysize
; i++,‡+=2) {

83 
nibbË
 = (
ma¡”_key
[
i
] >> 4) & 0xf;

84 
ma¡”_key_ascii
[
a
] = 
nibbË
 + (nibble > 9 ? 0x37 : 0x30);

86 
nibbË
 = 
ma¡”_key
[
i
] & 0xf;

87 
ma¡”_key_ascii
[
a
+1] = 
nibbË
 + (nibble > 9 ? 0x37 : 0x30);

91 
ma¡”_key_ascii
[
a
] = '\0';

92 
	}
}

97 
	$ioùl_š™
(
dm_ioùl
 *
io
, 
size_t
 
d©aSize
, cÚ¡ *
Çme
, 
æags
) {

98 
	`mem£t
(
io
, 0, 
d©aSize
);

99 
io
->
d©a_size
 = 
d©aSize
;

100 
io
->
d©a_¡¬t
 = (
dm_ioùl
);

101 
io
->
v”siÚ
[0] = 4;

102 
io
->
v”siÚ
[1] = 0;

103 
io
->
v”siÚ
[2] = 0;

104 
io
->
æags
 = flags;

105 ià(
Çme
) {

106 
	`¡ºıy
(
io
->
Çme
,‚ame, (io->name));

108 
	}
}

110 
	$dm_dev_exi¡s
(cÚ¡ * 
Çme
,* 
dm_dev_·th
){

111 
fd
=-1;

112 
mšÜ
;

113 
dm_ioùl
 *
io
=
NULL
;

114 
bufãr
[
DM_CRYPT_BUF_SIZE
];

116 ià((
fd
 = 
	`İ’
("/dev/deviû-m­³r", 
O_RDWR
)) < 0) {

117 
	`årštf
(
¡d”r
,"%s: CªnÙ o³Àdeviû-m­³r\n",
__FUNCTION__
);

121 
io
 = (
dm_ioùl
 *è
bufãr
;

123 
	`ioùl_š™
(
io
, 
DM_CRYPT_BUF_SIZE
,
Çme
, 0);

124 ià(
	`ioùl
(
fd
, 
DM_DEV_STATUS
, 
io
)) {

125 
	`årštf
(
¡d”r
,"%s: CªnÙ„‘r›vdm-üy± deviû stus\n",
__FUNCTION__
);

126 
	`şo£
(
fd
);

130 
	`şo£
(
fd
);

131 
mšÜ
 = (
io
->
dev
 & 0xff) | ((io->dev >> 12) & 0xfff00);

132 
	`¢´štf
(
dm_dev_·th
, 
DEVPATHLENGTH
, "/dev/block/dm-%u", 
mšÜ
);

134 
	}
}

136 
	$dm_dev_fšd_Çme_by_id
(
id
,* 
Çme
){

137 
fd
;

138 
dm_ioùl
 *
io
=
NULL
;

139 
bufãr
[
DM_CRYPT_BUF_SIZE
];

140 
Æi¡_Ãxt
;

141 
dm_Çme_li¡
 *
Æi¡
=0;

142 
mšÜ
;

144 ià((
fd
 = 
	`İ’
("/dev/deviû-m­³r", 
O_RDWR
)) < 0) {

145 
	`årštf
(
¡d”r
,"%s: CªnÙ o³Àdeviû-m­³r\n",
__FUNCTION__
);

149 
io
 = (
dm_ioùl
 *è
bufãr
;

150 
	`ioùl_š™
(
io
,
DM_CRYPT_BUF_SIZE
,
NULL
,0);

151 if(
	`ioùl
(
fd
,
DM_LIST_DEVICES
,
io
)) {

152 
	`årštf
(
¡d”r
,"%s: CªnÙ†i¡ deviûs\n",
__FUNCTION__
);

153 
	`şo£
(
fd
);

156 
	`şo£
(
fd
);

159 
Æi¡_Ãxt
=0;

160 
Æi¡
=(
dm_Çme_li¡
*)(((*)
bufãr
)+
io
->
d©a_¡¬t
);

162 
Æi¡
 =(
dm_Çme_li¡
*)(((*êli¡)+
Æi¡_Ãxt
);

163 
mšÜ
 = (
io
->
dev
 & 0xff) | ((io->dev >> 12) & 0xfff00);

164 if(
mšÜ
==
id
){

165 
	`¡rıy
(
Çme
,
Æi¡
->name);

168 
Æi¡_Ãxt
=
Æi¡
->
Ãxt
;

169 }
Æi¡_Ãxt
);

172 
	}
}

174 
	$dm_dev_ü—‹
(cÚ¡ * 
Çme
,
ty³
,cÚ¡ * 
·¿m
,cÚ¡ * 
dev_·th
,* 
dm_dev_·th
){

175 
fd
=-1,
fd_dev
=-1;

176 
»tv®
 = -1;

177 
Ä_£c
;

178 
mšÜ
;

179 *
üy±_·¿ms
;

180 
dm_ioùl
 *
io
=
NULL
;

181 
dm_rg‘_¥ec
 *
tgt
;

182 
bufãr
[
DM_CRYPT_BUF_SIZE
];

184 ià((
fd
 = 
	`İ’
("/dev/deviû-m­³r", 
O_RDWR
)) < 0) {

185 
	`årštf
(
¡d”r
,"%s: CªnÙ o³Àdeviû-m­³r\n",
__FUNCTION__
);

189 
io
 = (
dm_ioùl
 *è
bufãr
;

191 
	`ioùl_š™
(
io
, 
DM_CRYPT_BUF_SIZE
,
Çme
, 0);

192 if(
	`ioùl
(
fd
, 
DM_DEV_CREATE
, 
io
)){

193 
	`årštf
(
¡d”r
,"%s: CªnÙ c»©dm-üy± deviû\n",
__FUNCTION__
);

194 
”rout
;

198 
	`ioùl_š™
(
io
, 
DM_CRYPT_BUF_SIZE
,
Çme
, 0);

199 ià(
	`ioùl
(
fd
, 
DM_DEV_STATUS
, 
io
)) {

200 
	`årštf
(
¡d”r
,"%s: CªnÙ„‘r›vdm-üy± deviû stus\n",
__FUNCTION__
);

201 
”rout
;

203 
mšÜ
 = (
io
->
dev
 & 0xff) | ((io->dev >> 12) & 0xfff00);

204 
	`¢´štf
(
dm_dev_·th
, 
DEVPATHLENGTH
, "/dev/block/dm-%u", 
mšÜ
);

207 ià((
fd_dev
 = 
	`İ’
(
dev_·th
, 
O_RDWR
)) < 0) {

208 
	`årštf
(
¡d”r
,"%s: CªnÙ o³À% (%s)\n",
__FUNCTION__
,
dev_·th
,
	`¡»¼Ü
(
”ºo
));

209 
”rout
;

212 ià(
	`ioùl
(
fd_dev
, 
BLKGETSIZE
, &
Ä_£c
)) {

213 
	`årštf
(
¡d”r
,"%s: CªnÙ g‘hsizoà%s\n",
__FUNCTION__
,
dev_·th
);

214 
	`şo£
(
fd_dev
);

215 
”rout
;

217 
	`şo£
(
fd_dev
);

219 if(
ty³
==
DM_TYPE_VFAT
)
Ä_£c
=nr_sec-1-(nr_sec%63);

221 
tgt
=(
dm_rg‘_¥ec
*)&
bufãr
[(
dm_ioùl
)];

223 
	`ioùl_š™
(
io
, 
DM_CRYPT_BUF_SIZE
,
Çme
, 0);

224 
io
->
rg‘_couÁ
 = 1;

225 
tgt
->
¡©us
 = 0;

226 
tgt
->
£ùÜ_¡¬t
 = 0;

227 
tgt
->
Ëngth
 = 
Ä_£c
;

228 
	`¡rıy
(
tgt
->
rg‘_ty³
, "crypt");

230 
üy±_·¿ms
 = 
bufãr
 + (
dm_ioùl
è+ (
dm_rg‘_¥ec
);

231 
	`¥rštf
(
üy±_·¿ms
, "%s",
·¿m
);

232 
üy±_·¿ms
 +ğ
	`¡¾’
(crypt_params) + 1;

233 
üy±_·¿ms
 = (*) ((()crypt_params + 7) & ~8);

234 
tgt
->
Ãxt
 = 
üy±_·¿ms
 - 
bufãr
;

236 ià(
	`ioùl
(
fd
, 
DM_TABLE_LOAD
, 
io
)) {

237 
	`årštf
(
¡d”r
,"%s: CªnÙ†ßd dm-üy± m­pšgabË. (%s)\n",
__FUNCTION__
,
	`¡»¼Ü
(
”ºo
));

238 
”rout
;

242 
	`ioùl_š™
(
io
, 
DM_CRYPT_BUF_SIZE
, 
Çme
, 0);

243 ià(
	`ioùl
(
fd
, 
DM_DEV_SUSPEND
, 
io
)) {

244 
	`årštf
(
¡d”r
,"%s: CªnÙ„esumthdm-üy± deviû\n",
__FUNCTION__
);

245 
”rout
;

249 
sucûss
:

250 
»tv®
 = 0;

251 
”rout
:

252 
	`şo£
(
fd
);

253  
»tv®
;

254 
	}
}

256 
	$dm_dev_de¡roy
(cÚ¡ * 
Çme
){

257 
fd
=-1;

258 
dm_ioùl
 *
io
=
NULL
;

259 
bufãr
[
DM_CRYPT_BUF_SIZE
];

261 ià((
fd
 = 
	`İ’
("/dev/deviû-m­³r", 
O_RDWR
)) < 0) {

262 
	`årštf
(
¡d”r
,"%s: CªnÙ o³Àdeviû-m­³r\n",
__FUNCTION__
);

266 
io
 = (
dm_ioùl
 *è
bufãr
;

268 
	`ioùl_š™
(
io
, 
DM_CRYPT_BUF_SIZE
,
Çme
, 0);

269 ià(
	`ioùl
(
fd
, 
DM_DEV_REMOVE
, 
io
)) {

270 
	`årštf
(
¡d”r
,"%s: E¼Ü de¡royšg deviû m­pšg (%s)\n",
__FUNCTION__
,
	`¡»¼Ü
(
”ºo
));

271 
	`şo£
(
fd
);

274 
	`şo£
(
fd
);

276 
	}
}

281 
	$ext_check_’üy±
(cÚ¡ * 
dev·th
){

282 
fd
;

283 
buf
[512];

284 cÚ¡ 
eMMCP¬t™iÚ
 *
•
;

285 cÚ¡ *
ENCRYPT_HEADER
 = "This is‡nƒncrypted device:)";

287 
•
=
	`emmc_fšd_·¹™iÚ_by_dev
(
dev·th
);

288 if(!
•
){

289 
	`årštf
(
¡d”r
,"%s:ƒxˆ’üy±ed…¬t™iÚ mu¡ bš EMMC\n",
__FUNCTION__
);

293 if(
	`emmc_»ad
(
•
,0,(
buf
),buf)){

294 
	`årštf
(
¡d”r
,"%s: Cª'ˆ»ad h—d” fÜ %s\n",
__FUNCTION__
,
•
->
Çme
);

297 
buf
[
	`¡¾’
(
ENCRYPT_HEADER
)] = '\0';

299 ià(
buf
[0] != '\0')

300 
	`årštf
(
¡d”r
,"%s: Th’üy±iÚ h—d” i \"%s\"\n",
__FUNCTION__
,
buf
);

302 ià(!
	`¡rcmp
(
ENCRYPT_HEADER
, 
buf
))

306 
	}
}

310 
	$ext_check_’üy±_keysize
(){

311 cÚ¡ 
eMMCP¬t™iÚ
 *
•
=
NULL
;

312 
üy±_mÁ_ár
 
üy±_ár
;

314 
•
=
	`emmc_fšd_·¹™iÚ_by_Çme
(
EMMC_PARTITION_EXTRA_NAME
);

315 if(
•
==
NULL
){

316 
	`årštf
(
¡d”r
,"%s: Cª'ˆfšdƒmmø·¹™iÚ %s\n",
__FUNCTION__
,
EMMC_PARTITION_EXTRA_NAME
);

320 if(
	`emmc_»ad
(
•
 ,0,(
üy±_mÁ_ár
),&
üy±_ár
)) {

321 
	`årštf
(
¡d”r
,"%s: Cª'ˆ»adƒmmø·¹™iÚ %s\n",
__FUNCTION__
,
EMMC_PARTITION_EXTRA_NAME
);

325  
üy±_ár
.
keysize
;

326 
	}
}

331 
	$vçt_check_’üy±
(cÚ¡ * 
dev·th
,* 
keyhash
){

332 
fd
;

333 
sd’c_su³rblock
 
sb
;

335 ià((
fd
 = 
	`İ’
(
dev·th
, 
O_RDWR
)) < 0) {

336 
	`årštf
(
¡d”r
,"%s: FaØİ’ %s\n",
__FUNCTION__
,
dev·th
);

341 
	`mem£t
(&
sb
, 0, (sb));

342 ià(
	`»ad
(
fd
, &
sb
, (sb)) != (sb)) {

343 
	`årštf
(
¡d”r
,"%s: Su³rblock„—d faed %s\n",
__FUNCTION__
,
dev·th
);

344 
	`şo£
(
fd
);

348 ià(
sb
.
magic
 !ğ
SDENC_SB_MAGIC
) {

349 
	`årštf
(
¡d”r
,"%s: Bad magiønumb” (%.8x),ƒx³ùed %.8x\n",
__FUNCTION__
,
sb
.
magic
,
SDENC_SB_MAGIC
);

350 
	`şo£
(
fd
);

354 ià(
sb
.
v”
!=
SDENC_SB_VER1
&&sb.v”!=
SDENC_SB_VER2
) {

355 
	`årštf
(
¡d”r
,"%s: Bad v”siÚ (%.2x)\n",
__FUNCTION__
,
sb
.
v”
);

356 
	`şo£
(
fd
);

360 *
keyhash
=
sb
.
key_hash
;

361  
sb
.
v”
;

362 
	}
}

364 
	$vçt_check_key
(
keyhash
,* 
key
, 
keyËn
){

365 cÚ¡ * 
dig™s
 = "0123456789abcdef";

366 
sig
[
MD5_DIGEST_LENGTH
];

367 
key_tmp
[128]={0};

368 
keyHash
[33]={0};

369 
keyHash32
=0;

370 * 
p
=
NULL
;

371 
i
=0;

373 
	`memıy
(
key_tmp
,
key
,
keyËn
);

374 
	`MD5
(
key_tmp
,
keyËn
,
sig
);

376 
p
 = 
keyHash
;

377 
i
 = 0; i < 
MD5_DIGEST_LENGTH
; i++) {

378 *
p
++ = 
dig™s
[
sig
[
i
] >> 4];

379 *
p
++ = 
dig™s
[
sig
[
i
] & 0x0F];

381 *
p
 = '\0';

383 
keyHash
[8]=0;

384 
keyHash32
 = ()
	`¡¹oul
(
keyHash
,
NULL
,16);

386  
keyhash
==
keyHash32
;

387 
	}
}

	@mtdutils/encdevice.h

20 #iâdeà
ENCDEVICE_H


21 
	#ENCDEVICE_H


	)

23 
	~<sys/ty³s.h
>

24 
	~<uni¡d.h
>

26 #ifdeà
__ılu¥lus


33 
	#HTC_IOCTL_SDSERVICE
 0x9527

	)

36 
HTC_SD_KEY_ENCRYPT
 = 0x33,

37 
HTC_SD_KEY_DECRYPT
,

40 
	s_htc_sd£rviû_msg_s
 {

41 
func
;

42 
off£t
;

43 *
»q_buf
;

44 
»q_Ën
;

45 *
»¥_buf
;

46 
»¥_Ën
;

47 } 
	thtc_sd£rviû_msg_s
;

49 
tz_deüy±_key
(*
šput_buf
, *
ouut_buf
,
keyËn
);

54 
cÚv”t_key_to_hex_ascii
(*
ma¡”_key
, 
keysize
, *
ma¡”_key_ascii
);

59 
	#DEVPATHLENGTH
 1024

	)

60 
	#DM_CRYPT_BUF_SIZE
 4096

	)

62 
	#DM_TYPE_VFAT
 1

	)

63 
	#DM_TYPE_EXT
 2

	)

65 
ioùl_š™
(
dm_ioùl
 *
io
, 
size_t
 
d©aSize
, cÚ¡ *
Çme
, 
æags
);

66 
dm_dev_exi¡s
(cÚ¡ * 
Çme
,* 
dm_dev_·th
);

67 
dm_dev_fšd_Çme_by_id
(
id
,* 
Çme
);

68 
dm_dev_ü—‹
(cÚ¡ * 
Çme
,
ty³
,cÚ¡ * 
·¿m
,cÚ¡ * 
dev_·th
,* 
dm_dev_·th
);

69 
dm_dev_de¡roy
(cÚ¡ * 
Çme
);

74 
	#__Ë32
 

	)

75 
	#__Ë16
 

	)

76 
	#MAX_CRYPTO_TYPE_NAME_LEN
 64

	)

78 
	süy±_mÁ_ár
 {

79 
__Ë32
 
magic
;

80 
__Ë16
 
majÜ_v”siÚ
;

81 
__Ë16
 
mšÜ_v”siÚ
;

82 
__Ë32
 
ár_size
;

83 
__Ë32
 
æags
;

84 
__Ë32
 
keysize
;

85 
__Ë32
 
¥¬e1
;

86 
__Ë64
 
fs_size
;

87 
__Ë32
 
çed_deüy±_couÁ
;

89 
üy±o_ty³_Çme
[
MAX_CRYPTO_TYPE_NAME_LEN
];

94 
ext_check_’üy±
(cÚ¡ * 
dev·th
);

95 
ext_check_’üy±_keysize
();

100 
	#SDENC_SB_MAGIC
 0xc0deãed

	)

101 
	#SDENC_SB_VER1
 1

	)

102 
	#SDENC_SB_VER2
 2

	)

103 
	#MD5_DIGEST_LENGTH
 16

	)

105 
	ssd’c_su³rblock
 {

106 
magic
;

107 
v”
;

108 
c_ch”
;

109 
c_chaš
;

110 
c_İts
;

111 
c_mode
;

112 
key_hash
;

113 }
__©Œibu‹__
((
·cked
));

115 
vçt_check_’üy±
(cÚ¡ * 
dev·th
,* 
keyhash
);

116 
vçt_check_key
(
keyhash
,* 
key
, 
keyËn
);

118 #ifdeà
__ılu¥lus


	@mtdutils/flash_image.c

17 
	~<”ºo.h
>

18 
	~<fú.h
>

19 
	~<¡dio.h
>

20 
	~<¡dlib.h
>

21 
	~<¡ršg.h
>

22 
	~<uni¡d.h
>

24 
	~"cuts/log.h
"

25 
	~"mtduts.h
"

27 #ifdeà
LOG_TAG


28 #undeà
LOG_TAG


30 
	#LOG_TAG
 "æash_image"

	)

32 
	#HEADER_SIZE
 2048

33 

	)

34 
	$d›
(cÚ¡ *
msg
, ...) {

35 
”r
 = 
”ºo
;

36 
va_li¡
 
¬gs
;

37 
	`va_¡¬t
(
¬gs
, 
msg
);

38 
buf
[1024];

39 
	`v¢´štf
(
buf
, (buf), 
msg
, 
¬gs
);

40 
	`va_’d
(
¬gs
);

42 ià(
”r
 != 0) {

43 
	`¡¾ÿt
(
buf
, ": ", (buf));

44 
	`¡¾ÿt
(
buf
, 
	`¡»¼Ü
(
”r
), (buf));

47 
	`årštf
(
¡d”r
, "%s\n", 
buf
);

48 
	`ALOGE
("%s\n", 
buf
);

49 
	`ex™
(1);

50 
	}
}

54 
	$maš
(
¬gc
, **
¬gv
) {

55 cÚ¡ 
MtdP¬t™iÚ
 *
±n
;

56 
MtdWr™eCÚ‹xt
 *
wr™e
;

57 *
d©a
;

58 
sz
;

60 ià(
¬gc
 != 3) {

61 
	`årštf
(
¡d”r
, "u§ge: % ·¹™iÚ fe.img\n", 
¬gv
[0]);

65 ià(
	`mtd_sÿn_·¹™iÚs
(è<ğ0è
	`d›
("error scanning…artitions");

66 cÚ¡ 
MtdP¬t™iÚ
 *
·¹™iÚ
 = 
	`mtd_fšd_·¹™iÚ_by_Çme
(
¬gv
[1]);

67 ià(
·¹™iÚ
 =ğ
NULL
è
	`d›
("ÿn'ˆfšd % ·¹™iÚ", 
¬gv
[1]);

71 
fd
 = 
	`İ’
(
¬gv
[2], 
O_RDONLY
);

72 ià(
fd
 < 0è
	`d›
("”rÜ o³nšg %s", 
¬gv
[2]);

74 
h—d”
[
HEADER_SIZE
];

75 
h—d”Ën
 = 
	`TEMP_FAILURE_RETRY
(
	`»ad
(
fd
, 
h—d”
, (header)));

76 ià(
h—d”Ën
 <ğ0è
	`d›
("”rÜ„—dšg % h—d”", 
¬gv
[2]);

78 
MtdR—dCÚ‹xt
 *
š
 = 
	`mtd_»ad_·¹™iÚ
(
·¹™iÚ
);

79 ià(
š
 =ğ
NULL
) {

80 
	`ALOGW
("”rÜ o³nšg %s: %s\n", 
¬gv
[1], 
	`¡»¼Ü
(
”ºo
));

83 
check
[
HEADER_SIZE
];

84 
checkËn
 = 
	`mtd_»ad_d©a
(
š
, 
check
, (check));

85 ià(
checkËn
 <= 0) {

86 
	`ALOGW
("”rÜ„—dšg %s: %s\n", 
¬gv
[1], 
	`¡»¼Ü
(
”ºo
));

88 } ià(
checkËn
 =ğ
h—d”Ën
 && !
	`memcmp
(
h—d”
, 
check
, headerlen)) {

89 
	`ALOGI
("h—d” i th§me,‚Ù fÏshšg %s\n", 
¬gv
[1]);

92 
	`mtd_»ad_şo£
(
š
);

96 
	`ALOGI
("æashšg % äom %s\n", 
¬gv
[1],‡rgv[2]);

98 
MtdWr™eCÚ‹xt
 *
out
 = 
	`mtd_wr™e_·¹™iÚ
(
·¹™iÚ
);

99 ià(
out
 =ğ
NULL
è
	`d›
("”rÜ wr™šg %s", 
¬gv
[1]);

101 
buf
[
HEADER_SIZE
];

102 
	`mem£t
(
buf
, 0, 
h—d”Ën
);

103 
wrÙe
 = 
	`mtd_wr™e_d©a
(
out
, 
buf
, 
h—d”Ën
);

104 ià(
wrÙe
 !ğ
h—d”Ën
è
	`d›
("”rÜ wr™šg %s", 
¬gv
[1]);

106 
Ën
;

107 (
Ën
 = 
	`TEMP_FAILURE_RETRY
(
	`»ad
(
fd
, 
buf
, (buf)))) > 0) {

108 
wrÙe
 = 
	`mtd_wr™e_d©a
(
out
, 
buf
, 
Ën
);

109 ià(
wrÙe
 !ğ
Ën
è
	`d›
("”rÜ wr™šg %s", 
¬gv
[1]);

111 ià(
Ën
 < 0è
	`d›
("”rÜ„—dšg %s", 
¬gv
[2]);

113 ià(
	`mtd_wr™e_şo£
(
out
)è
	`d›
("”rÜ closšg %s", 
¬gv
[1]);

117 
out
 = 
	`mtd_wr™e_·¹™iÚ
(
·¹™iÚ
);

118 ià(
out
 =ğ
NULL
è
	`d›
("”rÜ„e-İ’šg %s", 
¬gv
[1]);

120 
wrÙe
 = 
	`mtd_wr™e_d©a
(
out
, 
h—d”
, 
h—d”Ën
);

121 ià(
wrÙe
 !ğ
h—d”Ën
è
	`d›
("”rÜ„e-wr™šg %s", 
¬gv
[1]);

124 
size_t
 
block_size
;

125 ià(
	`mtd_·¹™iÚ_šfo
(
·¹™iÚ
, 
NULL
, &
block_size
, NULL))

126 
	`d›
("”rÜ g‘tšg % block size", 
¬gv
[1]);

128 ià(
	`TEMP_FAILURE_RETRY
(
	`l£ek
(
fd
, 
h—d”Ën
, 
SEEK_SET
)) != headerlen)

129 
	`d›
("”rÜ„ewšdšg %s", 
¬gv
[2]);

131 
Ëá
 = 
block_size
 - 
h—d”Ën
;

132 
Ëá
 < 0èËá +ğ
block_size
;

133 
Ëá
 > 0) {

134 
Ën
 = 
	`TEMP_FAILURE_RETRY
(
	`»ad
(
fd
, 
buf
, 
Ëá
 > ()(buf) ? ()(buf) :†eft));

135 ià(
Ën
 <ğ0è
	`d›
("”rÜ„—dšg %s", 
¬gv
[2]);

136 ià(
	`mtd_wr™e_d©a
(
out
, 
buf
, 
Ën
) !=†en)

137 
	`d›
("”rÜ wr™šg %s", 
¬gv
[1]);

138 
Ëá
 -ğ
Ën
;

141 ià(
	`mtd_wr™e_şo£
(
out
)è
	`d›
("”rÜ closšg %s", 
¬gv
[1]);

143 
	}
}

	@mtdutils/mounts.c

17 
	~<mÁ’t.h
>

18 
	~<¡dio.h
>

19 
	~<¡dlib.h
>

20 
	~<¡ršg.h
>

21 
	~<fú.h
>

22 
	~<”ºo.h
>

23 
	~<sys/mouÁ.h
>

25 
	~"mouÁs.h
"

27 
	~"sduts.h
"

28 
	~"emmcuts.h
"

30 
	sMouÁedVŞume
 {

31 cÚ¡ *
	mdeviû
;

32 cÚ¡ *
	mmouÁ_pošt
;

33 cÚ¡ *
	mfesy¡em
;

34 cÚ¡ *
	mæags
;

38 
MouÁedVŞume
 *
	mvŞumes
;

39 
	mvŞumes_®locd
;

40 
	mvŞume_couÁ
;

41 } 
	tMouÁsS‹
;

43 
MouÁsS‹
 
	gg_mouÁs_¡©e
 = {

44 
NULL
,

49 
šlše
 

50 
	$ä“_vŞume_š‹º®s
(cÚ¡ 
MouÁedVŞume
 *
vŞume
, 
z”o
)

52 
	`ä“
((*)
vŞume
->
deviû
);

53 
	`ä“
((*)
vŞume
->
mouÁ_pošt
);

54 
	`ä“
((*)
vŞume
->
fesy¡em
);

55 
	`ä“
((*)
vŞume
->
æags
);

56 ià(
z”o
) {

57 
	`mem£t
((*)
vŞume
, 0, (*volume));

59 
	}
}

61 
	#PROC_MOUNTS_FILENAME
 "/´oc/mouÁs"

	)

64 
	$sÿn_mouÁed_vŞumes
()

66 
FILE
* 
å
;

67 
mÁ’t
* 
m’Œy
;

69 ià(
g_mouÁs_¡©e
.
vŞumes
 =ğ
NULL
) {

70 cÚ¡ 
numv
 = 32;

71 
MouÁedVŞume
 *
vŞumes
 = 
	`m®loc
(
numv
 * (*volumes));

72 ià(
vŞumes
 =ğ
NULL
) {

73 
”ºo
 = 
ENOMEM
;

76 
g_mouÁs_¡©e
.
vŞumes
 = volumes;

77 
g_mouÁs_¡©e
.
vŞumes_®locd
 = 
numv
;

78 
	`mem£t
(
vŞumes
, 0, 
numv
 * (*volumes));

82 
i
;

83 
i
 = 0; i < 
g_mouÁs_¡©e
.
vŞume_couÁ
; i++) {

84 
	`ä“_vŞume_š‹º®s
(&
g_mouÁs_¡©e
.
vŞumes
[
i
], 1);

87 
g_mouÁs_¡©e
.
vŞume_couÁ
 = 0;

90 
å
 = 
	`£tmÁ’t
(
PROC_MOUNTS_FILENAME
, "r");

91 ià(
å
 =ğ
NULL
) {

94 (
m’Œy
 = 
	`g‘mÁ’t
(
å
)è!ğ
NULL
) {

95 
MouÁedVŞume
* 
v
 = &
g_mouÁs_¡©e
.
vŞumes
[g_mouÁs_¡©e.
vŞume_couÁ
++];

96 
v
->
deviû
 = 
	`¡rdup
(
m’Œy
->
mÁ_f¢ame
);

97 
v
->
mouÁ_pošt
 = 
	`¡rdup
(
m’Œy
->
mÁ_dœ
);

98 
v
->
fesy¡em
 = 
	`¡rdup
(
m’Œy
->
mÁ_ty³
);

99 
v
->
æags
 = 
	`¡rdup
(
m’Œy
->
mÁ_İts
);

101 
	`’dmÁ’t
(
å
);

103 
	}
}

105 cÚ¡ 
MouÁedVŞume
 *

106 
	$fšd_mouÁed_vŞume_by_deviû
(cÚ¡ *
deviû
)

108 ià(
g_mouÁs_¡©e
.
vŞumes
 !ğ
NULL
) {

109 
i
;

110 
i
 = 0; i < 
g_mouÁs_¡©e
.
vŞume_couÁ
; i++) {

111 
MouÁedVŞume
 *
v
 = &
g_mouÁs_¡©e
.
vŞumes
[
i
];

114 ià(
v
->
deviû
 !ğ
NULL
) {

115 ià(
	`¡rcmp
(
v
->
deviû
, device) == 0) {

116  
v
;

121  
NULL
;

122 
	}
}

124 cÚ¡ 
MouÁedVŞume
 *

125 
	$fšd_mouÁed_vŞume_by_mouÁ_pošt
(cÚ¡ *
mouÁ_pošt
)

127 ià(
g_mouÁs_¡©e
.
vŞumes
 !ğ
NULL
) {

128 
i
;

129 
i
 = 0; i < 
g_mouÁs_¡©e
.
vŞume_couÁ
; i++) {

130 
MouÁedVŞume
 *
v
 = &
g_mouÁs_¡©e
.
vŞumes
[
i
];

133 ià(
v
->
mouÁ_pošt
 !ğ
NULL
) {

134 ià(
	`¡rcmp
(
v
->
mouÁ_pošt
, mount_point) == 0) {

135  
v
;

140  
NULL
;

141 
	}
}

144 
	$unmouÁ_mouÁed_vŞume
(cÚ¡ 
MouÁedVŞume
 *
vŞume
)

150 
»t
;

151 if(
	`¡ºcmp
(
vŞume
->
mouÁ_pošt
,"/sdÿrd",
	`¡¾’
("/sdcard"))==0){

153 
»t
=
	`sd_umouÁ_·¹™iÚ
(
vŞume
->
deviû
,vŞume->
mouÁ_pošt
);

156 
»t
=
	`emmc_umouÁ_·¹™iÚ
(
vŞume
->
deviû
,vŞume->
mouÁ_pošt
);

158 ià(
»t
 == 0) {

159 
	`ä“_vŞume_š‹º®s
(
vŞume
, 1);

162  
»t
;

163 
	}
}

166 
	$»mouÁ_»ad_Úly
(cÚ¡ 
MouÁedVŞume
* 
vŞume
)

168  
	`mouÁ
(
vŞume
->
deviû
, vŞume->
mouÁ_pošt
, vŞume->
fesy¡em
,

169 
MS_NOATIME
 | 
MS_NODEV
 | 
MS_NODIRATIME
 |

170 
MS_RDONLY
 | 
MS_REMOUNT
, 0);

171 
	}
}

	@mtdutils/mounts.h

17 #iâdeà
MTDUTILS_MOUNTS_H_


18 
	#MTDUTILS_MOUNTS_H_


	)

20 #ifdeà
__ılu¥lus


24 
MouÁedVŞume
 
	tMouÁedVŞume
;

26 
sÿn_mouÁed_vŞumes
();

28 cÚ¡ 
MouÁedVŞume
 *
fšd_mouÁed_vŞume_by_deviû
(cÚ¡ *
deviû
);

30 cÚ¡ 
MouÁedVŞume
 *

31 
fšd_mouÁed_vŞume_by_mouÁ_pošt
(cÚ¡ *
mouÁ_pošt
);

33 
unmouÁ_mouÁed_vŞume
(cÚ¡ 
MouÁedVŞume
 *
vŞume
);

35 
»mouÁ_»ad_Úly
(cÚ¡ 
MouÁedVŞume
* 
vŞume
);

37 #ifdeà
__ılu¥lus


	@mtdutils/mtdutils.c

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<¡ršg.h
>

20 
	~<uni¡d.h
>

21 
	~<fú.h
>

22 
	~<”ºo.h
>

23 
	~<sys/mouÁ.h
>

24 
	~<sys/¡©.h
>

25 
	~<mtd/mtd-u£r.h
>

26 #undeà
NDEBUG


27 
	~<as£¹.h
>

29 
	~"mtduts.h
"

31 
	sMtdP¬t™iÚ
 {

32 
	mdeviû_šdex
;

33 
	msize
;

34 
	m”a£_size
;

35 *
	mÇme
;

38 
	sMtdR—dCÚ‹xt
 {

39 cÚ¡ 
MtdP¬t™iÚ
 *
	m·¹™iÚ
;

40 *
	mbufãr
;

41 
size_t
 
	mcÚsumed
;

42 
	mfd
;

45 
	sMtdWr™eCÚ‹xt
 {

46 cÚ¡ 
MtdP¬t™iÚ
 *
	m·¹™iÚ
;

47 *
	mbufãr
;

48 
size_t
 
	m¡Üed
;

49 
	mfd
;

51 
off_t
* 
	mbad_block_off£ts
;

52 
	mbad_block_®loc
;

53 
	mbad_block_couÁ
;

57 
MtdP¬t™iÚ
 *
	m·¹™iÚs
;

58 
	m·¹™iÚs_®locd
;

59 
	m·¹™iÚ_couÁ
;

60 } 
	tMtdS‹
;

62 
MtdS‹
 
	gg_mtd_¡©e
 = {

63 
NULL
,

68 
	#MTD_PROC_FILENAME
 "/´oc/mtd"

	)

71 
	$mtd_sÿn_·¹™iÚs
()

73 
buf
[2048];

74 cÚ¡ *
buå
;

75 
fd
;

76 
i
;

77 
ssize_t
 
nby‹s
;

79 ià(
g_mtd_¡©e
.
·¹™iÚs
 =ğ
NULL
) {

80 cÚ¡ 
nump
 = 32;

81 
MtdP¬t™iÚ
 *
·¹™iÚs
 = 
	`m®loc
(
nump
 * (*partitions));

82 ià(
·¹™iÚs
 =ğ
NULL
) {

83 
”ºo
 = 
ENOMEM
;

86 
g_mtd_¡©e
.
·¹™iÚs
 =…artitions;

87 
g_mtd_¡©e
.
·¹™iÚs_®locd
 = 
nump
;

88 
	`mem£t
(
·¹™iÚs
, 0, 
nump
 * (*partitions));

90 
g_mtd_¡©e
.
·¹™iÚ_couÁ
 = 0;

96 
i
 = 0; i < 
g_mtd_¡©e
.
·¹™iÚs_®locd
; i++) {

97 
MtdP¬t™iÚ
 *
p
 = &
g_mtd_¡©e
.
·¹™iÚs
[
i
];

98 ià(
p
->
Çme
 !ğ
NULL
) {

99 
	`ä“
(
p
->
Çme
);

100 
p
->
Çme
 = 
NULL
;

102 
p
->
deviû_šdex
 = -1;

107 
fd
 = 
	`İ’
(
MTD_PROC_FILENAME
, 
O_RDONLY
);

108 ià(
fd
 < 0) {

109 
ba
;

111 
nby‹s
 = 
	`TEMP_FAILURE_RETRY
(
	`»ad
(
fd
, 
buf
, (buf) - 1));

112 
	`şo£
(
fd
);

113 ià(
nby‹s
 < 0) {

114 
ba
;

116 
buf
[
nby‹s
] = '\0';

129 
buå
 = 
buf
;

130 
nby‹s
 > 0) {

131 
mtdnum
, 
mtdsize
, 
mtd”a£size
;

132 
m©ches
;

133 
mtdÇme
[64];

134 
mtdÇme
[0] = '\0';

135 
mtdnum
 = -1;

137 
m©ches
 = 
	`ssÿnf
(
buå
, "mtd%d: %x %x \"%63[^\"]",

138 &
mtdnum
, &
mtdsize
, &
mtd”a£size
, 
mtdÇme
);

142 ià(
m©ches
 == 4) {

143 
MtdP¬t™iÚ
 *
p
 = &
g_mtd_¡©e
.
·¹™iÚs
[
mtdnum
];

144 
p
->
deviû_šdex
 = 
mtdnum
;

145 
p
->
size
 = 
mtdsize
;

146 
p
->
”a£_size
 = 
mtd”a£size
;

147 
p
->
Çme
 = 
	`¡rdup
(
mtdÇme
);

148 ià(
p
->
Çme
 =ğ
NULL
) {

149 
”ºo
 = 
ENOMEM
;

150 
ba
;

152 
g_mtd_¡©e
.
·¹™iÚ_couÁ
++;

157 
nby‹s
 > 0 && *
buå
 != '\n') {

158 
buå
++;

159 
nby‹s
--;

161 ià(
nby‹s
 > 0) {

162 
buå
++;

163 
nby‹s
--;

167  
g_mtd_¡©e
.
·¹™iÚ_couÁ
;

169 
ba
:

171 
g_mtd_¡©e
.
·¹™iÚ_couÁ
 = -1;

173 
	}
}

175 cÚ¡ 
MtdP¬t™iÚ
 *

176 
	$mtd_fšd_·¹™iÚ_by_Çme
(cÚ¡ *
Çme
)

178 ià(
g_mtd_¡©e
.
·¹™iÚs
 !ğ
NULL
) {

179 
i
;

180 
i
 = 0; i < 
g_mtd_¡©e
.
·¹™iÚs_®locd
; i++) {

181 
MtdP¬t™iÚ
 *
p
 = &
g_mtd_¡©e
.
·¹™iÚs
[
i
];

182 ià(
p
->
deviû_šdex
 >ğ0 &&…->
Çme
 !ğ
NULL
) {

183 ià(
	`¡rcmp
(
p
->
Çme
,‚ame) == 0) {

184  
p
;

189  
NULL
;

190 
	}
}

193 
	$mtd_mouÁ_·¹™iÚ
(cÚ¡ 
MtdP¬t™iÚ
 *
·¹™iÚ
, cÚ¡ *
mouÁ_pošt
,

194 cÚ¡ *
fesy¡em
, 
»ad_Úly
)

196 cÚ¡ 
æags
 = 
MS_NOATIME
 | 
MS_NODEV
 | 
MS_NODIRATIME
;

197 
devÇme
[64];

198 
rv
 = -1;

200 
	`¥rštf
(
devÇme
, "/dev/block/mtdblock%d", 
·¹™iÚ
->
deviû_šdex
);

201 ià(!
»ad_Úly
) {

202 
rv
 = 
	`mouÁ
(
devÇme
, 
mouÁ_pošt
, 
fesy¡em
, 
æags
, 
NULL
);

204 ià(
»ad_Úly
 || 
rv
 < 0) {

205 
rv
 = 
	`mouÁ
(
devÇme
, 
mouÁ_pošt
, 
fesy¡em
, 
æags
 | 
MS_RDONLY
, 0);

206 ià(
rv
 < 0) {

207 
	`´štf
("Failedo mount %s on %s: %s\n",

208 
devÇme
, 
mouÁ_pošt
, 
	`¡»¼Ü
(
”ºo
));

210 
	`´štf
("MouÁ % Ú % »ad-Úly\n", 
devÇme
, 
mouÁ_pošt
);

214 ià(
rv
 >= 0) {

218 
¡©
 
¡
;

219 
rv
 = 
	`¡©
(
mouÁ_pošt
, &
¡
);

220 ià(
rv
 < 0) {

221  
rv
;

223 
mode_t
 
Ãw_mode
 = 
¡
.
¡_mode
 | 
S_IXUSR
 | 
S_IXGRP
 | 
S_IXOTH
;

224 ià(
Ãw_mode
 !ğ
¡
.
¡_mode
) {

225 
	`´štf
("Fixšgƒxecu‹…”missiÚ fÜ %s\n", 
mouÁ_pošt
);

226 
rv
 = 
	`chmod
(
mouÁ_pošt
, 
Ãw_mode
);

227 ià(
rv
 < 0) {

228 
	`´štf
("Couldn't fix…ermissions for %s: %s\n",

229 
mouÁ_pošt
, 
	`¡»¼Ü
(
”ºo
));

234  
rv
;

235 
	}
}

238 
	$mtd_·¹™iÚ_šfo
(cÚ¡ 
MtdP¬t™iÚ
 *
·¹™iÚ
,

239 
size_t
 *
tÙ®_size
, size_ˆ*
”a£_size
, size_ˆ*
wr™e_size
)

241 
mtddevÇme
[32];

242 
	`¥rštf
(
mtddevÇme
, "/dev/mtd/mtd%d", 
·¹™iÚ
->
deviû_šdex
);

243 
fd
 = 
	`İ’
(
mtddevÇme
, 
O_RDONLY
);

244 ià(
fd
 < 0)  -1;

246 
mtd_šfo_u£r
 
mtd_šfo
;

247 
»t
 = 
	`ioùl
(
fd
, 
MEMGETINFO
, &
mtd_šfo
);

248 
	`şo£
(
fd
);

249 ià(
»t
 < 0)  -1;

251 ià(
tÙ®_size
 !ğ
NULL
è*tÙ®_sizğ
mtd_šfo
.
size
;

252 ià(
”a£_size
 !ğ
NULL
è*”a£_sizğ
mtd_šfo
.
”a£size
;

253 ià(
wr™e_size
 !ğ
NULL
è*wr™e_sizğ
mtd_šfo
.
wr™esize
;

255 
	}
}

257 
MtdR—dCÚ‹xt
 *
	$mtd_»ad_·¹™iÚ
(cÚ¡ 
MtdP¬t™iÚ
 *
·¹™iÚ
)

259 
MtdR—dCÚ‹xt
 *
ùx
 = (MtdR—dCÚ‹xt*è
	`m®loc
((MtdReadContext));

260 ià(
ùx
 =ğ
NULL
)  NULL;

262 
ùx
->
bufãr
 = 
	`m®loc
(
·¹™iÚ
->
”a£_size
);

263 ià(
ùx
->
bufãr
 =ğ
NULL
) {

264 
	`ä“
(
ùx
);

265  
NULL
;

268 
mtddevÇme
[32];

269 
	`¥rštf
(
mtddevÇme
, "/dev/mtd/mtd%d", 
·¹™iÚ
->
deviû_šdex
);

270 
ùx
->
fd
 = 
	`İ’
(
mtddevÇme
, 
O_RDONLY
);

271 ià(
ùx
->
fd
 < 0) {

272 
	`ä“
(
ùx
->
bufãr
);

273 
	`ä“
(
ùx
);

274  
NULL
;

277 
ùx
->
·¹™iÚ
 =…artition;

278 
ùx
->
cÚsumed
 = 
·¹™iÚ
->
”a£_size
;

279  
ùx
;

280 
	}
}

282 
	$»ad_block
(cÚ¡ 
MtdP¬t™iÚ
 *
·¹™iÚ
, 
fd
, *
d©a
)

284 
mtd_ecc_¡©s
 
befÜe
, 
aá”
;

285 ià(
	`ioùl
(
fd
, 
ECCGETSTATS
, &
befÜe
)) {

286 
	`´štf
("mtd: ECCGETSTATSƒ¼Ü (%s)\n", 
	`¡»¼Ü
(
”ºo
));

290 
loff_t
 
pos
 = 
	`TEMP_FAILURE_RETRY
(
	`l£ek64
(
fd
, 0, 
SEEK_CUR
));

291 ià(
pos
 == -1) {

292 
	`´štf
("mtd:„—d_block: couldn'ˆSEEK_CUR: %s\n", 
	`¡»¼Ü
(
”ºo
));

296 
ssize_t
 
size
 = 
·¹™iÚ
->
”a£_size
;

297 
mgbb
;

299 
pos
 + 
size
 <ğ(è
·¹™iÚ
->size) {

300 ià(
	`TEMP_FAILURE_RETRY
(
	`l£ek64
(
fd
, 
pos
, 
SEEK_SET
)) !=…os ||

301 
	`TEMP_FAILURE_RETRY
(
	`»ad
(
fd
, 
d©a
, 
size
)) != size) {

302 
	`´štf
("mtd:„eadƒrror‡t 0x%08llx (%s)\n",

303 ()
pos
, 
	`¡»¼Ü
(
”ºo
));

304 } ià(
	`ioùl
(
fd
, 
ECCGETSTATS
, &
aá”
)) {

305 
	`´štf
("mtd: ECCGETSTATSƒ¼Ü (%s)\n", 
	`¡»¼Ü
(
”ºo
));

307 } ià(
aá”
.
çed
 !ğ
befÜe
.failed) {

308 
	`´štf
("mtd: ECCƒrrors (%d soft, %d hard)‡t 0x%08llx\n",

309 
aá”
.
cÜ»ùed
 - 
befÜe
.corrected,

310 
aá”
.
çed
 - 
befÜe
.çed, ()
pos
);

312 
	`memıy
(&
befÜe
, &
aá”
, (
mtd_ecc_¡©s
));

313 } ià((
mgbb
 = 
	`ioùl
(
fd
, 
MEMGETBADBLOCK
, &
pos
))) {

314 
	`årštf
(
¡d”r
,

316 
mgbb
, ()
pos
, 
	`¡»¼Ü
(
”ºo
));

321 
pos
 +ğ
·¹™iÚ
->
”a£_size
;

324 
”ºo
 = 
ENOSPC
;

326 
	}
}

328 
ssize_t
 
	$mtd_»ad_d©a
(
MtdR—dCÚ‹xt
 *
ùx
, *
d©a
, 
size_t
 
Ën
)

330 
size_t
 
»ad
 = 0;

331 
»ad
 < 
Ën
) {

332 ià(
ùx
->
cÚsumed
 < ctx->
·¹™iÚ
->
”a£_size
) {

333 
size_t
 
ava
 = 
ùx
->
·¹™iÚ
->
”a£_size
 - ctx->
cÚsumed
;

334 
size_t
 
cİy
 = 
Ën
 - 
»ad
 < 
ava
 ?†en -„ead :‡vail;

335 
	`memıy
(
d©a
 + 
»ad
, 
ùx
->
bufãr
 + ctx->
cÚsumed
, 
cİy
);

336 
ùx
->
cÚsumed
 +ğ
cİy
;

337 
»ad
 +ğ
cİy
;

341 
ùx
->
cÚsumed
 =ğùx->
·¹™iÚ
->
”a£_size
 &&

342 
Ën
 - 
»ad
 >ğ
ùx
->
·¹™iÚ
->
”a£_size
) {

343 ià(
	`»ad_block
(
ùx
->
·¹™iÚ
, ctx->
fd
, 
d©a
 + 
»ad
))  -1;

344 
»ad
 +ğ
ùx
->
·¹™iÚ
->
”a£_size
;

347 ià(
»ad
 >ğ
Ën
) {

348  
»ad
;

352 ià(
ùx
->
cÚsumed
 =ğùx->
·¹™iÚ
->
”a£_size
 && 
»ad
 < 
Ën
) {

353 ià(
	`»ad_block
(
ùx
->
·¹™iÚ
, ctx->
fd
, ctx->
bufãr
))  -1;

354 
ùx
->
cÚsumed
 = 0;

358  
»ad
;

359 
	}
}

361 
	$mtd_»ad_şo£
(
MtdR—dCÚ‹xt
 *
ùx
)

363 
	`şo£
(
ùx
->
fd
);

364 
	`ä“
(
ùx
->
bufãr
);

365 
	`ä“
(
ùx
);

366 
	}
}

368 
MtdWr™eCÚ‹xt
 *
	$mtd_wr™e_·¹™iÚ
(cÚ¡ 
MtdP¬t™iÚ
 *
·¹™iÚ
)

370 
MtdWr™eCÚ‹xt
 *
ùx
 = (MtdWr™eCÚ‹xt*è
	`m®loc
((MtdWriteContext));

371 ià(
ùx
 =ğ
NULL
)  NULL;

373 
ùx
->
bad_block_off£ts
 = 
NULL
;

374 
ùx
->
bad_block_®loc
 = 0;

375 
ùx
->
bad_block_couÁ
 = 0;

377 
ùx
->
bufãr
 = 
	`m®loc
(
·¹™iÚ
->
”a£_size
);

378 ià(
ùx
->
bufãr
 =ğ
NULL
) {

379 
	`ä“
(
ùx
);

380  
NULL
;

383 
mtddevÇme
[32];

384 
	`¥rštf
(
mtddevÇme
, "/dev/mtd/mtd%d", 
·¹™iÚ
->
deviû_šdex
);

385 
ùx
->
fd
 = 
	`İ’
(
mtddevÇme
, 
O_RDWR
);

386 ià(
ùx
->
fd
 < 0) {

387 
	`ä“
(
ùx
->
bufãr
);

388 
	`ä“
(
ùx
);

389  
NULL
;

392 
ùx
->
·¹™iÚ
 =…artition;

393 
ùx
->
¡Üed
 = 0;

394  
ùx
;

395 
	}
}

397 
	$add_bad_block_off£t
(
MtdWr™eCÚ‹xt
 *
ùx
, 
off_t
 
pos
) {

398 ià(
ùx
->
bad_block_couÁ
 + 1 > ctx->
bad_block_®loc
) {

399 
ùx
->
bad_block_®loc
 = (ctx->bad_block_alloc*2) + 1;

400 
ùx
->
bad_block_off£ts
 = 
	`»®loc
(ctx->bad_block_offsets,

401 
ùx
->
bad_block_®loc
 * (
off_t
));

403 
ùx
->
bad_block_off£ts
[ùx->
bad_block_couÁ
++] = 
pos
;

404 
	}
}

406 
	$wr™e_block
(
MtdWr™eCÚ‹xt
 *
ùx
, cÚ¡ *
d©a
)

408 cÚ¡ 
MtdP¬t™iÚ
 *
·¹™iÚ
 = 
ùx
->partition;

409 
fd
 = 
ùx
->fd;

411 
off_t
 
pos
 = 
	`TEMP_FAILURE_RETRY
(
	`l£ek
(
fd
, 0, 
SEEK_CUR
));

412 ià(
pos
 =ğ(
off_t
) -1) {

413 
	`´štf
("mtd: wr™e_block: couldn'ˆSEEK_CUR: %s\n", 
	`¡»¼Ü
(
”ºo
));

417 
ssize_t
 
size
 = 
·¹™iÚ
->
”a£_size
;

418 
pos
 + 
size
 <ğ(è
·¹™iÚ
->size) {

419 
loff_t
 
bpos
 = 
pos
;

420 
»t
 = 
	`ioùl
(
fd
, 
MEMGETBADBLOCK
, &
bpos
);

421 ià(
»t
 !ğ0 && !Ô‘ =ğ-1 && 
”ºo
 =ğ
EOPNOTSUPP
)) {

422 
	`add_bad_block_off£t
(
ùx
, 
pos
);

423 
	`årštf
(
¡d”r
,

425 
pos
, 
»t
, 
	`¡»¼Ü
(
”ºo
));

426 
pos
 +ğ
·¹™iÚ
->
”a£_size
;

430 
”a£_šfo_u£r
 
”a£_šfo
;

431 
”a£_šfo
.
¡¬t
 = 
pos
;

432 
”a£_šfo
.
Ëngth
 = 
size
;

433 
»Œy
;

434 
»Œy
 = 0;„etry < 2; ++retry) {

435 ià(
	`ioùl
(
fd
, 
MEMERASE
, &
”a£_šfo
) < 0) {

436 
	`´štf
("mtd:ƒrase failure‡t 0x%08lx (%s)\n",

437 
pos
, 
	`¡»¼Ü
(
”ºo
));

440 ià(
	`TEMP_FAILURE_RETRY
(
	`l£ek
(
fd
, 
pos
, 
SEEK_SET
)) !=…os ||

441 
	`TEMP_FAILURE_RETRY
(
	`wr™e
(
fd
, 
d©a
, 
size
)) != size) {

442 
	`´štf
("mtd: writeƒrror‡t 0x%08lx (%s)\n",

443 
pos
, 
	`¡»¼Ü
(
”ºo
));

446 
v”ify
[
size
];

447 ià(
	`TEMP_FAILURE_RETRY
(
	`l£ek
(
fd
, 
pos
, 
SEEK_SET
)) !=…os ||

448 
	`TEMP_FAILURE_RETRY
(
	`»ad
(
fd
, 
v”ify
, 
size
)) != size) {

449 
	`´štf
("mtd:„e-readƒrror‡t 0x%08lx (%s)\n",

450 
pos
, 
	`¡»¼Ü
(
”ºo
));

453 ià(
	`memcmp
(
d©a
, 
v”ify
, 
size
) != 0) {

454 
	`´štf
("mtd: verificationƒrror‡t 0x%08lx (%s)\n",

455 
pos
, 
	`¡»¼Ü
(
”ºo
));

459 ià(
»Œy
 > 0) {

460 
	`´štf
("mtd: wrÙblock‡á” %d„‘r›s\n", 
»Œy
);

462 
	`´štf
("mtd: sucûssfuÎy wrÙblock‡ˆ%lx\n", 
pos
);

467 
	`add_bad_block_off£t
(
ùx
, 
pos
);

468 
	`´štf
("mtd: skpšg wr™block‡ˆ0x%08lx\n", 
pos
);

469 
	`ioùl
(
fd
, 
MEMERASE
, &
”a£_šfo
);

470 
pos
 +ğ
·¹™iÚ
->
”a£_size
;

474 
”ºo
 = 
ENOSPC
;

476 
	}
}

478 
ssize_t
 
	$mtd_wr™e_d©a
(
MtdWr™eCÚ‹xt
 *
ùx
, cÚ¡ *
d©a
, 
size_t
 
Ën
)

480 
size_t
 
wrÙe
 = 0;

481 
wrÙe
 < 
Ën
) {

483 ià(
ùx
->
¡Üed
 > 0 || 
Ën
 - 
wrÙe
 < ctx->
·¹™iÚ
->
”a£_size
) {

484 
size_t
 
ava
 = 
ùx
->
·¹™iÚ
->
”a£_size
 - ctx->
¡Üed
;

485 
size_t
 
cİy
 = 
Ën
 - 
wrÙe
 < 
ava
 ?†en - wrote :‡vail;

486 
	`memıy
(
ùx
->
bufãr
 + ctx->
¡Üed
, 
d©a
 + 
wrÙe
, 
cİy
);

487 
ùx
->
¡Üed
 +ğ
cİy
;

488 
wrÙe
 +ğ
cİy
;

492 ià(
ùx
->
¡Üed
 =ğùx->
·¹™iÚ
->
”a£_size
) {

493 ià(
	`wr™e_block
(
ùx
, ctx->
bufãr
))  -1;

494 
ùx
->
¡Üed
 = 0;

498 
ùx
->
¡Üed
 =ğ0 && 
Ën
 - 
wrÙe
 >ğùx->
·¹™iÚ
->
”a£_size
) {

499 ià(
	`wr™e_block
(
ùx
, 
d©a
 + 
wrÙe
))  -1;

500 
wrÙe
 +ğ
ùx
->
·¹™iÚ
->
”a£_size
;

504  
wrÙe
;

505 
	}
}

507 
off_t
 
	$mtd_”a£_blocks
(
MtdWr™eCÚ‹xt
 *
ùx
, 
blocks
)

510 ià(
ùx
->
¡Üed
 > 0) {

511 
size_t
 
z”o
 = 
ùx
->
·¹™iÚ
->
”a£_size
 - ctx->
¡Üed
;

512 
	`mem£t
(
ùx
->
bufãr
 + ctx->
¡Üed
, 0, 
z”o
);

513 ià(
	`wr™e_block
(
ùx
, ctx->
bufãr
))  -1;

514 
ùx
->
¡Üed
 = 0;

517 
off_t
 
pos
 = 
	`TEMP_FAILURE_RETRY
(
	`l£ek
(
ùx
->
fd
, 0, 
SEEK_CUR
));

518 ià((
off_t
è
pos
 == (off_t) -1) {

519 
	`´štf
("mtd_”a£_blocks: couldn'ˆSEEK_CUR: %s\n", 
	`¡»¼Ü
(
”ºo
));

523 cÚ¡ 
tÙ®
 = (
ùx
->
·¹™iÚ
->
size
 - 
pos
è/ ctx->·¹™iÚ->
”a£_size
;

524 ià(
blocks
 < 0èblock ğ
tÙ®
;

525 ià(
blocks
 > 
tÙ®
) {

526 
”ºo
 = 
ENOSPC
;

531 
blocks
-- > 0) {

532 
loff_t
 
bpos
 = 
pos
;

533 ià(
	`ioùl
(
ùx
->
fd
, 
MEMGETBADBLOCK
, &
bpos
) > 0) {

534 
	`´štf
("mtd:‚Ùƒ¿sšg bad block‡ˆ0x%08lx\n", 
pos
);

535 
pos
 +ğ
ùx
->
·¹™iÚ
->
”a£_size
;

539 
”a£_šfo_u£r
 
”a£_šfo
;

540 
”a£_šfo
.
¡¬t
 = 
pos
;

541 
”a£_šfo
.
Ëngth
 = 
ùx
->
·¹™iÚ
->
”a£_size
;

542 ià(
	`ioùl
(
ùx
->
fd
, 
MEMERASE
, &
”a£_šfo
) < 0) {

543 
	`´štf
("mtd:ƒ¿£ fau»‡ˆ0x%08lx\n", 
pos
);

545 
pos
 +ğ
ùx
->
·¹™iÚ
->
”a£_size
;

548  
pos
;

549 
	}
}

551 
	$mtd_wr™e_şo£
(
MtdWr™eCÚ‹xt
 *
ùx
)

553 
r
 = 0;

555 ià(
	`mtd_”a£_blocks
(
ùx
, 0è=ğ(
off_t
è-1è
r
 = -1;

556 ià(
	`şo£
(
ùx
->
fd
)è
r
 = -1;

557 
	`ä“
(
ùx
->
bad_block_off£ts
);

558 
	`ä“
(
ùx
->
bufãr
);

559 
	`ä“
(
ùx
);

560  
r
;

561 
	}
}

	@mtdutils/mtdutils.h

17 #iâdeà
MTDUTILS_H_


18 
	#MTDUTILS_H_


	)

20 
	~<sys/ty³s.h
>

22 #ifdeà
__ılu¥lus


26 
MtdP¬t™iÚ
 
	tMtdP¬t™iÚ
;

28 
mtd_sÿn_·¹™iÚs
();

30 cÚ¡ 
MtdP¬t™iÚ
 *
mtd_fšd_·¹™iÚ_by_Çme
(cÚ¡ *
Çme
);

35 
mtd_mouÁ_·¹™iÚ
(cÚ¡ 
MtdP¬t™iÚ
 *
·¹™iÚ
, cÚ¡ *
mouÁ_pošt
,

36 cÚ¡ *
fesy¡em
, 
»ad_Úly
);

40 
mtd_·¹™iÚ_šfo
(cÚ¡ 
MtdP¬t™iÚ
 *
·¹™iÚ
,

41 
size_t
 *
tÙ®_size
, size_ˆ*
”a£_size
, size_ˆ*
wr™e_size
);

46 
MtdR—dCÚ‹xt
 
	tMtdR—dCÚ‹xt
;

47 
MtdWr™eCÚ‹xt
 
	tMtdWr™eCÚ‹xt
;

49 
MtdR—dCÚ‹xt
 *
mtd_»ad_·¹™iÚ
(cÚ¡ 
MtdP¬t™iÚ
 *);

50 
ssize_t
 
mtd_»ad_d©a
(
MtdR—dCÚ‹xt
 *, *
d©a
, 
size_t
 
d©a_Ën
);

51 
mtd_»ad_şo£
(
MtdR—dCÚ‹xt
 *);

53 
MtdWr™eCÚ‹xt
 *
mtd_wr™e_·¹™iÚ
(cÚ¡ 
MtdP¬t™iÚ
 *);

54 
ssize_t
 
mtd_wr™e_d©a
(
MtdWr™eCÚ‹xt
 *, cÚ¡ *
d©a
, 
size_t
 
d©a_Ën
);

55 
off_t
 
mtd_”a£_blocks
(
MtdWr™eCÚ‹xt
 *, 
blocks
);

56 
mtd_wr™e_şo£
(
MtdWr™eCÚ‹xt
 *);

58 #ifdeà
__ılu¥lus


	@mtdutils/sdutils.c

20 
	~<¡dio.h
>

21 
	~<¡dlib.h
>

22 
	~<uni¡d.h
>

23 
	~<¡ršg.h
>

24 
	~<sys/ty³s.h
>

25 
	~<sys/¡©.h
>

26 
	~<sys/mouÁ.h
>

27 
	~<fú.h
>

28 
	~<”ºo.h
>

29 
	~<sys/wa™.h
>

30 
	~<sys/ioùl.h
>

31 
	~<lšux/dm-ioùl.h
>

32 
	~"cuts/´İ”t›s.h
"

33 
	~"htc_»cvy_uts/dœ_İ”©iÚ.h
"

35 
	~"sduts.h
"

36 
	~"emmcuts.h
"

37 
	~"’cdeviû.h
"

38 
	~<dœ’t.h
>

40 
	#PERSISTENT_PROPERTY_DIR
 "/d©a/´İ”ty"

	)

41 
	g½es
 [2];

42 
	gwpes
 [2];

44 cÚ¡ *
	gUSERDATA_ROOT
 = "/data";

46 
’su»_·th_mouÁed
(cÚ¡ * 
·th
);

51 
	$sd_mouÁ_·¹™iÚ
(cÚ¡ *
dev·th1
,cÚ¡ *
dev·th2
,cÚ¡ *
mouÁ_pošt
,cÚ¡ *
fesy¡em
){

52 
’c_v”
=0;

53 
p_keyhash
=0,
keyhash
=0,
keyhashËn
=0;

54 
tz_’c_key
[64]={0};

55 
tz_dec_key
[64]={0};

56 
’c_dev·th
[
DEVPATHLENGTH
]={0};

57 
key
[65]={0},
keyËn
=0;

58 
·¿m
[256]={0};

59 cÚ¡ * 
devli¡
[3]={
dev·th1
,
dev·th2
,(*)
NULL
};

60 cÚ¡ * 
dev·th
=
NULL
;

61 
šdex
=0;

62 * 
Çme
=
NULL
;

63 
»Œy_couÁ
=0;

64 
»Œy_max
=3;

65 
»Œy_¦“p_time
=1;

66 
’üy±_mouÁ_ç
=0;

67 
fd
,
isExF©
 = 0, 
mE¼Ü
 = 0;

69 #ifdeà
HTC_EXFAT


70 cÚ¡ *
fesy¡em_exçt
 = "exfat";

72 cÚ¡ *
fesy¡em_exçt
 = "texfat";

76 
fd
 = 
	`İ’
(
dev·th1
, 
O_RDONLY
);

77 ià(
fd
 != -1) {

78 
	`årštf
(
¡d”r
,"%s: o³Àsucûss, fd=%d\n",
__FUNCTION__
, 
fd
);

79 
loff_t
 
£ek_»s
 = 
	`l£ek64
(
fd
, 0, 
SEEK_SET
);

80 ià(
£ek_»s
 == 0) {

81 
boÙ_£ùÜ
[512];

82 
ssize_t
 
»ad_»s
 = 
	`»ad
(
fd
, 
boÙ_£ùÜ
, 512);

83 ià(
»ad_»s
 == 512) {

84 ià(!
	`memcmp
(&
boÙ_£ùÜ
[3], "EXFAT ", 8)) {

86 
isExF©
 = 1;

87 
	`årštf
(
¡d”r
,"%s: EXFAT, isExF©: %d\n",
__FUNCTION__
,
isExF©
);

89 ià(!
	`memcmp
(&
boÙ_£ùÜ
[0], "RRaAXFAT ", 11)) {

91 
isExF©
 = 1;

92 
	`årštf
(
¡d”r
,"%s: RaAXFAT, isExF©: %d\n",
__FUNCTION__
,
isExF©
);

95 
isExF©
 = 0;

96 
	`årštf
(
¡d”r
,"%s:ƒl£, isExF©: %d\n",
__FUNCTION__
,
isExF©
);

99 ià(
»ad_»s
 != -1)

101 
isExF©
 = 0;

102 
	`årštf
(
¡d”r
,"%s:„—d_» !ğ-1, isExF©: %d",
__FUNCTION__
, 
isExF©
);

105 ià(
£ek_»s
 != -1){

106 
isExF©
 = 0;

107 
	`årštf
(
¡d”r
,"%s: s“k_» !ğ-1, isExF©: %d",
__FUNCTION__
, 
isExF©
);

110 
	`şo£
(
fd
);

113 
	`årštf
(
¡d”r
,"%s: o³Àçed, fd=%d\n",
__FUNCTION__
, 
fd
);

117 
»Œy_couÁ
=0;»Œy_couÁ<
»Œy_max
;++retry_count){

118 
šdex
=0;

120 
dev·th
=
devli¡
[
šdex
++];

121 if(
dev·th
==
NULL
);

123 
Çme
=
	`¡¼chr
(
dev·th
,'/');

124 if(
Çme
==
NULL
){

125 
	`årštf
(
¡d”r
,"%s: check‚amçed fÜ %s\n",
__FUNCTION__
,
dev·th
);

128 
Çme
=name+1;

130 
’c_v”
=
	`vçt_check_’üy±
(
dev·th
,&
p_keyhash
);

131 if(!
’c_v”
){

132 
	`årštf
(
¡d”r
,"%s: checkƒnüy± faed fÜ %s\n",
__FUNCTION__
,
dev·th
);

136 if(
’c_v”
==
SDENC_SB_VER1
){

137 
keyhashËn
=56;

138 
keyËn
=48;

139 }if(
’c_v”
==
SDENC_SB_VER2
){

140 
keyhashËn
=64;

141 
keyËn
=64;

144 if(
	`emmc_g‘_tz_’üy±ed_key
(
tz_’c_key
,Ñz_’c_key),
ENC_KEY_OFFSET_FAT
,(
’c_v”
-1)*64)){

145 
	`årštf
(
¡d”r
,"%s:„—d key faed fÜ %s\n",
__FUNCTION__
,
dev·th
);

149 if(
	`tz_deüy±_key
(
tz_’c_key
,
tz_dec_key
,(tz_enc_key))){

150 
	`årštf
(
¡d”r
,"%s: deüy± key faed %s\n",
__FUNCTION__
,
dev·th
);

154 if(!
	`vçt_check_key
(
p_keyhash
,
tz_dec_key
,
keyhashËn
)){

155 
	`årštf
(
¡d”r
,"%s: check key faed %s\n",
__FUNCTION__
,
dev·th
);

159 if(!
	`dm_dev_exi¡s
(
Çme
,
’c_dev·th
)){

160 
	`memıy
(
key
,
tz_dec_key
,
keyËn
);

161 
	`¢´štf
(
·¿m
,Õ¬am),"% % 0 % 1","«s",
key
,
dev·th
);

163 if(
	`dm_dev_ü—‹
(
Çme
,
DM_TYPE_VFAT
,
·¿m
,
dev·th
,
’c_dev·th
)){

164 
	`årštf
(
¡d”r
,"%s: c»©dm-üy± deviû faed\n",
__FUNCTION__
);

169 
mE¼Ü
 = 
	`mouÁ
(
’c_dev·th
,
mouÁ_pošt
,
fesy¡em
,
MS_NOATIME
|
MS_NODEV
|
MS_NODIRATIME
,"");

170 if(
mE¼Ü
){

171 
	`årštf
(
¡d”r
,"%s: EnøçˆmouÁ faed %d;ƒnc_dev·th:%s\n",
__FUNCTION__
, 
mE¼Ü
, 
’c_dev·th
);

172 
mE¼Ü
 = 
	`mouÁ
(
’c_dev·th
,
mouÁ_pošt
,
fesy¡em_exçt
,
MS_NOATIME
|
MS_NODEV
|
MS_NODIRATIME
,"");

175 if(!
mE¼Ü
){

176 
	`årštf
(
¡d”r
,"%s: mouÁ dm-dev fÜ % sucûss;ƒnc_dev·th:%s\n",
__FUNCTION__
, 
mouÁ_pošt
, 
’c_dev·th
);

179 
	`årštf
(
¡d”r
,"%s: EnøexçˆmouÁ dm-dev fÜ % çed;ƒnc_dev·th:%s\n",
__FUNCTION__
, 
mouÁ_pošt
, 
’c_dev·th
);

180 
	`dm_dev_de¡roy
(
Çme
);

181 
’üy±_mouÁ_ç
=1;

186 
	`¦“p
(
»Œy_¦“p_time
);

188 if(
’üy±_mouÁ_ç
) -1;

191 
»Œy_couÁ
=0;»Œy_couÁ<
»Œy_max
;++retry_count){

192 
šdex
=0;

194 
buff
[200];

195 
tz_’c_key
[64]={0};

196 
tz_dec_key
[65]={0};

197 
´İ
[
PROPERTY_VALUE_MAX
];

198 
sdÿrd_eüy±fs
 = 0;

199 
dev·th
=
devli¡
[
šdex
++];

200 if(
dev·th
==
NULL
);

201 
	`g‘_³rsi¡_´İ”ty
();

202 
	`´İ”ty_g‘
("³rsi¡.sys.sdÿrd_eüy±fs", 
´İ
, "false");

203 
sdÿrd_eüy±fs
 = (
	`¡rcmp
(
´İ
, "true") ? 0 : 1);

204 
	`årštf
(
¡d”r
,"³rsi¡.sys.sdÿrd_eüy±fs: %s\n", 
´İ
);

206 ià(
sdÿrd_eüy±fs
) {

207 *
sig
 = 
NULL
;

208 
rc
 = 0;

209 
eüy±fs_Ëv–_´İ
[
PROPERTY_VALUE_MAX
];

210 
üy±o_ty³_Çme
[64];

212 ià(
	`emmc_g‘_tz_’üy±ed_key
(
tz_’c_key
,Ñz_’c_key),
ENC_KEY_OFFSET_FAT
,64)){

213 
	`årštf
(
¡d”r
,"%s:„—d key faed fÜ %s\n",
__FUNCTION__
,
dev·th
);

217 ià(
	`tz_deüy±_key
(
tz_’c_key
,
tz_dec_key
,64)){

218 
	`årštf
(
¡d”r
,"%s: deüy± key faed %s\n",
__FUNCTION__
,
dev·th
);

223 
pid_t
 
pid
;

224 
»tuºed_¡ršg
 [200];

226 ià(
	`pe
(
½es
) != 0)

227 
	`årštf
(
¡d”r
,"%s:…e(èÿÎ fÜ„pe çed",
__FUNCTION__
);

229 ià(
	`pe
(
wpes
) != 0)

230 
	`årštf
(
¡d”r
,"%s:…e(èÿÎ fÜ wpe çed",
__FUNCTION__
);

232 
pid
 = 
	`fÜk
();

233 ià(
pid
 < 0) {

234 
	`årštf
(
¡d”r
,"%s: fÜk(èÿÎ faed",
__FUNCTION__
);

235 } ià(
pid
 > 0) {

237 
ssize_t
 
num_»ad
 = 0;

238 
	`şo£
(
wpes
[0]);

239 
	`şo£
(
½es
[1]);

240 ià(
	`wr™e
(
wpes
[1], 
tz_dec_key
, (tz_dec_key)) != (tz_dec_key))

241 
	`årštf
(
¡d”r
,"%s:…¬’t: wr™e(èÿÎ faed",
__FUNCTION__
);

242 ià((
num_»ad
 = 
	`»ad
(
½es
[0], 
»tuºed_¡ršg
, 200)) < 0)

243 
	`årštf
(
¡d”r
,"%s:…¬’t:„—d(èÿÎ faed",
__FUNCTION__
);

244 
»tuºed_¡ršg
 [
num_»ad
] = 0;

245 
	`wa™
(
NULL
);

248 
	`şo£
(
wpes
[1]);

249 
	`şo£
(
½es
[0]);

250 
	`dup2
(
wpes
[0], 
STDIN_FILENO
);

251 
	`dup2
(
½es
[1], 
STDOUT_FILENO
);

252 
	`şo£
(
wpes
[0]);

253 
	`şo£
(
½es
[1]);

254 
	`exeşp
("/sbš/MOC_eüy±fs_add_·s¥h¿£", "/sbš/MOC_eüy±fs_add_·s¥h¿£", 
NULL
);

257 *
d–im
 = " ";

258 *
d–im_b¿ck‘
 = "[]";

259 * 
pch
;

260 
pch
 = 
	`¡¹ok
(
»tuºed_¡ršg
, 
d–im
);

261 
pch
 !ğ
NULL
) {

262 ià(!
	`¡ºcmp
(
pch
, "[", 1)) {

263 
sig
 = 
	`¡¹ok
(
pch
, 
d–im_b¿ck‘
);

266 
pch
 = 
	`¡¹ok
(
NULL
, 
d–im
);

270 
	`´İ”ty_g‘
("³rsi¡.sys.’üy±_Ëv–", 
eüy±fs_Ëv–_´İ
, "high");

272 ià(
	`¡rcmp
(
eüy±fs_Ëv–_´İ
, "high") == 0) {

273 
	`¡rıy
(
üy±o_ty³_Çme
, "aes-xts");

274 
	`årštf
(
¡d”r
, "%s: Ju¡ s‘u°fÜ‡es-xt ’üy±iÚ\n", 
__FUNCTION__
);

276 
	`¡rıy
(
üy±o_ty³_Çme
, "aes-cbc");

277 
	`årštf
(
¡d”r
, "%s: Ju¡ s‘u°fÜ‡es-cbø’üy±iÚ\n", 
__FUNCTION__
);

279 
	`¢´štf
(
buff
, (buff), "eüy±fs_sig=%s,eüy±fs_ch”=%s,eüy±fs_key_by‹s=32,eüy±fs_uÆšk_sigs,eüy±fs_·s¡hrough", (
sig
==
NULL
)?"NULL":sig, 
üy±o_ty³_Çme
);

282 
mE¼Ü
 = 
	`mouÁ
(
dev·th
,
mouÁ_pošt
,
fesy¡em
,
MS_NOATIME
|
MS_NODEV
|
MS_NODIRATIME
,"");

283 if(
mE¼Ü
){

284 
	`årštf
(
¡d”r
,"%s: f© mouÁ faed %d; dev·th:%s\n",
__FUNCTION__
, 
mE¼Ü
, 
dev·th
);

285 
mE¼Ü
 = 
	`mouÁ
(
dev·th
,
mouÁ_pošt
,
fesy¡em_exçt
,
MS_NOATIME
|
MS_NODEV
|
MS_NODIRATIME
,"");

288 if(!
mE¼Ü
){

289 
	`årštf
(
¡d”r
,"%s: mouÁ dev fÜ % sucûss; dev·th:%s\n",
__FUNCTION__
,
mouÁ_pošt
,
dev·th
);

290 ià(
sdÿrd_eüy±fs
) {

291 ià(!
	`mouÁ
(
mouÁ_pošt
, mouÁ_pošt,"eüy±fs",
MS_NOEXEC
|
MS_NODEV
, 
buff
)) {

292 
	`årštf
(
¡d”r
,"%s:ƒüy±f mouÁ fÜ % sucûss\n",
__FUNCTION__
,
mouÁ_pošt
);

294 
	`årštf
(
¡d”r
,"%s: mouÁƒüy±f fÜ % çed\n",
__FUNCTION__
,
mouÁ_pošt
);

300 
	`årštf
(
¡d”r
,"%s:ƒxçˆmouÁ dev fÜ % çed; dev·th:%s\n",
__FUNCTION__
,
mouÁ_pošt
,
dev·th
);

303 ++
dev·th
;

305 
	`¦“p
(
»Œy_¦“p_time
);

309 
	}
}

311 
	$sd_umouÁ_·¹™iÚ
(cÚ¡ *
dev·th
,cÚ¡ *
mouÁ_pošt
){

312 
»t
 = 0;

313 
»Œy_couÁ
=0;

314 
»Œy_max
=3;

315 
»Œy_¦“p_time
=1;

316 
id
=0;

317 
´İ
[
PROPERTY_VALUE_MAX
];

318 
sdÿrd_eüy±fs
 = 0;

319 
dm_dev_Çme
[32]={0};

321 
	`´İ”ty_g‘
("³rsi¡.sys.sdÿrd_eüy±fs", 
´İ
, "false");

322 
sdÿrd_eüy±fs
 = (
	`¡rcmp
(
´İ
, "true") ? 0 : 1);

323 
	`årštf
(
¡d”r
,"³rsi¡.sys.sdÿrd_eüy±fs: %s\n", 
´İ
);

326 ià(
sdÿrd_eüy±fs
) {

327 
»Œy_couÁ
=0;»Œy_couÁ<
»Œy_max
;++retry_count){

328 
»t
=
	`umouÁ
(
mouÁ_pošt
);

329 if(
»t
==0);

330 
	`¦“p
(
»Œy_¦“p_time
);

333 
»Œy_couÁ
=0;
»t
==0 &&„‘ry_couÁ<
»Œy_max
;++retry_count){

334 
»t
=
	`umouÁ
(
mouÁ_pošt
);

335 if(
»t
==0);

336 
	`¦“p
(
»Œy_¦“p_time
);

339 ià(
»t
!=0){

340 
	`årštf
(
¡d”r
,"%s: umouÁ % çed\n",
__FUNCTION__
,
mouÁ_pošt
);

341  
»t
;

343 
	`årštf
(
¡d”r
, "%s: umouÁ % sucûss\n",
__FUNCTION__
,
mouÁ_pošt
);

347 if(
	`¡ºcmp
(
dev·th
,"/dev/block/dm-",
	`¡¾’
("/dev/block/dm-"))==0){

348 
	`ssÿnf
(
dev·th
,"/dev/block/dm-%d",&
id
);

349 if(
	`dm_dev_fšd_Çme_by_id
(()
id
,
dm_dev_Çme
)){

350 
»Œy_couÁ
=0;»Œy_couÁ<
»Œy_max
;++retry_count){

351 
»t
=
	`dm_dev_de¡roy
(
dm_dev_Çme
);

352 if(
»t
==0){

353 
	`årštf
(
¡d”r
,"%s: de¡roy % sucûssful\n",
__FUNCTION__
,
dm_dev_Çme
);

356 
	`årštf
(
¡d”r
,"%s: de¡roy % çed\n",
__FUNCTION__
,
dm_dev_Çme
);

358 
	`¦“p
(
»Œy_¦“p_time
);

363  
»t
;

364 
	}
}

366 
	$sd_fÜm©_·¹™iÚ
(cÚ¡ *
dev·th
,cÚ¡ *
mouÁ_pošt
,cÚ¡ *
fesy¡em
){

367 *
·¿m
[12] = {"/sbš/Ãwfs_msdos_»cvy", "-F", "32" , "-O", "ªdroid","-c", "64", "-r", "3106", "-d", 
dev·th
,(*)0};

368 
fd
,
ÿ·c™y
 = 0;

369 
pid_t
 
pid
;

370 
¡©us
;

373 ià((
fd
 = 
	`İ’
(
dev·th
, 
O_RDONLY
)) < 0) {

374 
	`årštf
(
¡d”r
,"%s: UÇbËØİ’ deviû % (%s)",
__FUNCTION__
,
dev·th
,
	`¡»¼Ü
(
”ºo
));

377 ià(
	`ioùl
(
fd
, 
BLKGETSIZE
, &
ÿ·c™y
)) {

378 
	`årštf
(
¡d”r
,"%s: UÇbËØg‘ deviû sizfÜ % (%s)",
__FUNCTION__
,
dev·th
,
	`¡»¼Ü
(
”ºo
));

379 
	`şo£
(
fd
);

382 
	`şo£
(
fd
);

384 ià(
ÿ·c™y
 =ğ51372032è
·¿m
[8] = "3844";

385 ià(
ÿ·c™y
 =ğ20836352è
·¿m
[8] = "3106";

386 
·¿m
[8] = "32";

389 
pid
 = 
	`fÜk
();

390 ià(!
pid
){

391 
	`execv
(
·¿m
[0],param);

392 
	`årštf
(
¡d”r
,"%s:ƒxecv % ”¸ğ%s\n",
__FUNCTION__
,
·¿m
[0],
	`¡»¼Ü
(
”ºo
));

395 
	`wa™
(&
¡©us
)!=
pid
);

398 
	`årštf
(
¡d”r
,"%s:ƒxecv % fšish\n",
__FUNCTION__
,
·¿m
[0]);

400 
	}
}

402 
	$g‘_³rsi¡_´İ”ty
(){

405 
	`årštf
(
¡d”r
,"%s: MouÁ % SucûssfuÎy!\n",
__FUNCTION__
,
USERDATA_ROOT
);

406 if(
	`dœ_exi¡s
(
PERSISTENT_PROPERTY_DIR
)!=0){

407 
	`årštf
(
¡d”r
,"%s: Dœ % DØExi¡!\n",
__FUNCTION__
,
PERSISTENT_PROPERTY_DIR
);

409 
DIR
* 
dœ
 = 
	`İ’dœ
(
PERSISTENT_PROPERTY_DIR
);

410 
dœ’t
* 
’Œy
;

411 
·th
[
PATH_MAX
];

412 
v®ue
[
PROPERTY_VALUE_MAX
];

413 
fd
, 
Ëngth
;

414 ià(
dœ
) {

415 (
’Œy
 = 
	`»addœ
(
dœ
)è!ğ
NULL
) {

416 ià(
	`¡ºcmp
("³rsi¡.", 
’Œy
->
d_Çme
, 
	`¡¾’
("persist.")))

419 ià(
’Œy
->
d_ty³
 !ğ
DT_REG
)

423 
	`¢´štf
(
·th
, Õ©h), "%s/%s", 
PERSISTENT_PROPERTY_DIR
, 
’Œy
->
d_Çme
);

424 
fd
 = 
	`İ’
(
·th
, 
O_RDONLY
);

425 ià(
fd
 >= 0) {

426 
Ëngth
 = 
	`»ad
(
fd
, 
v®ue
, (value) - 1);

427 ià(
Ëngth
 >= 0) {

428 
v®ue
[
Ëngth
] = 0;

429 
	`´İ”ty_£t
(
’Œy
->
d_Çme
, 
v®ue
);

431 
	`årštf
(
¡d”r
,"%s: UÇbËØ»ad…”si¡’ˆ´İ”ty f% (%s)\n",
__FUNCTION__
, 
·th
, 
	`¡»¼Ü
(
”ºo
));

433 
	`şo£
(
fd
);

435 
	`årštf
(
¡d”r
,"%s: UÇbËØİ’…”si¡’ˆ´İ”ty f% (%s)\n",
__FUNCTION__
, 
·th
, 
	`¡»¼Ü
(
”ºo
));

437 
	`şo£dœ
(
dœ
);

439 
	`årštf
(
¡d”r
,"%s: UÇbËØİ’…”si¡’ˆ´İ”ty dœeùÜy % (%s)\n",
__FUNCTION__
,
PERSISTENT_PROPERTY_DIR
, 
	`¡»¼Ü
(
”ºo
));

441 
	`årštf
(
¡d”r
,"%s: Dœ % DØNOT Exi¡!\n",
__FUNCTION__
,
PERSISTENT_PROPERTY_DIR
);

443 
	`årštf
(
¡d”r
,"%s: MouÁ % Fa!\n",
__FUNCTION__
,
USERDATA_ROOT
);

444 
	}
}

	@mtdutils/sdutils.h

20 #iâdeà
SDUTILS_H


21 
	#SDUTILS_H


	)

23 
	~<sys/ty³s.h
>

24 
	~<uni¡d.h
>

26 #ifdeà
__ılu¥lus


33 
sd_mouÁ_·¹™iÚ
(cÚ¡ *
dev·th1
,cÚ¡ *
dev·th2
,cÚ¡ *
mouÁ_pošt
,cÚ¡ *
fesy¡em
);

34 
sd_umouÁ_·¹™iÚ
(cÚ¡ *
dev·th
,cÚ¡ *
mouÁ_pošt
);

35 
sd_fÜm©_·¹™iÚ
(cÚ¡ *
dev·th
,cÚ¡ *
mouÁ_pošt
,cÚ¡ *
fesy¡em
);

36 
g‘_³rsi¡_´İ”ty
();

38 #ifdeà
__ılu¥lus


	@print_sha1.h

17 #iâdeà
RECOVERY_PRINT_SHA1_H


18 
	#RECOVERY_PRINT_SHA1_H


	)

20 
	~<¡dšt.h
>

21 
	~<¡ršg
>

23 
	~<İ’s¦/sha.h
>

25 
	g¡d
::
¡ršg
 
	$´št_sha1
(cÚ¡ 
ušt8_t
* 
sha1
, 
size_t
 
Ën
) {

26 cÚ¡ * 
hex
 = "0123456789abcdef";

27 
¡d
::
¡ršg
 
»suÉ
 = "";

28 
size_t
 
i
 = 0; i < 
Ën
; ++i) {

29 
»suÉ
.
	`push_back
(
hex
[(
sha1
[
i
]>>4) & 0xf]);

30 
»suÉ
.
	`push_back
(
hex
[
sha1
[
i
] & 0xf]);

32  
»suÉ
;

33 
	}
}

35 
	g¡d
::
¡ršg
 
	$´št_sha1
(cÚ¡ 
ušt8_t
 
sha1
[
SHA_DIGEST_LENGTH
]) {

36  
	`´št_sha1
(
sha1
, 
SHA_DIGEST_LENGTH
);

37 
	}
}

39 
	g¡d
::
¡ršg
 
	$shÜt_sha1
(cÚ¡ 
ušt8_t
 
sha1
[
SHA_DIGEST_LENGTH
]) {

40  
	`´št_sha1
(
sha1
, 4);

41 
	}
}

43 
	g¡d
::
¡ršg
 
	$´št_hex
(cÚ¡ 
ušt8_t
* 
by‹s
, 
size_t
 
Ën
) {

44  
	`´št_sha1
(
by‹s
, 
Ën
);

45 
	}
}

	@recovery.cpp

17 
	~<ùy³.h
>

18 
	~<dœ’t.h
>

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<g‘İt.h
>

22 
	~<š‰y³s.h
>

23 
	~<lim™s.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/šput.h
>

26 
	~<¡d¬g.h
>

27 
	~<¡dio.h
>

28 
	~<¡dlib.h
>

29 
	~<¡ršg.h
>

30 
	~<sys/klog.h
>

31 
	~<sys/¡©.h
>

32 
	~<sys/ty³s.h
>

33 
	~<sys/wa™.h
>

34 
	~<sys/mouÁ.h
>

35 
	~<time.h
>

36 
	~<uni¡d.h
>

38 
	~<®gÜ™hm
>

39 
	~<chrÚo
>

40 
	~<memÜy
>

41 
	~<¡ršg
>

42 
	~<veùÜ
>

44 
	~<adb.h
>

45 
	~<ªdroid-ba£/fe.h
>

46 
	~<ªdroid-ba£/loggšg.h
>

47 
	~<ªdroid-ba£/·r£št.h
>

48 
	~<ªdroid-ba£/´İ”t›s.h
>

49 
	~<ªdroid-ba£/¡ršg´štf.h
>

50 
	~<ªdroid-ba£/¡ršgs.h
>

51 
	~<ªdroid-ba£/unique_fd.h
>

52 
	~<cuts/ªdroid_»boÙ.h
>

53 
	~<cuts/´İ”t›s.h
>

54 
	~<h—Éhd/B©‹ryMÚ™Ü.h
>

55 
	~<£lšux/ªdroid.h
>

56 
	~<£lšux/Ïb–.h
>

57 
	~<£lšux/£lšux.h
>

58 
	~<z¬chive/z_¬chive.h
>

60 
	~"commÚ.h
"

61 
	~"deviû.h
"

62 
	~"”rÜ_code.h
"

63 
	~"mšadbd/mšadbd.h
"

64 
	~"mšui/mšui.h
"

65 
	~"roÙs.h
"

66 
	~"sü“n_ui.h
"

67 
	~"ui.h
"

69 
Recov”yUI
* 
	gui
 = 
nuÎ±r
;

70 
cÚ¡ex´
 
	glog_ch¬aù”s
[] = "VDIWEF";

72 
cÚ¡ex´
 cÚ¡ * 
	gDEFAULT_LOCALE
 = "en-US";

73 
	g¡d
::
¡ršg
 
loÿË
;

74 
Deviû
* 
	gdeviû
 = 
NULL
;

75 
£Ïb–_hªdË
* 
	g£hªdË
;

77 
	#INSTALL_SUCCESS
 0

	)

78 
	#INSTALL_NONE
 1

	)

79 
	#INSTALL_ERROR
 2

	)

80 
	#INSTALL_CORRUPT
 3

	)

82 
	$run_g¿phics_‹¡
() {

84 
ui
->
	`ShowText
(
çl£
);

86 
ui
->
	`S‘Prog»ssTy³
(
Recov”yUI
::
INDETERMINATE
);

87 
ui
->
	`S‘Background
(
Recov”yUI
::
INSTALLING_UPDATE
);

88 
	`¦“p
(1);

90 
ui
->
	`S‘Background
(
Recov”yUI
::
ERROR
);

91 
	`¦“p
(1);

93 
ui
->
	`S‘Background
(
Recov”yUI
::
NO_COMMAND
);

94 
	`¦“p
(1);

96 
ui
->
	`S‘Background
(
Recov”yUI
::
ERASING
);

97 
	`¦“p
(1);

100 
ui
->
	`S‘Sge
(1, 3);

101 
ui
->
	`S‘Background
(
Recov”yUI
::
INSTALLING_UPDATE
);

102 
	`¦“p
(1);

103 
ui
->
	`S‘Sge
(2, 3);

104 
ui
->
	`S‘Background
(
Recov”yUI
::
INSTALLING_UPDATE
);

105 
	`¦“p
(1);

106 
ui
->
	`S‘Sge
(3, 3);

107 
ui
->
	`S‘Background
(
Recov”yUI
::
INSTALLING_UPDATE
);

108 
	`¦“p
(1);

110 
ui
->
	`S‘Sge
(-1, -1);

111 
ui
->
	`S‘Background
(
Recov”yUI
::
INSTALLING_UPDATE
);

113 
ui
->
	`S‘Prog»ssTy³
(
Recov”yUI
::
DETERMINATE
);

114 
ui
->
	`ShowProg»ss
(1.0, 10.0);

115 
äaùiÚ
 = 0.0;

116 
size_t
 
i
 = 0; i < 100; ++i) {

117 
äaùiÚ
 += .01;

118 
ui
->
	`S‘Prog»ss
(
äaùiÚ
);

119 
	`u¦“p
(100000);

121 
ui
->
	`ShowText
(
Œue
);

122 
	}
}

128 
	$g‘_m’u_£ËùiÚ
(cÚ¡ * cÚ¡* 
h—d”s
, cÚ¡ * cÚ¡* 
™ems
, 
boŞ
 
m’u_Úly
,

129 
š™Ÿl_£ËùiÚ
, 
Deviû
* 
deviû
) {

131 
ui
->
	`FlushKeys
();

133 
ui
->
	`S¹M’u
(
h—d”s
, 
™ems
, 
š™Ÿl_£ËùiÚ
);

135 
£Ëùed
 = 
š™Ÿl_£ËùiÚ
;

136 
cho£n_™em
 = -1;

137 
cho£n_™em
 < 0) {

138 
key
 = 
ui
->
	`Wa™Key
();

139 ià(
key
 == -1) {

140 ià(
ui
->
	`WasTextEv”VisibË
()) {

143 
	`LOG
(
INFO
) << "Timed out waiting for key input;„ebooting.";

144 
ui
->
	`EndM’u
();

149 
boŞ
 
visibË
 = 
ui
->
	`IsTextVisibË
();

150 
aùiÚ
 = 
deviû
->
	`HªdËM’uKey
(
key
, 
visibË
);

152 ià(
aùiÚ
 < 0) {

153 
aùiÚ
) {

154 
Deviû
::
kHighlightUp
:

155 
£Ëùed
 = 
ui
->
	`S–eùM’u
(--selected);

157 
Deviû
::
kHighlightDown
:

158 
£Ëùed
 = 
ui
->
	`S–eùM’u
(++selected);

160 
Deviû
::
kInvokeI‹m
:

161 
cho£n_™em
 = 
£Ëùed
;

163 
Deviû
::
kNoAùiÚ
:

166 } ià(!
m’u_Úly
) {

167 
cho£n_™em
 = 
aùiÚ
;

171 
ui
->
	`EndM’u
();

172  
cho£n_™em
;

173 
	}
}

175 
	gDeviû
::
ButšAùiÚ
 
	$´om±_ªd_wa™
(
Deviû
* 
deviû
, 
¡©us
) {

177 
	`´štf
("zzytest, in…rompt_and_wait\n");

178 
¡©us
) {

179 
INSTALL_SUCCESS
:

180 
INSTALL_NONE
:

181 
ui
->
	`S‘Background
(
Recov”yUI
::
NO_COMMAND
);

184 
INSTALL_ERROR
:

185 
INSTALL_CORRUPT
:

186 
ui
->
	`S‘Background
(
Recov”yUI
::
ERROR
);

189 
ui
->
	`S‘Prog»ssTy³
(
Recov”yUI
::
EMPTY
);

191 
cho£n_™em
 = 
	`g‘_m’u_£ËùiÚ
(
nuÎ±r
, 
deviû
->
	`G‘M’uI‹ms
(), 
çl£
, 0, device);

195 
Deviû
::
ButšAùiÚ
 
cho£n_aùiÚ
 =

196 (
cho£n_™em
 =ğ-1è? 
Deviû
::
REBOOT
 : 
deviû
->
	`InvokeM’uI‹m
(chosen_item);

198 
boŞ
 
should_we_ÿche
 = 
çl£
;

199 
cho£n_aùiÚ
) {

200 
Deviû
::
ZZYTEST
:

202 
»t
 = 0;

203 
»t
 = 
	`mouÁ
("/sy¡em", "/dev/block/boÙdeviû/by-Çme/sy¡em", "ext4", 0, 
NULL
);

204 if(
»t
 == 0) {

205 
ui
->
	`Pršt
("system mounted\n");

208 
	`sy¡em
("mount -tƒxt4 /dev/block/bootdevice/by-name/system /system");

209 
ui
->
	`Pršt
("”ºo=%d:%s\n", 
”ºo
, 
	`¡»¼Ü
(errno));

210 
ui
->
	`Pršt
("system mount fail\n");

215 
Deviû
::
NO_ACTION
:

218 
Deviû
::
REBOOT
:

219 
Deviû
::
SHUTDOWN
:

220 
Deviû
::
REBOOT_BOOTLOADER
:

221  
cho£n_aùiÚ
;

223 
Deviû
::
WIPE_DATA
:

226 
Deviû
::
WIPE_CACHE
:

229 
Deviû
::
APPLY_ADB_SIDELOAD
:

230 
Deviû
::
APPLY_SDCARD
:

233 
Deviû
::
VIEW_RECOVERY_LOGS
:

236 
Deviû
::
RUN_GRAPHICS_TEST
:

237 
	`run_g¿phics_‹¡
();

240 
Deviû
::
MOUNT_SYSTEM
:

246 
	}
}

249 
	$maš
(
¬gc
, **
¬gv
) {

251 
	`´štf
("zzytest:est14\n");

254 
time_t
 
¡¬t
 = 
	`time
(
NULL
);

255 
	`´štf
("S¹šg„ecov”y (pid %dèÚ %s", 
	`g‘pid
(), 
	`ùime
(&
¡¬t
));

260 
	`lßd_vŞume_bË
();

262 
boŞ
 
show_‹xt
 = 
çl£
;

264 
loÿË
 = 
DEFAULT_LOCALE
;

266 
	`´štf
("loÿË i [%s]\n", 
loÿË
.
	`c_¡r
());

268 
deviû
 = 
	`make_deviû
();

270 
ui
 = 
deviû
->
	`G‘UI
();

271 
	`LOG
(
ERROR
) << "device GetUI\n";

273 ià(!
ui
->
	`In™
(
loÿË
)) {

274 
	`´štf
("Failedo initialize UI, use stub UI instead.\n");

275 
	`LOG
(
ERROR
) << "Failedo initialize UI, use stub UI instead\n";

279 
ui
->
	`S‘Background
(
Recov”yUI
::
NONE
);

281 
£hªdË
 = 
	`£lšux_ªdroid_fe_cÚ‹xt_hªdË
();

282 
	`£lšux_ªdroid_£t_£hªdË
(
£hªdË
);

283 ià(!
£hªdË
) {

284 
ui
->
	`Pršt
("Warning: No file_contexts\n");

287 
deviû
->
	`S¹Recov”y
();

292 
ui
->
	`Pršt
("zzytest\n");

293 
ui
->
	`Pršt
("zzytest1\n");

295 
¡©us
 = 
INSTALL_SUCCESS
;

297 
ui
->
	`ShowText
(
Œue
);

298 
Deviû
::
ButšAùiÚ
 
‹mp
 = 
	`´om±_ªd_wa™
(
deviû
, 
¡©us
);

300 
‹mp
) {

301 
Deviû
::
SHUTDOWN
:

302 
ui
->
	`Pršt
("Shutting down...\n");

303 
ªdroid
::
ba£
::
	`S‘Prİ”ty
(
ANDROID_RB_PROPERTY
, "shutdown,");

306 
Deviû
::
REBOOT_BOOTLOADER
:

307 
ui
->
	`Pršt
("Rebootingo bootloader...\n");

308 
ªdroid
::
ba£
::
	`S‘Prİ”ty
(
ANDROID_RB_PROPERTY
, "reboot,bootloader");

312 
ui
->
	`Pršt
("other‡ction...\n");

317 
Œue
) {

318 
	`´štf
("whilerue…ause\n");

321 
	`´om±_ªd_wa™
(
deviû
, 
¡©us
);

322 
	`¦“p
(5);

326  
EXIT_SUCCESS
;

327 
	}
}

	@roots.cpp

17 
	~"roÙs.h
"

19 
	~<”ºo.h
>

20 
	~<¡dlib.h
>

21 
	~<sys/mouÁ.h
>

22 
	~<sys/¡©.h
>

23 
	~<sys/ty³s.h
>

24 
	~<sys/wa™.h
>

25 
	~<uni¡d.h
>

26 
	~<ùy³.h
>

27 
	~<fú.h
>

29 
	~<ªdroid-ba£/loggšg.h
>

30 
	~<ext4_uts/make_ext4fs.h
>

31 
	~<ext4_uts/we.h
>

32 
	~<fs_mgr.h
>

34 
	~"mtduts/emmcuts.h
"

35 
	~"mtduts/sduts.h
"

37 
	~"commÚ.h
"

38 
	~"mouÁs.h
"

39 
	~"üy±fs.h
"

41 
f¡ab
 *
	gf¡ab
 = 
NULL
;

42 cÚ¡ *
	gCACHE_ROOT
 = "/cache";

43 
£Ïb–_hªdË
 *
£hªdË
;

45 cÚ¡ * 
	gSDCARD_ROOT
 = "/sdcard";

46 cÚ¡ * 
	gUSERDATA_MOUNT_POINT
 = "/data";

47 cÚ¡ * 
	gUSERDATA_NAME
 = "userdata";

49 
	$lßd_vŞume_bË
()

51 
i
;

52 
»t
;

54 
f¡ab
 = 
	`fs_mgr_»ad_f¡ab_deçuÉ
();

55 ià(!
f¡ab
) {

56 
	`LOG
(
ERROR
) << "failedo„ead default fstab";

60 
»t
 = 
	`fs_mgr_add_’Œy
(
f¡ab
, "/tmp", "ramdisk", "ramdisk");

61 ià(
»t
 < 0 ) {

62 
	`LOG
(
ERROR
) << "failedo‡dd /tmpƒntryo fstab";

63 
	`fs_mgr_ä“_f¡ab
(
f¡ab
);

64 
f¡ab
 = 
NULL
;

69 if(
	`emmc_sÿn_·¹™iÚs
()<=0){

70 
	`LOG
(
ERROR
è<< 
__FUNCTION__
 << ": Can't gethe /proc/emmcable";

74 
	`´štf
("recovery filesystemable\n");

75 
	`´štf
("=========================\n");

76 
i
 = 0; i < 
f¡ab
->
num_’Œ›s
; ++i) {

77 
VŞume
* 
v
 = &
f¡ab
->
»cs
[
i
];

78 
	`´štf
(" %d % % % %Îd\n", 
i
, 
v
->
mouÁ_pošt
, v->
fs_ty³
,

79 
v
->
blk_deviû
, v->
Ëngth
);

81 
	`´štf
("\n");

82 
	}
}

84 
VŞume
* 
	$vŞume_fÜ_·th
(cÚ¡ * 
·th
) {

85  
	`fs_mgr_g‘_’Œy_fÜ_mouÁ_pošt
(
f¡ab
, 
·th
);

86 
	}
}

89 
	$’su»_·th_mouÁed_©
(cÚ¡ * 
·th
, cÚ¡ * 
mouÁ_pošt
) {

90 
VŞume
* 
v
 = 
	`vŞume_fÜ_·th
(
·th
);

91 ià(
v
 =ğ
NULL
) {

92 
	`LOG
(
ERROR
è<< "unknowÀvŞumfÜ…©h [" << 
·th
 << "]";

95 ià(
	`¡rcmp
(
v
->
fs_ty³
, "ramdisk") == 0) {

100 ià(!
	`sÿn_mouÁed_vŞumes
()) {

101 
	`LOG
(
ERROR
) << "failedo scan mounted volumes";

105 ià(!
mouÁ_pošt
) {

106 
mouÁ_pošt
 = 
v
->mount_point;

109 
MouÁedVŞume
* 
mv
 = 
	`fšd_mouÁed_vŞume_by_mouÁ_pošt
(
mouÁ_pošt
);

110 ià(
mv
) {

115 
	`mkdœ
(
mouÁ_pošt
, 0755);

117 ià(
	`¡rcmp
(
v
->
fs_ty³
, "ext4") == 0 ||

118 
	`¡rcmp
(
v
->
fs_ty³
, "squashfs") == 0 ||

119 
	`¡rcmp
(
v
->
fs_ty³
, "vfat") == 0) {

120 ià(
	`¡ºcmp
(
v
->
mouÁ_pošt
,
SDCARD_ROOT
,
	`¡¾’
(SDCARD_ROOT))==0) {

122 
VŞume
* 
v1
 = 
	`fs_mgr_g‘_’Œy_fÜ_mouÁ_pošt_aá”
(
v
, 
f¡ab
, 
·th
);

123 ià(
v1
 !ğ
NULL
)

124  
	`sd_mouÁ_·¹™iÚ
(
v1
->
blk_deviû
,
v
->blk_deviû,v->
mouÁ_pošt
,v->
fs_ty³
);

126  
	`sd_mouÁ_·¹™iÚ
(
v
->
blk_deviû
,v->blk_deviû,v->
mouÁ_pošt
,v->
fs_ty³
);

128 
»suÉ
 = 
	`mouÁ
(
v
->
blk_deviû
, 
mouÁ_pošt
, v->
fs_ty³
, 
MS_NOATIME
 | 
MS_NODEV
 | 
MS_NODIRATIME
, "");

129 ià(
»suÉ
 && 
”ºo
 =ğ
EINVAL
 && !
	`¡ºcmp
(
v
->
mouÁ_pošt
, 
CACHE_ROOT
, 
	`¡¾’
(CACHE_ROOT))) {

131 
	`LOG
(
ERROR
) << "mount /cache fail, format it‡nd mount‡gain";

132 
	`fÜm©_vŞume
(
CACHE_ROOT
);

133 
»suÉ
 = 
	`mouÁ
(
v
->
blk_deviû
, v->
mouÁ_pošt
, v->
fs_ty³
,

134 
MS_NOATIME
 | 
MS_NODEV
 | 
MS_NODIRATIME
, "");

136 ià(
»suÉ
 != 0) {

138 cÚ¡ 
eMMCP¬t™iÚ
 *
•
=
NULL
;

140 
	`PLOG
(
INFO
è<< "çedØmouÁ " << 
v
->
mouÁ_pošt
 << "..ryƒmmc mount";

141 ià(
	`¡ºcmp
(
v
->
mouÁ_pošt
, 
USERDATA_MOUNT_POINT
, 
	`¡¾’
(USERDATA_MOUNT_POINT)) == 0) {

142 
•
=
	`emmc_fšd_·¹™iÚ_by_Çme
(
USERDATA_NAME
);

144 if(
•
==
NULL
){

145 
	`LOG
(
ERROR
è<< "Cª'ˆfšd deviû‚odfÜ mouÁ…ošˆ" << 
v
->
mouÁ_pošt
;

148 
»suÉ
=
	`emmc_mouÁ_·¹™iÚ
(
•
,
v
->
mouÁ_pošt
,v->
fs_ty³
);

150 
	`LOG
(
INFO
è<< "Check mouÁ stus, v->mouÁ_pošt=" << 
v
->
mouÁ_pošt
 << ",„esuÉ=" << 
»suÉ
;

152  
»suÉ
;

154 ià(
»suÉ
 =ğ-1 && 
	`fs_mgr_is_fÜm©bË
(
v
)) {

155 
	`LOG
(
ERROR
è<< "çedØmouÁ " << 
mouÁ_pošt
 << " (" << 
	`¡»¼Ü
(
”ºo
)

157 
boŞ
 
üy±_foÙ”
 = 
	`fs_mgr_is_’üy±abË
(
v
è&& !
	`¡rcmp
(v->
key_loc
, "footer");

158 ià(
	`fs_mgr_do_fÜm©
(
v
, 
üy±_foÙ”
) == 0) {

159 
»suÉ
 = 
	`mouÁ
(
v
->
blk_deviû
, 
mouÁ_pošt
, v->
fs_ty³
, v->
æags
, v->
fs_İtiÚs
);

161 
	`PLOG
(
ERROR
è<< "çedØfÜm© " << 
mouÁ_pošt
;

166 ià(
»suÉ
 == -1) {

167 
	`PLOG
(
ERROR
è<< "çedØmouÁ " << 
mouÁ_pošt
;

168 
v
 = 
	`fs_mgr_g‘_’Œy_fÜ_mouÁ_pošt_aá”
(v, 
f¡ab
, 
·th
);

169 ià(
v
) {

170 
»suÉ
 = 
	`mouÁ
(
v
->
blk_deviû
, v->
mouÁ_pošt
, v->
fs_ty³
,

171 
MS_NOATIME
 | 
MS_NODEV
 | 
MS_NODIRATIME
, "");

172 ià(
»suÉ
 == 0)

175 
	`PLOG
(
ERROR
è<< "çedØ»-mouÁ " << 
v
->
mouÁ_pošt
;

182 
	`LOG
(
ERROR
è<< "unknowÀfs_ty³ \"" << 
v
->
fs_ty³
 << "\" fÜ " << 
mouÁ_pošt
;

184 
	}
}

186 
	$’su»_·th_mouÁed
(cÚ¡ * 
·th
) {

188  
	`’su»_·th_mouÁed_©
(
·th
, 
nuÎ±r
);

189 
	}
}

191 
	$’su»_·th_unmouÁed
(cÚ¡ * 
·th
) {

192 
VŞume
* 
v
 = 
	`vŞume_fÜ_·th
(
·th
);

193 ià(
v
 =ğ
NULL
) {

194 
	`LOG
(
ERROR
è<< "unknowÀvŞumfÜ…©h [" << 
·th
 << "]";

197 ià(
	`¡rcmp
(
v
->
fs_ty³
, "ramdisk") == 0) {

202 ià(!
	`sÿn_mouÁed_vŞumes
()) {

203 
	`LOG
(
ERROR
) << "failedo scan mounted volumes";

207 
MouÁedVŞume
* 
mv
 = 
	`fšd_mouÁed_vŞume_by_mouÁ_pošt
(
v
->
mouÁ_pošt
);

208 ià(
mv
 =ğ
NULL
) {

213  
	`unmouÁ_mouÁed_vŞume
(
mv
);

214 
	}
}

216 
	$exec_cmd
(cÚ¡ * 
·th
, * cÚ¡ 
¬gv
[]) {

217 
¡©us
;

218 
pid_t
 
chd
;

219 ià((
chd
 = 
	`vfÜk
()) == 0) {

220 
	`execv
(
·th
, 
¬gv
);

221 
	`_ex™
(
EXIT_FAILURE
);

223 
	`wa™pid
(
chd
, &
¡©us
, 0);

224 ià(!
	`WIFEXITED
(
¡©us
è|| 
	`WEXITSTATUS
(status) != 0) {

225 
	`LOG
(
ERROR
è<< 
·th
 << " faed w™h stu " << 
	`WEXITSTATUS
(
¡©us
);

227  
	`WEXITSTATUS
(
¡©us
);

228 
	}
}

230 
	$fÜm©_vŞume
(cÚ¡ * 
vŞume
, cÚ¡ * 
dœeùÜy
) {

231 
VŞume
* 
v
 = 
	`vŞume_fÜ_·th
(
vŞume
);

232 ià(
v
 =ğ
NULL
) {

233 
	`LOG
(
ERROR
è<< "unknowÀvŞum\"" << 
vŞume
 << "\"";

236 ià(
	`¡rcmp
(
v
->
fs_ty³
, "ramdisk") == 0) {

238 
	`LOG
(
ERROR
è<< "ÿn'ˆfÜm©_vŞum\"" << 
vŞume
 << "\"";

241 ià(
	`¡rcmp
(
v
->
mouÁ_pošt
, 
vŞume
) != 0) {

242 
	`LOG
(
ERROR
è<< "ÿn'ˆgiv·th \"" << 
vŞume
 << "\"o format_volume";

246 ià(
	`’su»_·th_unmouÁed
(
vŞume
) != 0) {

247 
	`LOG
(
ERROR
è<< "fÜm©_vŞumçedØunmouÁ \"" << 
v
->
mouÁ_pošt
 << "\"";

251 ià(
	`¡rcmp
(
v
->
fs_ty³
, "ext4") == 0 || strcmp(v->fs_type, "f2fs") == 0) {

254 ià(
v
->
key_loc
 !ğ
NULL
 && v->key_loc[0] == '/') {

255 
	`LOG
(
INFO
è<< "wšg " << 
v
->
key_loc
;

256 
fd
 = 
	`İ’
(
v
->
key_loc
, 
O_WRONLY
 | 
O_CREAT
, 0644);

257 ià(
fd
 < 0) {

258 
	`LOG
(
ERROR
è<< "fÜm©_vŞume: faedØİ’ " << 
v
->
key_loc
;

261 
	`we_block_deviû
(
fd
, 
	`g‘_fe_size
(fd));

262 
	`şo£
(
fd
);

265 
ssize_t
 
Ëngth
 = 0;

266 ià(
v
->
Ëngth
 != 0) {

267 
Ëngth
 = 
v
->length;

268 } ià(
v
->
key_loc
 !ğ
NULL
 && 
	`¡rcmp
(v->key_loc, "footer") == 0) {

269 
Ëngth
 = -
CRYPT_FOOTER_OFFSET
;

271 
»suÉ
;

272 ià(
	`¡rcmp
(
v
->
fs_ty³
, "ext4") == 0) {

273 ià(
v
->
”a£_blk_size
 !ğ0 && v->
logiÿl_blk_size
 != 0) {

274 
»suÉ
 = 
	`make_ext4fs_dœeùÜy_®ign
(
v
->
blk_deviû
, 
Ëngth
, 
vŞume
, 
£hªdË
,

275 
dœeùÜy
, 
v
->
”a£_blk_size
, v->
logiÿl_blk_size
);

277 
»suÉ
 = 
	`make_ext4fs_dœeùÜy
(
v
->
blk_deviû
, 
Ëngth
, 
vŞume
, 
£hªdË
, 
dœeùÜy
);

280 ià(
v
->
key_loc
 !ğ
NULL
 && 
	`¡rcmp
(v->key_loc, "foÙ”"è=ğ0 && 
Ëngth
 < 0) {

281 
	`LOG
(
ERROR
è<< "fÜm©_vŞume: cry± foÙ” +‚eg©ivËngth (" << 
Ëngth


282 << "ènÙ suµÜ‹d oÀ" << 
v
->
fs_ty³
;

285 ià(
Ëngth
 < 0) {

286 
	`LOG
(
ERROR
è<< "fÜm©_vŞume:‚eg©ivËngth (" << 
Ëngth


287 << "ènÙ suµÜ‹d oÀ" << 
v
->
fs_ty³
;

290 *
num_£ùÜs
;

291 ià(
	`a¥rštf
(&
num_£ùÜs
, "%zd", 
Ëngth
 / 512) <= 0) {

292 
	`LOG
(
ERROR
è<< "fÜm©_vŞume: faedØü—‹ " << 
v
->
fs_ty³


293 << " commªd fÜ " << 
v
->
blk_deviû
;

296 cÚ¡ *
f2fs_·th
 = "/sbin/mkfs.f2fs";

297 cÚ¡ * cÚ¡ 
f2fs_¬gv
[] = {"mkfs.f2fs", "-t", "-d1", 
v
->
blk_deviû
, 
num_£ùÜs
, 
NULL
};

299 
»suÉ
 = 
	`exec_cmd
(
f2fs_·th
, (* cÚ¡*)
f2fs_¬gv
);

300 
	`ä“
(
num_£ùÜs
);

302 ià(
»suÉ
 != 0) {

303 
	`PLOG
(
ERROR
è<< "fÜm©_vŞume: mak" << 
v
->
fs_ty³
 << " faed oÀ" << v->
blk_deviû
;

309 
	`LOG
(
ERROR
è<< "fÜm©_vŞume: fs_ty³ \"" << 
v
->
fs_ty³
 << "\" unsupported";

311 
	}
}

313 
	$fÜm©_vŞume
(cÚ¡ * 
vŞume
) {

314  
	`fÜm©_vŞume
(
vŞume
, 
NULL
);

315 
	}
}

317 
	$£tup_š¡®l_mouÁs
() {

318 ià(
f¡ab
 =ğ
NULL
) {

319 
	`LOG
(
ERROR
) << "can't set up install mounts:‚o fstab†oaded";

322 
i
 = 0; i < 
f¡ab
->
num_’Œ›s
; ++i) {

323 
VŞume
* 
v
 = 
f¡ab
->
»cs
 + 
i
;

325 ià(
	`¡rcmp
(
v
->
mouÁ_pošt
, "/tmp") == 0 ||

326 
	`¡rcmp
(
v
->
mouÁ_pošt
, "/cache") == 0 ||

327 
	`¡rcmp
(
v
->
mouÁ_pošt
, "/devlog") == 0) {

328 ià(
	`’su»_·th_mouÁed
(
v
->
mouÁ_pošt
) != 0) {

329 
	`LOG
(
ERROR
è<< "çedØmouÁ " << 
v
->
mouÁ_pošt
;

334 ià(
	`’su»_·th_unmouÁed
(
v
->
mouÁ_pošt
) != 0) {

335 
	`LOG
(
ERROR
è<< "çedØunmouÁ " << 
v
->
mouÁ_pošt
;

341 
	}
}

	@roots.h

17 #iâdeà
RECOVERY_ROOTS_H_


18 
	#RECOVERY_ROOTS_H_


	)

20 
f¡ab_»c
 
	tVŞume
;

23 
lßd_vŞume_bË
();

26 
VŞume
* 
vŞume_fÜ_·th
(cÚ¡ * 
·th
);

30 
’su»_·th_mouÁed
(cÚ¡ * 
·th
);

33 
’su»_·th_mouÁed_©
(cÚ¡ * 
·th
, cÚ¡ * 
mouÁ_pošt
);

37 
’su»_·th_unmouÁed
(cÚ¡ * 
·th
);

42 
fÜm©_vŞume
(cÚ¡ * 
vŞume
);

48 
fÜm©_vŞume
(cÚ¡ * 
vŞume
, cÚ¡ * 
dœeùÜy
);

52 
£tup_š¡®l_mouÁs
();

	@screen_ui.cpp

17 
	~<dœ’t.h
>

18 
	~<”ºo.h
>

19 
	~<fú.h
>

20 
	~<lšux/šput.h
>

21 
	~<±h»ad.h
>

22 
	~<¡d¬g.h
>

23 
	~<¡dio.h
>

24 
	~<¡dlib.h
>

25 
	~<¡ršg.h
>

26 
	~<sys/¡©.h
>

27 
	~<sys/time.h
>

28 
	~<sys/ty³s.h
>

29 
	~<time.h
>

30 
	~<uni¡d.h
>

32 
	~<¡ršg
>

33 
	~<veùÜ
>

35 
	~<ªdroid-ba£/loggšg.h
>

36 
	~<ªdroid-ba£/´İ”t›s.h
>

37 
	~<ªdroid-ba£/¡ršgs.h
>

38 
	~<ªdroid-ba£/¡ršg´štf.h
>

40 
	~"cuts/´İ”t›s.h
"

41 
	~"commÚ.h
"

42 
	~"deviû.h
"

43 
	~"mšui/mšui.h
"

44 
	~"sü“n_ui.h
"

45 
	~"ui.h
"

47 
	#TEXT_INDENT
 4

	)

48 
	gch¬_width
;

49 
	gch¬_height
;

50 
	ghtc_ch¬_width
;

51 
	ghtc_ch¬_height
;

52 
boŞ
 
	gshowWVZFRmes§ge
 = 
çl£
;

55 
	$now
() {

56 
timev®
 
tv
;

57 
	`g‘timeofday
(&
tv
, 
nuÎ±r
);

58  
tv
.
tv_£c
 +v.
tv_u£c
 / 1000000.0;

59 
	}
}

61 
	gSü“nRecov”yUI
::
	$Sü“nRecov”yUI
()

62 : 
	`cu¼’tIcÚ
(
NONE
),

63 
	`´og»ssB¬Ty³
(
EMPTY
),

64 
	`´og»ssScİeS¹
(0),

65 
	`´og»ssScİeSize
(0),

66 
	`´og»ss
(0),

67 
	`·gesId’tiÿl
(
çl£
),

68 
	`‹xt_cŞs_
(0),

69 
	`‹xt_rows_
(0),

70 
	`‹xt_
(
nuÎ±r
),

71 
	`‹xt_cŞ_
(0),

72 
	`‹xt_row_
(0),

73 
	`‹xt_tİ_
(0),

74 
	`show_‹xt
(
çl£
),

75 
	`show_‹xt_ev”
(
çl£
),

76 
	`m’u_
(
nuÎ±r
),

77 
	`show_m’u
(
çl£
),

78 
	`m’u_™ems
(0),

79 
	`m’u_£l
(0),

80 
	`fe_v›w”_‹xt_
(
nuÎ±r
),

81 
	`šŒo_äames
(0),

82 
	`loİ_äames
(0),

83 
	`cu¼’t_äame
(0),

84 
	`šŒo_dÚe
(
çl£
),

85 
	`ªim©iÚ_ås
(30),

86 
	`¡age
(-1),

87 
	`max_¡age
(-1),

88 
	$upd©eMu‹x
(
PTHREAD_MUTEX_INITIALIZER
è{
	}
}

90 
GRSurçû
* 
	gSü“nRecov”yUI
::
	$G‘Cu¼’tF¿me
() {

91 ià(
cu¼’tIcÚ
 =ğ
INSTALLING_UPDATE
 || cu¼’tIcÚ =ğ
ERASING
) {

92  
šŒo_dÚe
 ? 
loİF¿mes
[
cu¼’t_äame
] : 
šŒoF¿mes
[current_frame];

94  
”rÜ_icÚ
;

95 
	}
}

97 
GRSurçû
* 
	gSü“nRecov”yUI
::
	$G‘Cu¼’tText
() {

98 
cu¼’tIcÚ
) {

99 
ERASING
:  
”asšg_‹xt
;

100 
ERROR
:  
”rÜ_‹xt
;

101 
INSTALLING_UPDATE
:  
š¡®lšg_‹xt
;

102 
NO_COMMAND
:  
no_commªd_‹xt
;

103 
NONE
: 
	`abÜt
();

106  
no_commªd_‹xt
;

107 
	}
}

109 
	gSü“nRecov”yUI
::
	$Pix–sFromDp
(
dp
) const {

110  
dp
 * 
d’s™y_
;

111 
	}
}

128 
	eLayout
 { 
	mPORTRAIT
 = 0, 
	mPORTRAIT_LARGE
 = 1, 
	mLANDSCAPE
 = 2, 
	mLANDSCAPE_LARGE
 = 3, 
	mLAYOUT_MAX
 };

129 
	eDim’siÚ
 { 
	mPROGRESS
 = 0, 
	mTEXT
 = 1, 
	mICON
 = 2, 
	mDIMENSION_MAX
 };

130 
cÚ¡ex´
 
	gkLayouts
[
LAYOUT_MAX
][
DIMENSION_MAX
] = {

137 
	gSü“nRecov”yUI
::
	$G‘Anim©iÚBa£lše
() {

138 #iâdeà
HTC_HEP_PROJECT_FLAG


139  
	`G‘TextBa£lše
(è- 
	`Pix–sFromDp
(
kLayouts
[
Ïyout_
][
ICON
]) -

140 
	`gr_g‘_height
(
loİF¿mes
[0]);

142  (
	`gr_fb_height
(è- 
	`gr_g‘_height
(
loİF¿mes
[0])) / 2;

144 
	}
}

146 
	gSü“nRecov”yUI
::
	$G‘TextBa£lše
() {

147 #iâdeà
HTC_HEP_PROJECT_FLAG


148  
	`G‘Prog»ssBa£lše
(è- 
	`Pix–sFromDp
(
kLayouts
[
Ïyout_
][
TEXT
]) -

149 
	`gr_g‘_height
(
š¡®lšg_‹xt
);

153 
	}
}

155 
	gSü“nRecov”yUI
::
	$G‘Prog»ssBa£lše
() {

156 #iâdeà
HTC_HEP_PROJECT_FLAG


157  
	`gr_fb_height
(è- 
	`Pix–sFromDp
(
kLayouts
[
Ïyout_
][
PROGRESS
]) -

158 
	`gr_g‘_height
(
´og»ssB¬Fl
);

160  
	`gr_fb_height
() * 0.75;

162 
	}
}

166 
	gSü“nRecov”yUI
::
	$d¿w_background_locked
() {

167 
·gesId’tiÿl
 = 
çl£
;

168 
	`gr_cŞÜ
(0, 0, 0, 255);

169 
	`gr_ş—r
();

171 ià(
cu¼’tIcÚ
 !ğ
NONE
) {

172 ià(
max_¡age
 != -1) {

173 
¡age_height
 = 
	`gr_g‘_height
(
¡ageM¬k”Em±y
);

174 
¡age_width
 = 
	`gr_g‘_width
(
¡ageM¬k”Em±y
);

175 
x
 = (
	`gr_fb_width
(è- 
max_¡age
 * 
	`gr_g‘_width
(
¡ageM¬k”Em±y
)) / 2;

176 
y
 = 
	`gr_fb_height
(è- 
¡age_height
;

177 
i
 = 0; i < 
max_¡age
; ++i) {

178 
GRSurçû
* 
¡age_surçû
 = (
i
 < 
¡age
è? 
¡ageM¬k”Fl
 : 
¡ageM¬k”Em±y
;

179 
	`gr_bl™
(
¡age_surçû
, 0, 0, 
¡age_width
, 
¡age_height
, 
x
, 
y
);

180 
x
 +ğ
¡age_width
;

183 #ifdeà
VENDOR_VERIZON


184 ià(
cu¼’tIcÚ
 =ğ
INSTALLING_UPDATE
) {

185 
icÚX
 = (
	`gr_fb_width
(è- 
	`gr_g‘_width
(
backgroundIcÚ
[
VERIZON_STRING
])) / 2;

186 
icÚY
 = (
	`gr_fb_height
(è+ 
	`gr_g‘_height
(
loİF¿mes
[0])) / 2;

187 
	`gr_bl™
(
backgroundIcÚ
[
VERIZON_STRING
], 0, 0, 
	`gr_g‘_width
(backgroundIcÚ[VERIZON_STRING]), 
	`gr_g‘_height
(backgroundIcÚ[VERIZON_STRING]), 
icÚX
, 
icÚY
);

191 #iâdeà
HTC_HEP_PROJECT_FLAG


192 
GRSurçû
* 
‹xt_surçû
 = 
	`G‘Cu¼’tText
();

193 
‹xt_x
 = (
	`gr_fb_width
(è- 
	`gr_g‘_width
(
‹xt_surçû
)) / 2;

194 
‹xt_y
 = 
	`G‘TextBa£lše
();

195 
	`gr_cŞÜ
(255, 255, 255, 255);

196 
	`gr_‹xticÚ
(
‹xt_x
, 
‹xt_y
, 
‹xt_surçû
);

199 
	}
}

204 
	gSü“nRecov”yUI
::
	$d¿w_fÜeground_locked
() {

205 ià(
cu¼’tIcÚ
 !ğ
NONE
) {

206 #ià
HTC_HEP_PROJECT_FLAG


207 
¡¬t
 = 0;

208 
š‹rv®
 = 1.2;

209 
’d
 = 0;

210 ià(
cu¼’tIcÚ
 =ğ
INSTALLING_UPDATE
 || cu¼’tIcÚ =ğ
ERASING
) {

211 
GRSurçû
* 
icÚ
 = 
NULL
;

212 iàĞ
	`IsKeyP»s£d
(
KEY_POWER
) ) {

213 
icÚ
 = 
backgroundIcÚ
[
INSTALLING_WARNING
];

214 
¡¬t
 = 
	`now
();

216 
’d
 = 
	`now
();

217 iàĞ(
’d
 - 
¡¬t
è>ğ
š‹rv®
 ) {

218 
icÚ
 = 
	`G‘Cu¼’tF¿me
();

220 
icÚ
 = 
backgroundIcÚ
[
INSTALLING_WARNING
];

223 
	`gr_bl™
(
icÚ
, 0, 0, 
	`gr_g‘_width
(icÚ), 
	`gr_g‘_height
(icÚ), (
	`gr_fb_width
(è- gr_g‘_width(icÚ)è/ 2, 
	`G‘Anim©iÚBa£lše
());

225 
GRSurçû
* 
äame
 = 
	`G‘Cu¼’tF¿me
();

226 
äame_width
 = 
	`gr_g‘_width
(
äame
);

227 
äame_height
 = 
	`gr_g‘_height
(
äame
);

228 
äame_x
 = (
	`gr_fb_width
(è- 
äame_width
) / 2;

229 
äame_y
 = 
	`G‘Anim©iÚBa£lše
();

230 
	`gr_bl™
(
äame
, 0, 0, 
äame_width
, 
äame_height
, 
äame_x
, 
äame_y
);

233 
GRSurçû
* 
äame
 = 
	`G‘Cu¼’tF¿me
();

234 
äame_width
 = 
	`gr_g‘_width
(
äame
);

235 
äame_height
 = 
	`gr_g‘_height
(
äame
);

236 
äame_x
 = (
	`gr_fb_width
(è- 
äame_width
) / 2;

237 
äame_y
 = 
	`G‘Anim©iÚBa£lše
();

238 
	`gr_bl™
(
äame
, 0, 0, 
äame_width
, 
äame_height
, 
äame_x
, 
äame_y
);

242 ià(
´og»ssB¬Ty³
 !ğ
EMPTY
) {

243 
width
 = 
	`gr_g‘_width
(
´og»ssB¬Em±y
);

244 
height
 = 
	`gr_g‘_height
(
´og»ssB¬Em±y
);

246 
´og»ss_x
 = (
	`gr_fb_width
(è- 
width
) / 2;

247 
´og»ss_y
 = 
	`G‘Prog»ssBa£lše
();

250 
	`gr_cŞÜ
(0, 0, 0, 255);

251 
	`gr_fl
(
´og»ss_x
, 
´og»ss_y
, 
width
, 
height
);

253 ià(
´og»ssB¬Ty³
 =ğ
DETERMINATE
) {

254 
p
 = 
´og»ssScİeS¹
 + 
´og»ss
 * 
´og»ssScİeSize
;

255 
pos
 = 
¡©ic_ÿ¡
<>(
p
 * 
width
);

257 ià(
¹l_loÿË_
) {

259 ià(
pos
 > 0) {

260 
	`gr_bl™
(
´og»ssB¬Fl
, 
width
 - 
pos
, 0,…os, 
height
, 
´og»ss_x
 + width -…os,

261 
´og»ss_y
);

263 ià(
pos
 < 
width
 - 1) {

264 
	`gr_bl™
(
´og»ssB¬Em±y
, 0, 0, 
width
 - 
pos
, 
height
, 
´og»ss_x
, 
´og»ss_y
);

268 ià(
pos
 > 0) {

269 
	`gr_bl™
(
´og»ssB¬Fl
, 0, 0, 
pos
, 
height
, 
´og»ss_x
, 
´og»ss_y
);

271 ià(
pos
 < 
width
 - 1) {

272 
	`gr_bl™
(
´og»ssB¬Em±y
, 
pos
, 0, 
width
 -…os, 
height
, 
´og»ss_x
 +…os, 
´og»ss_y
);

277 
	}
}

279 
	gSü“nRecov”yUI
::
	$S‘CŞÜ
(
UIEËm’t
 
e
) {

280 
e
) {

281 
INFO
:

282 
	`gr_cŞÜ
(249, 194, 0, 255);

284 
HEADER
:

285 
	`gr_cŞÜ
(247, 0, 6, 255);

287 
MENU
:

288 
MENU_SEL_BG
:

289 
	`gr_cŞÜ
(0, 106, 157, 255);

291 
MENU_SEL_BG_ACTIVE
:

292 
	`gr_cŞÜ
(0, 156, 100, 255);

294 
MENU_SEL_FG
:

295 
	`gr_cŞÜ
(255, 255, 255, 255);

297 
LOG
:

298 
	`gr_cŞÜ
(196, 196, 196, 255);

300 
TEXT_FILL
:

301 
	`gr_cŞÜ
(0, 0, 0, 160);

304 
	`gr_cŞÜ
(255, 255, 255, 255);

307 
	}
}

309 
	gSü“nRecov”yUI
::
	$D¿wHÜizÚlRuË
(* 
y
) {

310 
	`S‘CŞÜ
(
MENU
);

311 *
y
 += 4;

312 
	`gr_fl
(0, *
y
, 
	`gr_fb_width
(), *y + 2);

313 *
y
 += 4;

314 
	}
}

316 
	gSü“nRecov”yUI
::
	$D¿wTextLše
(
x
, * 
y
, cÚ¡ * 
lše
, 
boŞ
 
bŞd
) const {

317 
	`gr_‹xt
(
	`gr_sys_fÚt
(), 
x
, *
y
, 
lše
, 
bŞd
);

318 *
y
 +ğ
ch¬_height_
 + 4;

319 
	}
}

321 
	gSü“nRecov”yUI
::
	$D¿wTextLšes
(
x
, * 
y
, cÚ¡ * cÚ¡* 
lšes
) const {

322 
size_t
 
i
 = 0; 
lšes
 !ğ
nuÎ±r
 &&†ines[i] !=‚ullptr; ++i) {

323 
	`D¿wTextLše
(
x
, 
y
, 
lšes
[
i
], 
çl£
);

325 
	}
}

327 cÚ¡ * 
	gREGULAR_HELP
[] = {

329 
NULL


332 cÚ¡ * 
	gLONG_PRESS_HELP
[] = {

335 
NULL


340 
	gSü“nRecov”yUI
::
	$d¿w_sü“n_locked
() {

341 ià(!
show_‹xt
) {

342 
	`d¿w_background_locked
();

343 
	`d¿w_fÜeground_locked
();

345 
	`gr_cŞÜ
(0, 0, 0, 255);

346 
	`gr_ş—r
();

347 
y
 = 0 + 
aod_height
;

348 ià(
show_m’u
) {

349 
¡d
::
¡ršg
 
»cov”y_fšg”´št
 =

350 
ªdroid
::
ba£
::
	`G‘Prİ”ty
("ro.bootimage.build.fingerprint", "");

352 
	`S‘CŞÜ
(
INFO
);

353 
	`D¿wTextLše
(
TEXT_INDENT
, &
y
, "Android Recov”y", 
Œue
);

354 auto& 
chunk
 : 
ªdroid
::
ba£
::
	`S¶™
(
»cov”y_fšg”´št
, ":")) {

355 
	`D¿wTextLše
(
TEXT_INDENT
, &
y
, 
chunk
.
	`c_¡r
(), 
çl£
);

357 
	`D¿wTextLšes
(
TEXT_INDENT
, &
y
, 
	`HasTh»eBu‰Ús
(è? 
REGULAR_HELP
 : 
LONG_PRESS_HELP
);

359 
	`S‘CŞÜ
(
HEADER
);

360 
	`D¿wTextLšes
(
TEXT_INDENT
, &
y
, 
m’u_h—d”s_
);

362 
	`S‘CŞÜ
(
MENU
);

363 
	`D¿wHÜizÚlRuË
(&
y
);

364 
y
 += 4;

365 
i
 = 0; i < 
m’u_™ems
; ++i) {

366 ià(
i
 =ğ
m’u_£l
) {

368 
	`S‘CŞÜ
(
	`IsLÚgP»ss
(è? 
MENU_SEL_BG_ACTIVE
 : 
MENU_SEL_BG
);

369 
	`gr_fl
(0, 
y
 - 2, 
	`gr_fb_width
(), y + 
ch¬_height_
 + 2);

371 
	`S‘CŞÜ
(
MENU_SEL_FG
);

372 
	`gr_‹xt
(
	`gr_sys_fÚt
(), 4, 
y
, 
m’u_
[
i
], 
Œue
);

373 
	`S‘CŞÜ
(
MENU
);

375 
	`gr_‹xt
(
	`gr_sys_fÚt
(), 4, 
y
, 
m’u_
[
i
], 
çl£
);

377 
y
 +ğ
ch¬_height_
 + 4;

379 
	`D¿wHÜizÚlRuË
(&
y
);

381 ià(
showWVZFRmes§ge
) {

382 
	`S‘CŞÜ
(
HEADER
);

383 
	`D¿wTextLše
(
TEXT_INDENT
, &
y
, "Iàyou¸phÚi »£t, you'Î", 
Œue
);

384 
	`D¿wTextLše
(
TEXT_INDENT
, &
y
, "ÃedØ’‹¸thGoogË‡ccouÁ", 
Œue
);

385 
	`D¿wTextLše
(
TEXT_INDENT
, &
y
, "šfÜm©iÚ (ema‡dd»s ªd", 
Œue
);

386 
	`D¿wTextLše
(
TEXT_INDENT
, &
y
, "·sswÜdèassocŸ‹d w™hhis", 
Œue
);

387 
	`D¿wTextLše
(
TEXT_INDENT
, &
y
, "phÚtØbabËØu£ it", 
Œue
);

388 
	`D¿wTextLše
(
TEXT_INDENT
, &
y
, "agaš.", 
Œue
);

394 
	`S‘CŞÜ
(
LOG
);

395 
row
 = (
‹xt_tİ_
 + 
‹xt_rows_
 - 1) %ext_rows_;

396 
size_t
 
couÁ
 = 0;

397 
ty
 = 
	`gr_fb_height
(è- 
ch¬_height_
;

398 
ty
 >ğ
y
 && 
couÁ
 < 
‹xt_rows_
;

399 
ty
 -ğ
ch¬_height_
, ++
couÁ
) {

400 
	`gr_‹xt
(
	`gr_sys_fÚt
(), 0, 
ty
, 
‹xt_
[
row
], 
çl£
);

401 --
row
;

402 ià(
row
 < 0èrow = 
‹xt_rows_
 - 1;

405 
	}
}

409 
	gSü“nRecov”yUI
::
	$upd©e_sü“n_locked
() {

410 
	`d¿w_sü“n_locked
();

411 
	`gr_æ
();

412 
	}
}

416 
	gSü“nRecov”yUI
::
	$upd©e_´og»ss_locked
() {

417 ià(
show_‹xt
 || !
·gesId’tiÿl
) {

418 
	`d¿w_sü“n_locked
();

419 
·gesId’tiÿl
 = 
Œue
;

421 
	`d¿w_fÜeground_locked
();

422 
	`show_³rûÁage
();

424 
	`gr_æ
();

425 
	}
}

427 
	gSü“nRecov”yUI
::
	$show_³rûÁage
()

429 ià(
´og»ssB¬Ty³
 =ğ
DETERMINATE
) {

430 #ifdeà
HTC_HEP_PROJECT_FLAG


432 
icÚHeight
 = 0;

435 
icÚHeight
 = 
	`gr_g‘_height
(
loİF¿mes
[0]);

437 
width
 = 
	`gr_g‘_width
(
´og»ssB¬Em±y
);

438 
height
 = 
	`gr_g‘_height
(
´og»ssB¬Em±y
);

439 
p
 = 
´og»ssScİeS¹
 + 
´og»ss
 * 
´og»ssScİeSize
;

441 
³rûÁage
[5] = {0};

442 
	`¢´štf
(
³rûÁage
, Õ”ûÁage), "%d%%", ()(
p
*100));

443 
dx
 = (
	`gr_fb_width
(è- (
	`¡¾’
(
³rûÁage
)*
htc_ch¬_width
))/2;

444 
dy
 = (3*
	`gr_fb_height
(è+ 
icÚHeight
 - 2*
height
)/4;

445 
	`gr_cŞÜ
(0, 0, 0, 255);

446 
	`gr_fl
(
dx
, 
dy
+(
htc_ch¬_height
*3/2), dx+(
htc_ch¬_width
*4), (dy+(htc_char_height*3/2))+htc_char_height);

447 
	`S‘CŞÜ
(
MENU_SEL_FG
);

448 
	`htc_gr_‹xt
(
dx
, 
dy
+(
htc_ch¬_height
*3/2), 
³rûÁage
, 1);

450 
	}
}

453 * 
	gSü“nRecov”yUI
::
	$Prog»ssTh»adS¹Routše
(* 
d©a
) {

454 
»š‹½»t_ÿ¡
<
Sü“nRecov”yUI
*>(
d©a
)->
	`Prog»ssTh»adLoİ
();

455  
nuÎ±r
;

456 
	}
}

458 
	gSü“nRecov”yUI
::
	$Prog»ssTh»adLoİ
() {

459 
š‹rv®
 = 1.0 / 
ªim©iÚ_ås
;

460 
Œue
) {

461 
¡¬t
 = 
	`now
();

462 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

464 
boŞ
 
»d¿w
 = 
çl£
;

468 ià((
cu¼’tIcÚ
 =ğ
INSTALLING_UPDATE
 || cu¼’tIcÚ =ğ
ERASING
è&& !
show_‹xt
) {

469 ià(!
šŒo_dÚe
) {

470 ià(
cu¼’t_äame
 =ğ
šŒo_äames
 - 1) {

471 
šŒo_dÚe
 = 
Œue
;

472 
cu¼’t_äame
 = 0;

474 ++
cu¼’t_äame
;

477 
cu¼’t_äame
 = (cu¼’t_äam+ 1è% 
loİ_äames
;

480 
»d¿w
 = 
Œue
;

484 
du¿tiÚ
 = 
´og»ssScİeDu¿tiÚ
;

485 ià(
´og»ssB¬Ty³
 =ğ
DETERMINATE
 && 
du¿tiÚ
 > 0) {

486 
–­£d
 = 
	`now
(è- 
´og»ssScİeTime
;

487 
p
 = 1.0 * 
–­£d
 / 
du¿tiÚ
;

488 ià(
p
 > 1.0)… = 1.0;

489 ià(
p
 > 
´og»ss
) {

490 
´og»ss
 = 
p
;

491 
»d¿w
 = 
Œue
;

495 ià(
»d¿w
è
	`upd©e_´og»ss_locked
();

497 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

498 
’d
 = 
	`now
();

500 
d–ay
 = 
š‹rv®
 - (
’d
-
¡¬t
);

501 ià(
d–ay
 < 0.02) delay = 0.02;

502 
	`u¦“p
(
¡©ic_ÿ¡
<
u£cÚds_t
>(
d–ay
 * 1000000));

504 
	}
}

506 
	gSü“nRecov”yUI
::
	$LßdB™m­
(cÚ¡ * 
f’ame
, 
GRSurçû
** 
surçû
) {

507 
»suÉ
 = 
	`»s_ü—‹_di¥Ïy_surçû
(
f’ame
, 
surçû
);

508 ià(
»suÉ
 < 0) {

509 
	`LOG
(
ERROR
è<< "couldn'ˆlßd b™m­ " << 
f’ame
 << " (”rÜ " << 
»suÉ
 << ")";

511 
	}
}

513 
	gSü“nRecov”yUI
::
	$LßdLoÿlizedB™m­
(cÚ¡ * 
f’ame
, 
GRSurçû
** 
surçû
) {

514 
»suÉ
 = 
	`»s_ü—‹_loÿlized_®pha_surçû
(
f’ame
, 
loÿË_
.
	`c_¡r
(), 
surçû
);

515 ià(
»suÉ
 < 0) {

516 
	`LOG
(
ERROR
è<< "couldn'ˆlßd b™m­ " << 
f’ame
 << " (”rÜ " << 
»suÉ
 << ")";

518 
	}
}

520 ** 
	$AÎoc2d
(
size_t
 
rows
, size_ˆ
cŞs
) {

521 ** 
»suÉ
 = 
Ãw
 *[
rows
];

522 
size_t
 
i
 = 0; i < 
rows
; ++i) {

523 
»suÉ
[
i
] = 
Ãw
 [
cŞs
];

524 
	`mem£t
(
»suÉ
[
i
], 0, 
cŞs
);

526  
»suÉ
;

527 
	}
}

530 
	gSü“nRecov”yUI
::
	$S‘Sy¡emUpd©eText
(
boŞ
 
£cur™y_upd©e
) {

531 ià(
£cur™y_upd©e
) {

532 
	`LßdLoÿlizedB™m­
("š¡®lšg_£cur™y_‹xt", &
š¡®lšg_‹xt
);

534 
	`LßdLoÿlizedB™m­
("š¡®lšg_‹xt", &
š¡®lšg_‹xt
);

536 
	`Red¿w
();

537 
	}
}

539 
boŞ
 
	gSü“nRecov”yUI
::
	$In™TextP¬ams
() {

540 ià(
	`gr_š™
() < 0) {

541  
çl£
;

544 
	`gr_fÚt_size
(
	`gr_sys_fÚt
(), &
ch¬_width_
, &
ch¬_height_
);

545 
	`htc_gr_fÚt_size
(&
htc_ch¬_width
, &
htc_ch¬_height
);

546 
‹xt_rows_
 = 
	`gr_fb_height
(è/ 
ch¬_height_
;

547 
‹xt_cŞs_
 = 
	`gr_fb_width
(è/ 
ch¬_width_
;

548  
Œue
;

549 
	}
}

551 
boŞ
 
	gSü“nRecov”yUI
::
	$In™
(cÚ¡ 
¡d
::
¡ršg
& 
loÿË
) {

552 
Recov”yUI
::
	`In™
(
loÿË
);

553 ià(!
	`In™TextP¬ams
()) {

554  
çl£
;

557 
d’s™y_
 = 
¡©ic_ÿ¡
<>(
ªdroid
::
ba£
::
	`G‘IÁPrİ”ty
("ro.sf.lcd_density", 160)) / 160.f;

560 
Ïyout_
 = (
	`gr_fb_width
(è> 
	`gr_fb_height
()è? 
LANDSCAPE
 : 
PORTRAIT
;

562 ià(
	`gr_fb_height
(è> 
	`Pix–sFromDp
(800)è++
Ïyout_
;

564 
‹xt_
 = 
	`AÎoc2d
(
‹xt_rows_
, 
‹xt_cŞs_
 + 1);

565 
fe_v›w”_‹xt_
 = 
	`AÎoc2d
(
‹xt_rows_
, 
‹xt_cŞs_
 + 1);

566 
m’u_
 = 
	`AÎoc2d
(
‹xt_rows_
, 
‹xt_cŞs_
 + 1);

568 
‹xt_cŞ_
 = 
‹xt_row_
 = 0;

569 
‹xt_tİ_
 = 1;

571 
	`LßdB™m­
("icÚ_”rÜ", &
”rÜ_icÚ
);

573 
	`LßdB™m­
("¡age_em±y", &
¡ageM¬k”Em±y
);

574 
	`LßdB™m­
("¡age_fl", &
¡ageM¬k”Fl
);

579 
š¡®lšg_‹xt
 = 
nuÎ±r
;

580 
	`LßdLoÿlizedB™m­
("”asšg_‹xt", &
”asšg_‹xt
);

581 
	`LßdLoÿlizedB™m­
("no_commªd_‹xt", &
no_commªd_‹xt
);

582 
	`LßdLoÿlizedB™m­
("”rÜ_‹xt", &
”rÜ_‹xt
);

584 #ià
HTC_HEP_PROJECT_FLAG


585 
	`LßdB™m­
("icÚ_š¡®l_cÜru±",&
backgroundIcÚ
[
NO_COMMAND
]);

586 
	`LßdB™m­
("fÙa_icÚ_š¡®lšg_w¬nšg",&
backgroundIcÚ
[
INSTALLING_WARNING
]);

588 
	`LßdB™m­
("šd‘”mš©e1", &
´og»ssB¬Ind‘”mš©e
[0]);

589 
	`LßdB™m­
("šd‘”mš©e2", &
´og»ssB¬Ind‘”mš©e
[1]);

590 
	`LßdB™m­
("šd‘”mš©e3", &
´og»ssB¬Ind‘”mš©e
[2]);

591 
	`LßdB™m­
("šd‘”mš©e4", &
´og»ssB¬Ind‘”mš©e
[3]);

592 
	`LßdB™m­
("šd‘”mš©e5", &
´og»ssB¬Ind‘”mš©e
[4]);

593 
	`LßdB™m­
("šd‘”mš©e6", &
´og»ssB¬Ind‘”mš©e
[5]);

595 
backgroundIcÚ
[
NONE
] = 
nuÎ±r
;

596 
	`LßdB™m­
("icÚ_”rÜ", &
backgroundIcÚ
[
ERROR
]);

597 #ifdeà
VENDOR_VERIZON


598 
	`LßdB™m­
("v”izÚ_¡ršg", &
backgroundIcÚ
[
VERIZON_STRING
]);

600 
	`LßdB™m­
("´og»ss_b¬_em±y", &
´og»ssB¬Em±y
);

601 
	`LßdB™m­
("´og»ss_b¬_fl", &
´og»ssB¬Fl
);

603 
	`LßdB™m­
("´og»ss_em±y", &
´og»ssB¬Em±y
);

604 
	`LßdB™m­
("´og»ss_fl", &
´og»ssB¬Fl
);

607 
	`LßdAnim©iÚ
();

609 
	`±h»ad_ü—‹
(&
´og»ss_th»ad_
, 
nuÎ±r
, 
Prog»ssTh»adS¹Routše
, 
this
);

611 
FILE
 *
pFe
;

612 
bufãr
[1024];

613 
	`mem£t
(
bufãr
,0,1024);

614 
aod_height
 = 0;

615 
pFe
 = 
	`fİ’
( "/sys/class/graphics/fb0/msm_fb_panel_info", "r" );

616 iàĞ
NULL
 !ğ
pFe
 ){

617 
	`fsÿnf
(
pFe
, "%1023s", 
bufãr
è!ğ
EOF
){

618 if(
	`¡ºcmp
(
bufãr
, "aod_height", 10) == 0){

619 
aod_height
 = 
	`©oi
(
bufãr
 + 11);

620 
aod_height
 = (aod_heighˆ> 0 &&‡od_heighˆ<ğ
	`gr_fb_height
()) ?‡od_height : 0;

623 
	`fşo£
(
pFe
);

626  
Œue
;

627 
	}
}

629 
	gSü“nRecov”yUI
::
	$LßdAnim©iÚ
() {

630 
¡d
::
unique_±r
<
DIR
, 
	`deşty³
(&
şo£dœ
)> 
	`dœ
(
	`İ’dœ
("/res/images"), closedir);

631 
dœ’t
* 
de
;

632 
¡d
::
veùÜ
<¡d::
¡ršg
> 
šŒo_äame_Çmes
;

633 
¡d
::
veùÜ
<¡d::
¡ršg
> 
loİ_äame_Çmes
;

635 (
de
 = 
	`»addœ
(
dœ
.
	`g‘
())è!ğ
nuÎ±r
) {

636 
v®ue
, 
num_ch¬s
;

637 ià(
	`ssÿnf
(
de
->
d_Çme
, "šŒo%d%n.²g", &
v®ue
, &
num_ch¬s
) == 1) {

638 
šŒo_äame_Çmes
.
	`em¶aû_back
(
de
->
d_Çme
, 
num_ch¬s
);

639 } ià(
	`ssÿnf
(
de
->
d_Çme
, "loİ%d%n.²g", &
v®ue
, &
num_ch¬s
) == 1) {

640 
loİ_äame_Çmes
.
	`em¶aû_back
(
de
->
d_Çme
, 
num_ch¬s
);

644 
šŒo_äames
 = 
šŒo_äame_Çmes
.
	`size
();

645 
loİ_äames
 = 
loİ_äame_Çmes
.
	`size
();

648 ià(
šŒo_äames
 =ğ0è
šŒo_dÚe
 = 
Œue
;

650 ià(
loİ_äames
 =ğ0è
	`abÜt
();

652 
¡d
::
	`sÜt
(
šŒo_äame_Çmes
.
	`begš
(), iÁro_äame_Çmes.
	`’d
());

653 
¡d
::
	`sÜt
(
loİ_äame_Çmes
.
	`begš
(),†oİ_äame_Çmes.
	`’d
());

655 
šŒoF¿mes
 = 
Ãw
 
GRSurçû
*[
šŒo_äames
];

656 
size_t
 
i
 = 0; i < 
šŒo_äames
; i++) {

657 
	`LßdB™m­
(
šŒo_äame_Çmes
.
	`©
(
i
).
	`c_¡r
(), &
šŒoF¿mes
[i]);

660 
loİF¿mes
 = 
Ãw
 
GRSurçû
*[
loİ_äames
];

661 
size_t
 
i
 = 0; i < 
loİ_äames
; i++) {

662 
	`LßdB™m­
(
loİ_äame_Çmes
.
	`©
(
i
).
	`c_¡r
(), &
loİF¿mes
[i]);

664 
	}
}

666 
	gSü“nRecov”yUI
::
	$S‘Background
(
IcÚ
 
icÚ
) {

667 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

669 
cu¼’tIcÚ
 = 
icÚ
;

670 
	`upd©e_sü“n_locked
();

672 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

673 
	}
}

675 
	gSü“nRecov”yUI
::
	$S‘Prog»ssTy³
(
Prog»ssTy³
 
ty³
) {

676 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

677 ià(
´og»ssB¬Ty³
 !ğ
ty³
) {

678 
´og»ssB¬Ty³
 = 
ty³
;

680 
´og»ssScİeS¹
 = 0;

681 
´og»ssScİeSize
 = 0;

682 
´og»ss
 = 0;

683 
	`upd©e_´og»ss_locked
();

684 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

685 
	}
}

687 
	gSü“nRecov”yUI
::
	$ShowProg»ss
(
pÜtiÚ
, 
£cÚds
) {

688 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

689 
´og»ssB¬Ty³
 = 
DETERMINATE
;

690 
´og»ssScİeS¹
 +ğ
´og»ssScİeSize
;

691 
´og»ssScİeSize
 = 
pÜtiÚ
;

692 
´og»ssScİeTime
 = 
	`now
();

693 
´og»ssScİeDu¿tiÚ
 = 
£cÚds
;

694 
´og»ss
 = 0;

695 
	`upd©e_´og»ss_locked
();

696 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

697 
	}
}

699 
	gSü“nRecov”yUI
::
	$S‘Prog»ss
(
äaùiÚ
) {

700 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

701 ià(
äaùiÚ
 < 0.0) fraction = 0.0;

702 ià(
äaùiÚ
 > 1.0) fraction = 1.0;

704 ià(
´og»ssB¬Ty³
 =ğ
DETERMINATE
 && 
äaùiÚ
 > 
´og»ss
) {

706 
width
 = 
	`gr_g‘_width
(
´og»ssB¬Em±y
);

707 
sÿË
 = 
width
 * 
´og»ssScİeSize
;

708 ià((è(
´og»ss
 * 
sÿË
è!ğ(è(
äaùiÚ
 * scale)) {

709 
´og»ss
 = 
äaùiÚ
;

710 
	`upd©e_´og»ss_locked
();

713 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

714 
	}
}

716 
	gSü“nRecov”yUI
::
	$S‘Sge
(
cu¼’t
, 
max
) {

717 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

718 
¡age
 = 
cu¼’t
;

719 
max_¡age
 = 
max
;

720 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

721 
	}
}

723 
	gSü“nRecov”yUI
::
	$PrštV
(cÚ¡ * 
fmt
, 
boŞ
 
cİy_to_¡dout
, 
va_li¡
 
­
) {

724 
¡d
::
¡ršg
 
¡r
;

725 
ªdroid
::
ba£
::
	`SŒšgAµ’dV
(&
¡r
, 
fmt
, 
­
);

727 ià(
cİy_to_¡dout
) {

728 
	`åuts
(
¡r
.
	`c_¡r
(), 
¡dout
);

731 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

732 ià(
‹xt_rows_
 > 0 && 
‹xt_cŞs_
 > 0) {

733 cÚ¡ * 
±r
 = 
¡r
.
	`c_¡r
(); *ptr != '\0'; ++ptr) {

734 ià(*
±r
 =ğ'\n' || 
‹xt_cŞ_
 >ğ
‹xt_cŞs_
) {

735 
‹xt_
[
‹xt_row_
][
‹xt_cŞ_
] = '\0';

736 
‹xt_cŞ_
 = 0;

737 
‹xt_row_
 = (‹xt_row_ + 1è% 
‹xt_rows_
;

738 ià(
‹xt_row_
 =ğ
‹xt_tİ_
è‹xt_tİ_ = (‹xt_tİ_ + 1è% 
‹xt_rows_
;

740 ià(*
±r
 !ğ'\n'è
‹xt_
[
‹xt_row_
][
‹xt_cŞ_
++] = *ptr;

742 
‹xt_
[
‹xt_row_
][
‹xt_cŞ_
] = '\0';

743 
	`upd©e_sü“n_locked
();

745 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

746 
	}
}

748 
	gSü“nRecov”yUI
::
	$Pršt
(cÚ¡ * 
fmt
, ...) {

749 
va_li¡
 
­
;

750 
	`va_¡¬t
(
­
, 
fmt
);

751 
	`PrštV
(
fmt
, 
Œue
, 
­
);

752 
	`va_’d
(
­
);

753 
	}
}

755 
	gSü“nRecov”yUI
::
	$PrštOnSü“nOÆy
(cÚ¡ *
fmt
, ...) {

756 
va_li¡
 
­
;

757 
	`va_¡¬t
(
­
, 
fmt
);

758 
	`PrštV
(
fmt
, 
çl£
, 
­
);

759 
	`va_’d
(
­
);

760 
	}
}

762 
	gSü“nRecov”yUI
::
	$PutCh¬
(
ch
) {

763 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

764 ià(
ch
 !ğ'\n'è
‹xt_
[
‹xt_row_
][
‹xt_cŞ_
++] = ch;

765 ià(
ch
 =ğ'\n' || 
‹xt_cŞ_
 >ğ
‹xt_cŞs_
) {

766 
‹xt_cŞ_
 = 0;

767 ++
‹xt_row_
;

769 ià(
‹xt_row_
 =ğ
‹xt_tİ_
è‹xt_tİ_ = (‹xt_tİ_ + 1è% 
‹xt_rows_
;

771 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

772 
	}
}

774 
	gSü“nRecov”yUI
::
	$CË¬Text
() {

775 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

776 
‹xt_cŞ_
 = 0;

777 
‹xt_row_
 = 0;

778 
‹xt_tİ_
 = 1;

779 
size_t
 
i
 = 0; i < 
‹xt_rows_
; ++i) {

780 
	`mem£t
(
‹xt_
[
i
], 0, 
‹xt_cŞs_
 + 1);

782 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

783 
	}
}

785 
	gSü“nRecov”yUI
::
	$ShowFe
(
FILE
* 
å
) {

786 
¡d
::
veùÜ
<
off_t
> 
off£ts
;

787 
off£ts
.
	`push_back
(
	`á–lo
(
å
));

788 
	`CË¬Text
();

790 
¡©
 
sb
;

791 
	`f¡©
(
	`f’o
(
å
), &
sb
);

793 
boŞ
 
show_´om±
 = 
çl£
;

794 
Œue
) {

795 ià(
show_´om±
) {

796 
	`PrštOnSü“nOÆy
("--(%d%% of %d bytes)--",

797 
¡©ic_ÿ¡
<>(100 * ((
	`á–lo
(
å
)è/ (
sb
.
¡_size
))),

798 
¡©ic_ÿ¡
<>(
sb
.
¡_size
));

799 
	`Red¿w
();

800 
show_´om±
) {

801 
show_´om±
 = 
çl£
;

802 
key
 = 
	`Wa™Key
();

803 ià(
key
 =ğ
KEY_POWER
 || key =ğ
KEY_ENTER
) {

805 } ià(
key
 =ğ
KEY_UP
 || key =ğ
KEY_VOLUMEUP
) {

806 ià(
off£ts
.
	`size
() <= 1) {

807 
show_´om±
 = 
Œue
;

809 
off£ts
.
	`pİ_back
();

810 
	`f£ek
(
å
, 
off£ts
.
	`back
(), 
SEEK_SET
);

813 ià(
	`ãof
(
å
)) {

816 
off£ts
.
	`push_back
(
	`á–lo
(
å
));

819 
	`CË¬Text
();

822 
ch
 = 
	`g‘c
(
å
);

823 ià(
ch
 =ğ
EOF
) {

824 
‹xt_row_
 < 
‹xt_rows_
 - 1è
	`PutCh¬
('\n');

825 
show_´om±
 = 
Œue
;

827 
	`PutCh¬
(
ch
);

828 ià(
‹xt_cŞ_
 =ğ0 && 
‹xt_row_
 >ğ
‹xt_rows_
 - 1) {

829 
show_´om±
 = 
Œue
;

833 
	}
}

837 
	gSü“nRecov”yUI
::
	$ShowFe
(cÚ¡ * 
f’ame
) {

838 
FILE
* 
å
 = 
	`fİ’_·th
(
f’ame
, "re");

839 ià(
å
 =ğ
nuÎ±r
) {

840 
	`Pršt
(" UÇbËØİ’ %s: %s\n", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

844 ** 
Şd_‹xt
 = 
‹xt_
;

845 
size_t
 
Şd_‹xt_cŞ
 = 
‹xt_cŞ_
;

846 
size_t
 
Şd_‹xt_row
 = 
‹xt_row_
;

847 
size_t
 
Şd_‹xt_tİ
 = 
‹xt_tİ_
;

850 
‹xt_
 = 
fe_v›w”_‹xt_
;

851 
	`CË¬Text
();

853 
	`ShowFe
(
å
);

854 
	`fşo£
(
å
);

856 
‹xt_
 = 
Şd_‹xt
;

857 
‹xt_cŞ_
 = 
Şd_‹xt_cŞ
;

858 
‹xt_row_
 = 
Şd_‹xt_row
;

859 
‹xt_tİ_
 = 
Şd_‹xt_tİ
;

860 
	}
}

863 
	gSü“nRecov”yUI
::
	$S¹M’u
(cÚ¡ * cÚ¡ * 
h—d”s
, cÚ¡ * cÚ¡ * 
™ems
,

864 
š™Ÿl_£ËùiÚ
) {

865 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

866 ià(
‹xt_rows_
 > 0 && 
‹xt_cŞs_
 > 0) {

867 
m’u_h—d”s_
 = 
h—d”s
;

868 
size_t
 
i
 = 0;

869 ; 
i
 < 
‹xt_rows_
 && 
™ems
[i] !ğ
nuÎ±r
; ++i) {

870 
	`¡ºıy
(
m’u_
[
i
], 
™ems
[i], 
‹xt_cŞs_
 - 1);

871 
m’u_
[
i
][
‹xt_cŞs_
 - 1] = '\0';

873 
m’u_™ems
 = 
i
;

874 
show_m’u
 = 
Œue
;

875 
m’u_£l
 = 
š™Ÿl_£ËùiÚ
;

876 
	`upd©e_sü“n_locked
();

878 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

879 
	}
}

881 
	gSü“nRecov”yUI
::
	$S–eùM’u
(
£l
) {

882 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

883 ià(
show_m’u
) {

884 
Şd_£l
 = 
m’u_£l
;

885 
m’u_£l
 = 
£l
;

888 ià(
m’u_£l
 < 0èm’u_£Èğ
m’u_™ems
 - 1;

889 ià(
m’u_£l
 >ğ
m’u_™ems
) menu_sel = 0;

891 
£l
 = 
m’u_£l
;

892 
äp
[
PROPERTY_VALUE_MAX
] = {0};

893 
	`´İ”ty_g‘
("ro.äp.p¡", 
äp
, "");

897 ià(
£l
+1 =ğ
Deviû
::
WIPE_DATA
 && 
	`¡¾’
(
äp
) != 0) {

898 
showWVZFRmes§ge
 = 
Œue
;

900 
showWVZFRmes§ge
 = 
çl£
;

902 ià(
m’u_£l
 !ğ
Şd_£l
è
	`upd©e_sü“n_locked
();

904 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

905  
£l
;

906 
	}
}

908 
	gSü“nRecov”yUI
::
	$EndM’u
() {

909 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

910 ià(
show_m’u
 && 
‹xt_rows_
 > 0 && 
‹xt_cŞs_
 > 0) {

911 
show_m’u
 = 
çl£
;

912 
	`upd©e_sü“n_locked
();

914 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

915 
	}
}

917 
boŞ
 
	gSü“nRecov”yUI
::
	$IsTextVisibË
() {

918 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

919 
visibË
 = 
show_‹xt
;

920 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

921  
visibË
;

922 
	}
}

924 
boŞ
 
	gSü“nRecov”yUI
::
	$WasTextEv”VisibË
() {

925 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

926 
ev”_visibË
 = 
show_‹xt_ev”
;

927 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

928  
ev”_visibË
;

929 
	}
}

931 
	gSü“nRecov”yUI
::
	$ShowText
(
boŞ
 
visibË
) {

932 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

933 
show_‹xt
 = 
visibË
;

934 ià(
show_‹xt
è
show_‹xt_ev”
 = 
Œue
;

935 
	`upd©e_sü“n_locked
();

936 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

937 
	}
}

939 
	gSü“nRecov”yUI
::
	$Red¿w
() {

940 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

941 
	`upd©e_sü“n_locked
();

942 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

943 
	}
}

948 
	$cÚv”t_ARGB8888_to_RGB565
(*
¤c
, *
d¡
, 
LCD_XRES
, 
LCD_YRES
, 
Fixed_LCD_XRES
) {

949 
x
,
y
;

950 
‹mpv®ue
;

951 
a
,
r
,
g
,
b
;

952 
fix_size
 = 
Fixed_LCD_XRES
 - 
LCD_XRES
;

954 
y
 = 0 ; y < 
LCD_YRES
 ; y++) {

955 
x
 = 0 ; x < 
LCD_XRES
 ; x++) {

956 
‹mpv®ue
 = *
¤c
;

957 
a
 = (
‹mpv®ue
 & 0xff000000)>>24;

958 
r
 = (
‹mpv®ue
 & 0x00ff0000)>>16;

959 
g
 = (
‹mpv®ue
 & 0x0000ff00)>>8;

960 
b
 = (
‹mpv®ue
 & 0x000000ff)>>0;

961 *
d¡
 = ((
b
>>3)<<11è| (((
g
>>3)<<1)<<5è| (
r
>>3);

963 
¤c
++;

964 
d¡
++;

967 
¤c
 +ğ
fix_size
;

969 
	}
}

971 
	$cİy_ªd_adju¡_image
 (*
¤c
, *
d¡
, 
LCD_XRES
, 
LCD_YRES
, 
Fixed_LCD_XRES
) {

972 
x
, 
y
;

973 
fix_size
 = 
Fixed_LCD_XRES
 - 
LCD_XRES
;

974 
y
 = 0 ; y < 
LCD_YRES
 ; y++) {

975 
x
 = 0 ; x < 
LCD_XRES
 ; x++) {

976 *
d¡
 = *
¤c
;

977 
¤c
++;

978 
d¡
++;

981 
¤c
 +ğ
fix_size
;

983 
	}
}

985 * 
	gSü“nRecov”yUI
::
	$DumpF¿mebufãr
 (
IcÚ
 
icÚ
, *
width
, *
height
, *
bµ
) {

986 
size
, 
rsize
;

987 
rwidth
, 
rheight
, 
rby‹µ
;

988 *
bufãr
, *
rbufãr
;

990 
	`±h»ad_mu‹x_lock
(&
upd©eMu‹x
);

991 
	`d¿w_background_locked
();

994 
rwidth
 = 
	`gr_fb_width_modif›d
();

995 
rheight
 = 
	`gr_fb_height
();

996 
rby‹µ
 = 
	`gr_fb_pix–
();

999 *
width
 = 
	`gr_fb_width_Üigš®
();

1000 *
height
 = 
	`gr_fb_height
();

1001 *
bµ
 = 16;

1003 ià(
	`gr_fb_pix–
() == 4) {

1005 
rsize
 = 
rwidth
 * 
rheight
 * 
rby‹µ
;

1006 
size
 = 
rsize
 / 2;

1007 
rbufãr
 = (*)
	`m®loc
(
rsize
);

1008 
bufãr
 = (*)
	`m®loc
(
size
);

1009 ià(
rbufãr
 =ğ
NULL
 || 
bufãr
 == NULL) {

1010 
	`LOG
(
ERROR
è<< "Cª'ˆ®loÿ‹ " << 
size
 << " bytes for image";

1011 ià(
rbufãr
 !ğ
NULL
è
	`ä“
(rbuffer);

1012 ià(
bufãr
 !ğ
NULL
è
	`ä“
(buffer);

1014 
	`memıy
(
rbufãr
, 
	`gr_fb_d©a
(), 
rsize
);

1015 
	`cÚv”t_ARGB8888_to_RGB565
((*)
rbufãr
, (*)
bufãr
, *
width
, *
height
, 
rwidth
);

1016 
	`ä“
(
rbufãr
);

1020 
rsize
 = 
rwidth
 * 
rheight
 * 
rby‹µ
;

1021 
size
 = (*
width
è* (*
height
è* (*
bµ
 / 8);

1022 
rbufãr
 = (*)
	`m®loc
(
rsize
);

1023 
bufãr
 = (*)
	`m®loc
(
size
);

1024 ià(
rbufãr
 =ğ
NULL
 || 
bufãr
 == NULL) {

1025 
	`LOG
(
ERROR
è<< "Cª'ˆ®loÿ‹ " << 
size
 << " bytes for image";

1026 ià(
rbufãr
 !ğ
NULL
è
	`ä“
(rbuffer);

1027 ià(
bufãr
 !ğ
NULL
è
	`ä“
(buffer);

1029 ià(
rsize
 =ğ
size
) {

1030 
	`memıy
(
bufãr
, 
	`gr_fb_d©a
(), 
size
);

1032 
	`memıy
(
rbufãr
, 
	`gr_fb_d©a
(), 
rsize
);

1033 
	`cİy_ªd_adju¡_image
((*)
rbufãr
, (*)
bufãr
, *
width
, *
height
, 
rwidth
);

1035 
	`ä“
(
rbufãr
);

1039 
	`±h»ad_mu‹x_uÆock
(&
upd©eMu‹x
);

1040  
bufãr
;

1041 
	}
}

1043 
	gSü“nRecov”yUI
::
	$KeyLÚgP»ss
() {

1046 
	`Red¿w
();

1047 
	}
}

	@screen_ui.h

17 #iâdeà
RECOVERY_SCREEN_UI_H


18 
	#RECOVERY_SCREEN_UI_H


	)

20 
	~<±h»ad.h
>

21 
	~<¡dio.h
>

23 
	~<¡ršg
>

25 
	~"ui.h
"

28 
	gGRSurçû
;

32 şas 
	cSü“nRecov”yUI
 : 
public
 
Recov”yUI
 {

33 
public
:

34 
Sü“nRecov”yUI
();

36 
boŞ
 
	$In™
(cÚ¡ 
¡d
::
¡ršg
& 
loÿË
è
ov”ride
;

39 
	`S‘Background
(
IcÚ
 
icÚ
);

40 
	`S‘Sy¡emUpd©eText
(
boŞ
 
£cur™y_upd©e
);

43 
	$S‘Prog»ssTy³
(
Prog»ssTy³
 
ty³
è
ov”ride
;

44 
	$ShowProg»ss
(
pÜtiÚ
, 
£cÚds
è
ov”ride
;

45 
	$S‘Prog»ss
(
äaùiÚ
è
ov”ride
;

47 
	$S‘Sge
(
cu¼’t
, 
max
è
ov”ride
;

50 
	$ShowText
(
boŞ
 
visibË
è
ov”ride
;

51 
boŞ
 
	$IsTextVisibË
(è
ov”ride
;

52 
boŞ
 
	$WasTextEv”VisibË
(è
ov”ride
;

55 
	$Pršt
(cÚ¡ * 
fmt
, ...è
	`__´štæike
(2, 3);

56 
	$PrštOnSü“nOÆy
(cÚ¡ * 
fmt
, ...è
	`__´štæike
(2, 3);

60 
	`S¹M’u
(cÚ¡ * cÚ¡ * 
h—d”s
, cÚ¡ * cÚ¡ * 
™ems
,

61 
š™Ÿl_£ËùiÚ
);

62 
	`S–eùM’u
(
£l
);

63 
	`EndM’u
();

65 
	`KeyLÚgP»ss
();

67 
	`Red¿w
();

69 
	`D¿wHÜizÚlRuË
(* 
y
);

72 
vœtu®
 * 
	`DumpF¿mebufãr
(
IcÚ
 
icÚ
, *
width
, *
height
, *
bµ
);

74 
	eUIEËm’t
 {

75 
HEADER
, 
MENU
, 
MENU_SEL_BG
, 
MENU_SEL_BG_ACTIVE
, 
MENU_SEL_FG
, 
LOG
, 
TEXT_FILL
, 
INFO


77 
	`S‘CŞÜ
(
UIEËm’t
 
e
);

79 
´Ùeùed
:

80 
IcÚ
 
cu¼’tIcÚ
;

83 
d’s™y_
;

85 
Ïyout_
;

87 
GRSurçû
* 
”rÜ_icÚ
;

89 
GRSurçû
* 
”asšg_‹xt
;

90 
GRSurçû
* 
”rÜ_‹xt
;

91 
GRSurçû
* 
š¡®lšg_‹xt
;

92 
GRSurçû
* 
no_commªd_‹xt
;

94 
GRSurçû
** 
šŒoF¿mes
;

95 
GRSurçû
** 
loİF¿mes
;

97 
GRSurçû
* 
´og»ssB¬Em±y
 = 
nuÎ±r
;

98 
GRSurçû
* 
´og»ssB¬Fl
 = 
nuÎ±r
;

99 
GRSurçû
* 
¡ageM¬k”Em±y
 = 
nuÎ±r
;

100 
GRSurçû
* 
¡ageM¬k”Fl
 = 
nuÎ±r
;

101 #ifdeà
HTC_HEP_PROJECT_FLAG


102 
GRSurçû
* 
backgroundIcÚ
[
ICON_NUM
];

103 
GRSurçû
* 
´og»ssB¬Ind‘”mš©e
[
PROGRESSBAR_STATES
];

104 
GRSurçû
** 
š¡®ÏtiÚ
;

107 
Prog»ssTy³
 
´og»ssB¬Ty³
;

109 
´og»ssScİeS¹
, 
´og»ssScİeSize
, 
´og»ss
;

110 
´og»ssScİeTime
, 
´og»ssScİeDu¿tiÚ
;

113 
boŞ
 
·gesId’tiÿl
;

115 
size_t
 
‹xt_cŞs_
, 
‹xt_rows_
;

118 ** 
‹xt_
;

119 
size_t
 
‹xt_cŞ_
, 
‹xt_row_
, 
‹xt_tİ_
;

121 
boŞ
 
show_‹xt
;

122 
boŞ
 
show_‹xt_ev”
;

124 ** 
m’u_
;

125 cÚ¡ * cÚ¡* 
m’u_h—d”s_
;

126 
boŞ
 
show_m’u
;

127 
m’u_™ems
, 
m’u_£l
;

130 ** 
fe_v›w”_‹xt_
;

132 
±h»ad_t
 
´og»ss_th»ad_
;

135 
size_t
 
šŒo_äames
;

136 
size_t
 
loİ_äames
;

138 
size_t
 
cu¼’t_äame
;

139 
boŞ
 
šŒo_dÚe
;

142 
ªim©iÚ_ås
;

144 
¡age
, 
max_¡age
;

146 
ch¬_width_
;

147 
ch¬_height_
;

148 
±h»ad_mu‹x_t
 
upd©eMu‹x
;

150 
vœtu®
 
boŞ
 
	`In™TextP¬ams
();

152 
vœtu®
 
	`d¿w_background_locked
();

153 
vœtu®
 
	`d¿w_fÜeground_locked
();

154 
vœtu®
 
	`d¿w_sü“n_locked
();

155 
vœtu®
 
	`upd©e_sü“n_locked
();

156 
vœtu®
 
	`upd©e_´og»ss_locked
();

157 
	`show_³rûÁage
();

158 
aod_height
;

160 
GRSurçû
* 
	`G‘Cu¼’tF¿me
();

161 
GRSurçû
* 
	`G‘Cu¼’tText
();

163 * 
	`Prog»ssTh»adS¹Routše
(* 
d©a
);

164 
	`Prog»ssTh»adLoİ
();

167 
vœtu®
 
	`PrštV
(cÚ¡ *, 
boŞ
, 
va_li¡
);

168 
	`PutCh¬
();

169 
	`CË¬Text
();

171 
	`LßdAnim©iÚ
();

172 
	`LßdB™m­
(cÚ¡ * 
f’ame
, 
GRSurçû
** 
surçû
);

173 
	`LßdLoÿlizedB™m­
(cÚ¡ * 
f’ame
, 
GRSurçû
** 
surçû
);

175 
	$Pix–sFromDp
(
dp
) const;

176 
vœtu®
 
	`G‘Anim©iÚBa£lše
();

177 
vœtu®
 
	`G‘Prog»ssBa£lše
();

178 
vœtu®
 
	`G‘TextBa£lše
();

180 
	$D¿wTextLše
(
x
, * 
y
, cÚ¡ * 
lše
, 
boŞ
 
bŞd
) const;

181 
	$D¿wTextLšes
(
x
, * 
y
, cÚ¡ * cÚ¡* 
lšes
) const;

182 
	}
};

	@ui.cpp

17 
	~"ui.h
"

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<lšux/šput.h
>

22 
	~<±h»ad.h
>

23 
	~<¡d¬g.h
>

24 
	~<¡dio.h
>

25 
	~<¡dlib.h
>

26 
	~<¡ršg.h
>

27 
	~<sys/¡©.h
>

28 
	~<sys/time.h
>

29 
	~<sys/ty³s.h
>

30 
	~<time.h
>

31 
	~<uni¡d.h
>

33 
	~<funùiÚ®
>

34 
	~<¡ršg
>

36 
	~<ªdroid-ba£/fe.h
>

37 
	~<ªdroid-ba£/loggšg.h
>

38 
	~<ªdroid-ba£/·r£št.h
>

39 
	~<ªdroid-ba£/´İ”t›s.h
>

40 
	~<ªdroid-ba£/¡ršgs.h
>

41 
	~<cuts/ªdroid_»boÙ.h
>

42 
	~<mšui/mšui.h
>

44 
	~"commÚ.h
"

45 
	~"roÙs.h
"

46 
	~"deviû.h
"

48 
cÚ¡ex´
 
	gUI_WAIT_KEY_TIMEOUT_SEC
 = 120;

49 
cÚ¡ex´
 cÚ¡ * 
	gBRIGHTNESS_FILE
 = "/sys/class/leds/lcd-backlight/brightness";

50 
cÚ¡ex´
 cÚ¡ * 
	gMAX_BRIGHTNESS_FILE
 = "/sys/class/leds/lcd-backlight/max_brightness";

52 
	gRecov”yUI
::
	$Recov”yUI
()

53 : 
	`loÿË_
(""),

54 
	`¹l_loÿË_
(
çl£
),

55 
	`brighŠess_nÜm®_
(50),

56 
	`brighŠess_dimmed_
(25),

57 
	`key_queue_Ën
(0),

58 
	`key_Ï¡_down
(-1),

59 
	`key_lÚg_´ess
(
çl£
),

60 
	`key_down_couÁ
(0),

61 
	`’abË_»boÙ
(
Œue
),

62 
	`’abË_toggË
(
Œue
),

63 
	`cÚ£cutive_pow”_keys
(0),

64 
	`Ï¡_key
(-1),

65 
	`has_pow”_key
(
çl£
),

66 
	`has_up_key
(
çl£
),

67 
	`has_down_key
(
çl£
),

68 
	$sü“n§v”_¡©e_
(
Sü“n§v”S‹
::
DISABLED
) {

69 
	`±h»ad_mu‹x_š™
(&
key_queue_mu‹x
, 
nuÎ±r
);

70 
	`±h»ad_cÚd_š™
(&
key_queue_cÚd
, 
nuÎ±r
);

71 
	`mem£t
(
key_´es£d
, 0, (key_pressed));

72 
	}
}

74 
	gRecov”yUI
::
	$OnKeyD‘eùed
(
key_code
) {

75 ià(
key_code
 =ğ
KEY_POWER
) {

76 
has_pow”_key
 = 
Œue
;

77 } ià(
key_code
 =ğ
KEY_DOWN
 || key_cod=ğ
KEY_VOLUMEDOWN
) {

78 
has_down_key
 = 
Œue
;

79 } ià(
key_code
 =ğ
KEY_UP
 || key_cod=ğ
KEY_VOLUMEUP
) {

80 
has_up_key
 = 
Œue
;

82 
	}
}

85 * 
	$IÅutTh»adLoİ
(*) {

86 
Œue
) {

87 ià(!
	`ev_wa™
(-1)) {

88 
	`ev_di¥©ch
();

91  
nuÎ±r
;

92 
	}
}

94 
boŞ
 
	gRecov”yUI
::
	$In™Sü“n§v”
() {

96 ià(
brighŠess_nÜm®_
 =ğ0 || 
brighŠess_dimmed_
 > brightness_normal_) {

97  
çl£
;

103 
¡d
::
¡ršg
 
cÚ‹Á
;

104 ià(!
ªdroid
::
ba£
::
	`R—dFeToSŒšg
(
MAX_BRIGHTNESS_FILE
, &
cÚ‹Á
)) {

105 
	`PLOG
(
WARNING
) << "Failedo„ead max brightness";

106  
çl£
;

109 
max_v®ue
;

110 ià(!
ªdroid
::
ba£
::
	`P¬£Ušt
×ndroid::ba£::
	`Trim
(
cÚ‹Á
), &
max_v®ue
)) {

111 
	`LOG
(
WARNING
è<< "FaedØ·r£ max brighŠess: " << 
cÚ‹Á
;

112  
çl£
;

115 
brighŠess_nÜm®_v®ue_
 = 
max_v®ue
 * 
brighŠess_nÜm®_
 / 100.0;

116 
brighŠess_dimmed_v®ue_
 = 
max_v®ue
 * 
brighŠess_dimmed_
 / 100.0;

117 ià(!
ªdroid
::
ba£
::
	`Wr™eSŒšgToFe
(
¡d
::
	`to_¡ršg
(
brighŠess_nÜm®_v®ue_
),

118 
BRIGHTNESS_FILE
)) {

119 
	`PLOG
(
WARNING
) << "Failedo set brightness";

120  
çl£
;

123 
	`LOG
(
INFO
è<< "BrighŠess: " << 
brighŠess_nÜm®_v®ue_
 << " (" << 
brighŠess_nÜm®_
 << "%)";

124 
sü“n§v”_¡©e_
 = 
Sü“n§v”S‹
::
NORMAL
;

125  
Œue
;

126 
	}
}

128 
boŞ
 
	gRecov”yUI
::
	$In™
(cÚ¡ 
¡d
::
¡ršg
& 
loÿË
) {

130 
	`S‘LoÿË
(
loÿË
);

132 
	`ev_š™
(
¡d
::
	`bšd
(&
Recov”yUI
::
OnIÅutEv’t
, 
this
, std::
¶aûhŞd”s
::
_1
, std::¶aûhŞd”s::
_2
));

134 
	`ev_™”©e_avaabË_keys
(
¡d
::
	`bšd
(&
Recov”yUI
::
OnKeyD‘eùed
, 
this
, std::
¶aûhŞd”s
::
_1
));

136 ià(!
	`In™Sü“n§v”
()) {

137 
	`LOG
(
INFO
) << "Screensaver disabled";

138 
	`´štf
("Screensaver disabled\n");

140 
	`´štf
("Screensaverƒnabled\n");

143 
	`±h»ad_ü—‹
(&
šput_th»ad_
, 
nuÎ±r
, 
IÅutTh»adLoİ
,‚ullptr);

144  
Œue
;

145 
	}
}

147 
	gRecov”yUI
::
	$OnIÅutEv’t
(
fd
, 
ušt32_t
 
•ev’ts
) {

148 
šput_ev’t
 
ev
;

149 ià(
	`ev_g‘_šput
(
fd
, 
•ev’ts
, &
ev
) == -1) {

153 ià(
ev
.
ty³
 =ğ
EV_SYN
) {

155 } ià(
ev
.
ty³
 =ğ
EV_REL
) {

156 ià(
ev
.
code
 =ğ
REL_Y
) {

161 
»l_sum
 +ğ
ev
.
v®ue
;

162 ià(
»l_sum
 > 3) {

163 
	`ProûssKey
(
KEY_DOWN
, 1);

164 
	`ProûssKey
(
KEY_DOWN
, 0);

165 
»l_sum
 = 0;

166 } ià(
»l_sum
 < -3) {

167 
	`ProûssKey
(
KEY_UP
, 1);

168 
	`ProûssKey
(
KEY_UP
, 0);

169 
»l_sum
 = 0;

173 
»l_sum
 = 0;

176 ià(
ev
.
ty³
 =ğ
EV_KEY
 &&ƒv.
code
 <ğ
KEY_MAX
) {

177 
	`ProûssKey
(
ev
.
code
,ƒv.
v®ue
);

181 
	}
}

195 
	gRecov”yUI
::
	$ProûssKey
(
key_code
, 
updown
) {

196 
boŞ
 
»gi¡”_key
 = 
çl£
;

197 
boŞ
 
lÚg_´ess
 = 
çl£
;

198 
boŞ
 
»boÙ_’abËd
;

200 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

201 
key_´es£d
[
key_code
] = 
updown
;

202 ià(
updown
) {

203 ++
key_down_couÁ
;

204 
key_Ï¡_down
 = 
key_code
;

205 
key_lÚg_´ess
 = 
çl£
;

206 
key_tim”_t
* 
šfo
 = 
Ãw
 key_timer_t;

207 
šfo
->
ui
 = 
this
;

208 
šfo
->
key_code
 = key_code;

209 
šfo
->
couÁ
 = 
key_down_couÁ
;

210 
±h»ad_t
 
th»ad
;

211 
	`±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, &
Recov”yUI
::
time_key_h–³r
, 
šfo
);

212 
	`±h»ad_d‘ach
(
th»ad
);

214 ià(
key_Ï¡_down
 =ğ
key_code
) {

215 
lÚg_´ess
 = 
key_lÚg_´ess
;

216 
»gi¡”_key
 = 
Œue
;

218 
key_Ï¡_down
 = -1;

220 
»boÙ_’abËd
 = 
’abË_»boÙ
;

221 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

223 ià(
»gi¡”_key
) {

224 
	`CheckKey
(
key_code
, 
lÚg_´ess
)) {

225 
Recov”yUI
::
IGNORE
:

228 
Recov”yUI
::
TOGGLE
:

229 ià(
’abË_toggË
 =ğ
çl£
) {

232 
	`ShowText
(!
	`IsTextVisibË
());

235 
Recov”yUI
::
REBOOT
:

236 ià(
»boÙ_’abËd
) {

239 
Œue
è{ 
	`·u£
(); }

243 
Recov”yUI
::
ENQUEUE
:

244 
	`EnqueueKey
(
key_code
);

248 
	}
}

250 * 
	gRecov”yUI
::
	$time_key_h–³r
(* 
cook›
) {

251 
key_tim”_t
* 
šfo
 = 
¡©ic_ÿ¡
<key_tim”_t*>(
cook›
);

252 
šfo
->
ui
->
	`time_key
(šfo->
key_code
, info->
couÁ
);

253 
d–‘e
 
šfo
;

254  
nuÎ±r
;

255 
	}
}

257 
	gRecov”yUI
::
	$time_key
(
key_code
, 
couÁ
) {

258 
	`u¦“p
(750000);

259 
boŞ
 
lÚg_´ess
 = 
çl£
;

260 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

261 ià(
key_Ï¡_down
 =ğ
key_code
 && 
key_down_couÁ
 =ğ
couÁ
) {

262 
lÚg_´ess
 = 
key_lÚg_´ess
 = 
Œue
;

264 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

265 ià(
lÚg_´ess
è
	`KeyLÚgP»ss
(
key_code
);

266 
	}
}

268 
	gRecov”yUI
::
	$EnqueueKey
(
key_code
) {

269 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

270 cÚ¡ 
queue_max
 = (
key_queue
) / (key_queue[0]);

271 ià(
key_queue_Ën
 < 
queue_max
) {

272 
key_queue
[
key_queue_Ën
++] = 
key_code
;

273 
	`±h»ad_cÚd_sigÇl
(&
key_queue_cÚd
);

275 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

276 
	}
}

278 
	gRecov”yUI
::
	$Wa™Key
() {

279 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

284 
timev®
 
now
;

285 
time¥ec
 
timeout
;

286 
	`g‘timeofday
(&
now
, 
nuÎ±r
);

287 
timeout
.
tv_£c
 = 
now
.tv_sec;

288 
timeout
.
tv_n£c
 = 
now
.
tv_u£c
 * 1000;

289 
timeout
.
tv_£c
 +ğ
UI_WAIT_KEY_TIMEOUT_SEC
;

291 
rc
 = 0;

292 
key_queue_Ën
 =ğ0 && 
rc
 !ğ
ETIMEDOUT
) {

293 
rc
 = 
	`±h»ad_cÚd_timedwa™
(&
key_queue_cÚd
, &
key_queue_mu‹x
, &
timeout
);

296 ià(
sü“n§v”_¡©e_
 !ğ
Sü“n§v”S‹
::
DISABLED
) {

297 ià(
rc
 =ğ
ETIMEDOUT
) {

299 ià(
sü“n§v”_¡©e_
 =ğ
Sü“n§v”S‹
::
NORMAL
) {

300 ià(
ªdroid
::
ba£
::
	`Wr™eSŒšgToFe
(
¡d
::
	`to_¡ršg
(
brighŠess_dimmed_v®ue_
),

301 
BRIGHTNESS_FILE
)) {

302 
	`LOG
(
INFO
è<< "BrighŠess: " << 
brighŠess_dimmed_v®ue_
 << " (" << 
brighŠess_dimmed_


304 
sü“n§v”_¡©e_
 = 
Sü“n§v”S‹
::
DIMMED
;

306 } ià(
sü“n§v”_¡©e_
 =ğ
Sü“n§v”S‹
::
DIMMED
) {

307 ià(
ªdroid
::
ba£
::
	`Wr™eSŒšgToFe
("0", 
BRIGHTNESS_FILE
)) {

308 
	`LOG
(
INFO
) << "Brightness: 0 (off)";

309 
sü“n§v”_¡©e_
 = 
Sü“n§v”S‹
::
OFF
;

312 } ià(
sü“n§v”_¡©e_
 !ğ
Sü“n§v”S‹
::
NORMAL
) {

314 ià(
sü“n§v”_¡©e_
 =ğ
Sü“n§v”S‹
::
OFF
) {

315 ià(
key_queue_Ën
 > 0) {

316 
	`memıy
(&
key_queue
[0], &key_queue[1], (è* --
key_queue_Ën
);

321 ià(
ªdroid
::
ba£
::
	`Wr™eSŒšgToFe
(
¡d
::
	`to_¡ršg
(
brighŠess_nÜm®_v®ue_
),

322 
BRIGHTNESS_FILE
)) {

323 
sü“n§v”_¡©e_
 = 
Sü“n§v”S‹
::
NORMAL
;

324 
	`LOG
(
INFO
è<< "BrighŠess: " << 
brighŠess_nÜm®_v®ue_
 << " (" << 
brighŠess_nÜm®_


329 } 
	`IsUsbCÚÃùed
(è&& 
key_queue_Ën
 == 0);

331 
key
 = -1;

332 ià(
key_queue_Ën
 > 0) {

333 
key
 = 
key_queue
[0];

334 
	`memıy
(&
key_queue
[0], &key_queue[1], (è* --
key_queue_Ën
);

336 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

337  
key
;

338 
	}
}

340 
boŞ
 
	gRecov”yUI
::
	$IsUsbCÚÃùed
() {

341 
fd
 = 
	`İ’
("/sys/şass/ªdroid_usb/ªdroid0/¡©e", 
O_RDONLY
);

342 ià(
fd
 < 0) {

343 
	`´štf
("failedo open /sys/class/android_usb/android0/state: %s\n",

344 
	`¡»¼Ü
(
”ºo
));

348 
buf
;

350 
cÚÃùed
 = (
	`TEMP_FAILURE_RETRY
(
	`»ad
(
fd
, &
buf
, 1)) == 1) && (buf == 'C');

351 ià(
	`şo£
(
fd
) < 0) {

352 
	`´štf
("failedo close /sys/class/android_usb/android0/state: %s\n",

353 
	`¡»¼Ü
(
”ºo
));

355  
cÚÃùed
;

356 
	}
}

358 
boŞ
 
	gRecov”yUI
::
	$IsKeyP»s£d
(
key
) {

359 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

360 
´es£d
 = 
key_´es£d
[
key
];

361 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

362  
´es£d
;

363 
	}
}

365 
boŞ
 
	gRecov”yUI
::
	$IsLÚgP»ss
() {

366 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

367 
boŞ
 
»suÉ
 = 
key_lÚg_´ess
;

368 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

369  
»suÉ
;

370 
	}
}

372 
boŞ
 
	gRecov”yUI
::
	$HasTh»eBu‰Ús
() {

373  
has_pow”_key
 && 
has_up_key
 && 
has_down_key
;

374 
	}
}

376 
	gRecov”yUI
::
	$FlushKeys
() {

377 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

378 
key_queue_Ën
 = 0;

379 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

380 
	}
}

382 
	gRecov”yUI
::
KeyAùiÚ
 
Recov”yUI
::
	$CheckKey
(
key
, 
boŞ
 
is_lÚg_´ess
) {

383 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

384 
key_lÚg_´ess
 = 
çl£
;

385 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

388 ià(
	`HasTh»eBu‰Ús
()) {

389 ià(
key
 =ğ
KEY_VOLUMEUP
 && 
	`IsKeyP»s£d
(
KEY_POWER
)) {

390  
TOGGLE
;

395 ià(
is_lÚg_´ess
 && !
	`IsTextVisibË
()) {

396  
TOGGLE
;

400 ià(
is_lÚg_´ess
 && 
	`IsTextVisibË
()) {

401 
	`EnqueueKey
(
KEY_ENTER
);

402  
IGNORE
;

407 ià(
key
 =ğ
KEY_POWER
) {

408 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

409 
boŞ
 
»boÙ_’abËd
 = 
’abË_»boÙ
;

410 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

412 ià(
»boÙ_’abËd
) {

413 ++
cÚ£cutive_pow”_keys
;

414 ià(
cÚ£cutive_pow”_keys
 >= 7) {

415  
REBOOT
;

419 
cÚ£cutive_pow”_keys
 = 0;

422 
Ï¡_key
 = 
key
;

423  (
	`IsTextVisibË
(è|| 
sü“n§v”_¡©e_
 =ğ
Sü“n§v”S‹
::
OFF
è? 
ENQUEUE
 : 
IGNORE
;

424 
	}
}

426 
	gRecov”yUI
::
	$KeyLÚgP»ss
() {

427 
	}
}

429 
Recov”yUI
::
	$S‘EÇbËReboÙ
(
boŞ
 
’abËd
) {

430 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

431 
’abË_»boÙ
 = 
’abËd
;

432 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

433 
	}
}

435 
	gRecov”yUI
::
	$S‘LoÿË
(cÚ¡ 
¡d
::
¡ršg
& 
Ãw_loÿË
) {

436 
this
->
loÿË_
 = 
Ãw_loÿË
;

437 
this
->
¹l_loÿË_
 = 
çl£
;

439 ià(!
Ãw_loÿË
.
	`em±y
()) {

440 
size_t
 
und”scÜe
 = 
Ãw_loÿË
.
	`fšd
('_');

442 
¡d
::
¡ršg
 
Ïng
 = 
Ãw_loÿË
.
	`sub¡r
(0, 
und”scÜe
);

445 ià(
Ïng
 == "ar" ||

446 
Ïng
 == "fa" ||

447 
Ïng
 == "he" ||

448 
Ïng
 == "iw" ||

449 
Ïng
 == "ur") {

450 
¹l_loÿË_
 = 
Œue
;

453 
	}
}

455 
	gRecov”yUI
::
	$S‘EÇbËToggË
(
boŞ
 
’abËd
) {

456 
	`±h»ad_mu‹x_lock
(&
key_queue_mu‹x
);

457 
’abË_toggË
 = 
’abËd
;

458 
	`±h»ad_mu‹x_uÆock
(&
key_queue_mu‹x
);

459 
	}
}

	@ui.h

17 #iâdeà
RECOVERY_UI_H


18 
	#RECOVERY_UI_H


	)

20 
	~<lšux/šput.h
>

21 
	~<±h»ad.h
>

22 
	~<time.h
>

24 
	~<¡ršg
>

27 şas 
	cRecov”yUI
 {

28 
	mpublic
:

29 
Recov”yUI
();

31 
	mvœtu®
 ~
	$Recov”yUI
() { }

35 
vœtu®
 
boŞ
 
	`In™
(cÚ¡ 
¡d
::
¡ršg
& 
loÿË
);

38 
vœtu®
 
	`S‘Sge
(
cu¼’t
, 
max
) = 0;

41 #ifdeà
HTC_HEP_PROJECT_FLAG


42 
	eIcÚ
 { 
NONE
, 
INSTALLING_UPDATE
, 
ERASING
, 
NO_COMMAND
, 
ERROR
, 
FACTORYRESET
, 
FIRMWARE_INSTALLING
, 
INSTALLING_WARNING
, 
VERIZON_STRING
, 
ICON_NUM
 
	}
};

44 
	eIcÚ
 { 
	gNONE
, 
	gINSTALLING_UPDATE
, 
	gERASING
, 
	gNO_COMMAND
, 
	gERROR
, 
	gICON_NUM
 };

46 
vœtu®
 
S‘Background
(
IcÚ
 
icÚ
) = 0;

47 
vœtu®
 
S‘Sy¡emUpd©eText
(
boŞ
 
£cur™y_upd©e
) = 0;

49 #ifdeà
HTC_HEP_PROJECT_FLAG


51 cÚ¡ 
	gPROGRESSBAR_STATES
 = 6;

55 
	eProg»ssTy³
 { 
	gEMPTY
, 
	gINDETERMINATE
, 
	gDETERMINATE
 };

56 
vœtu®
 
S‘Prog»ssTy³
(
Prog»ssTy³
 
d‘”mš©e
) = 0;

61 
vœtu®
 
ShowProg»ss
(
pÜtiÚ
, 
£cÚds
) = 0;

65 
vœtu®
 
S‘Prog»ss
(
äaùiÚ
) = 0;

69 
vœtu®
 
ShowText
(
boŞ
 
visibË
) = 0;

71 
vœtu®
 
boŞ
 
IsTextVisibË
() = 0;

73 
vœtu®
 
boŞ
 
WasTextEv”VisibË
() = 0;

78 
vœtu®
 
	$Pršt
(cÚ¡ * 
fmt
, ...è
	`__´štæike
(2, 3) = 0;

79 
vœtu®
 
	$PrštOnSü“nOÆy
(cÚ¡ * 
fmt
, ...è
	`__´štæike
(2, 3) = 0;

86 
vœtu®
 
	`Wa™Key
();

88 
vœtu®
 
boŞ
 
	`IsKeyP»s£d
(
key
);

89 
vœtu®
 
boŞ
 
	`IsLÚgP»ss
();

93 
vœtu®
 
boŞ
 
	`HasTh»eBu‰Ús
();

96 
vœtu®
 
	`FlushKeys
();

102 
	eKeyAùiÚ
 { 
ENQUEUE
, 
TOGGLE
, 
REBOOT
, 
IGNORE
 
	}
};

103 
vœtu®
 
KeyAùiÚ
 
CheckKey
(
key
, 
boŞ
 
is_lÚg_´ess
);

110 
vœtu®
 
KeyLÚgP»ss
(
key
);

117 
vœtu®
 
S‘EÇbËReboÙ
(
boŞ
 
’abËd
);

124 
vœtu®
 
S¹M’u
(cÚ¡ * cÚ¡ * 
h—d”s
, cÚ¡ * cÚ¡ * 
™ems
,

125 
š™Ÿl_£ËùiÚ
) = 0;

129 
vœtu®
 
S–eùM’u
(
£l
) = 0;

133 
vœtu®
 
EndM’u
() = 0;

136 
vœtu®
 * 
	$DumpF¿mebufãr
(
IcÚ
 
icÚ
, *
width
, *
height
, *
bµ
è{  
NULL
; 
	}
};

138 
vœtu®
 
S‘EÇbËToggË
(
boŞ
 
’abËd
);

140 
	g´Ùeùed
:

141 
EnqueueKey
(
key_code
);

144 
	g¡d
::
¡ršg
 
loÿË_
;

145 
boŞ
 
	g¹l_loÿË_
;

151 
	gbrighŠess_nÜm®_
;

152 
	gbrighŠess_dimmed_
;

154 
	g´iv©e
:

156 
±h»ad_mu‹x_t
 
key_queue_mu‹x
;

157 
±h»ad_cÚd_t
 
	gkey_queue_cÚd
;

158 
	gkey_queue
[256], 
	gkey_queue_Ën
;

159 
	gkey_´es£d
[
KEY_MAX
 + 1];

160 
	gkey_Ï¡_down
;

161 
boŞ
 
	gkey_lÚg_´ess
;

162 
	gkey_down_couÁ
;

163 
boŞ
 
	g’abË_»boÙ
;

164 
boŞ
 
	g’abË_toggË
;

165 
	g»l_sum
;

167 
	gcÚ£cutive_pow”_keys
;

168 
	gÏ¡_key
;

170 
boŞ
 
	ghas_pow”_key
;

171 
boŞ
 
	ghas_up_key
;

172 
boŞ
 
	ghas_down_key
;

174 
	skey_tim”_t
 {

175 
Recov”yUI
* 
	gui
;

176 
	gkey_code
;

177 
	gcouÁ
;

180 
±h»ad_t
 
	gšput_th»ad_
;

182 
OnKeyD‘eùed
(
key_code
);

183 
OnIÅutEv’t
(
fd
, 
ušt32_t
 
•ev’ts
);

184 
ProûssKey
(
key_code
, 
updown
);

186 
boŞ
 
IsUsbCÚÃùed
();

188 * 
time_key_h–³r
(* 
cook›
);

189 
time_key
(
key_code
, 
couÁ
);

191 
S‘LoÿË
(cÚ¡ 
¡d
::
¡ršg
&);

193 şas 
	cSü“n§v”S‹
 { 
	gDISABLED
, 
	gNORMAL
, 
	gDIMMED
, 
	gOFF
 };

194 
Sü“n§v”S‹
 
	gsü“n§v”_¡©e_
;

197 
	gbrighŠess_nÜm®_v®ue_
;

198 
	gbrighŠess_dimmed_v®ue_
;

199 
boŞ
 
In™Sü“n§v”
();

	@
1
.
0
45
815
common.h
default_device.cpp
device.cpp
device.h
error_code.h
minadbd/fuse_adb_provider.cpp
minadbd/fuse_adb_provider.h
minadbd/fuse_adb_provider_test.cpp
minadbd/minadbd.cpp
minadbd/minadbd.h
minadbd/minadbd_services.cpp
minui/events.cpp
minui/font_10x18.h
minui/graphics.cpp
minui/graphics.h
minui/graphics_adf.cpp
minui/graphics_adf.h
minui/graphics_drm.cpp
minui/graphics_drm.h
minui/graphics_fbdev.cpp
minui/graphics_fbdev.h
minui/include/minui/minui.h
minui/mkfont.c
minui/resources.cpp
mounts.cpp
mounts.h
mtdutils/emmcutils.c
mtdutils/emmcutils.h
mtdutils/encdevice.c
mtdutils/encdevice.h
mtdutils/flash_image.c
mtdutils/mounts.c
mtdutils/mounts.h
mtdutils/mtdutils.c
mtdutils/mtdutils.h
mtdutils/sdutils.c
mtdutils/sdutils.h
print_sha1.h
recovery.cpp
roots.cpp
roots.h
screen_ui.cpp
screen_ui.h
ui.cpp
ui.h
